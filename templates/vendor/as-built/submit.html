{% extends "layouts/vendor.html" %}

{% block title %}Submit As-Built{% endblock %}

{% block content %}
<div class="space-y-6">
    {% set proj = project.project %}
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Submit As-Built Route</h1>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Provide the final installed route after field completion. This will be sent for review.
                </p>
            </div>
            <div class="grid grid-cols-1 gap-2 text-sm sm:grid-cols-2">
                <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
                    <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Project</div>
                    <div class="font-semibold text-slate-900 dark:text-slate-100">
                        {{ (proj.code or proj.number or proj.name) if proj else (project.project_id|string|truncate(8, True, '')) }}
                    </div>
                </div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
                    <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Project Status</div>
                    <div class="font-semibold text-slate-900 dark:text-slate-100">{{ project.status.value if project.status else 'Unknown' }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="grid gap-6 lg:grid-cols-2">
            <div class="space-y-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">1. Provide Route Geometry</h2>
                    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                        Upload a GeoJSON file or paste GeoJSON containing a <code class="text-emerald-600 dark:text-emerald-400">LineString</code>.
                    </p>
                </div>

                <div class="rounded-lg border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Upload GeoJSON File</label>
                    <input id="asbuilt-file" type="file" accept=".json,.geojson,application/json"
                           class="mt-2 block w-full rounded-lg border border-slate-300 bg-white p-2 text-sm text-slate-700 file:mr-3 file:rounded-md file:border-0 file:bg-slate-100 file:px-3 file:py-1.5 file:text-sm file:font-semibold file:text-slate-700 hover:file:bg-slate-200 dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200 dark:file:bg-slate-700 dark:file:text-slate-100">
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Accepted: <code>.geojson</code>, <code>.json</code></p>

                    <div class="mt-4">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Or Paste GeoJSON</label>
                        <textarea id="asbuilt-geojson" rows="10"
                                  class="mt-2 w-full rounded-lg border border-slate-300 bg-white p-3 font-mono text-xs text-slate-700 focus:border-emerald-500 focus:outline-none dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200"
                                  placeholder='{"type":"LineString","coordinates":[[lng,lat],[lng,lat]]}'></textarea>
                    </div>

                    <div class="mt-4 grid gap-3 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Related Proposed Revision (Optional)</label>
                            <input id="asbuilt-proposed-revision" type="text"
                                   class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 focus:border-emerald-500 focus:outline-none dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200"
                                   placeholder="UUID">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Actual Length (Meters)</label>
                            <input id="asbuilt-length" type="number" step="0.01" min="0"
                                   class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 focus:border-emerald-500 focus:outline-none dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200"
                                   placeholder="Auto-computed if blank">
                            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Leave blank to auto-compute from the route coordinates.</p>
                        </div>
                    </div>

                    <div class="mt-4 flex flex-wrap items-center gap-3">
                        <button id="asbuilt-submit"
                                disabled
                                class="inline-flex items-center rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all duration-300 hover:shadow-xl hover:shadow-emerald-500/30 hover:-translate-y-0.5">
                            Submit As-Built
                        </button>
                        <a href="/vendor/projects/mine"
                           class="inline-flex items-center rounded-xl border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200 dark:hover:bg-slate-900/50">
                            Back to My Projects
                        </a>
                        <a href="/vendor/fiber-map" target="_blank"
                           class="inline-flex items-center rounded-xl border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-900/30 dark:text-slate-200 dark:hover:bg-slate-900/50">
                            Open Fiber Map
                        </a>
                    </div>

                    <div id="asbuilt-preview" class="mt-4 hidden rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300"></div>
                    <div id="asbuilt-message" class="mt-3 text-sm"></div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">2. Review Before Submit</h2>
                    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                        Checklist before sending:
                    </p>
                </div>

                <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
                    <ul class="space-y-2">
                        <li>Route is final installed path, not planned route.</li>
                        <li>GeoJSON contains a valid LineString.</li>
                        <li>Length looks correct (auto-computed or manual override).</li>
                        <li>Optional: linked proposed revision ID is correct.</li>
                    </ul>
                </div>

                <details class="rounded-lg border border-dashed border-slate-200 p-4 text-sm text-slate-500 dark:border-slate-700 dark:text-slate-400">
                    <summary class="cursor-pointer select-none font-semibold text-slate-700 dark:text-slate-200">Advanced Technical Details</summary>
                    <p class="mt-3">
                        This page submits to <code class="text-emerald-600 dark:text-emerald-400">POST /api/vendor/as-built</code> using your vendor session.
                    </p>
                    <div class="mt-2 font-mono text-xs">
                        { "project_id": "{{ project_id }}", "geojson": { ... }, "actual_length_meters": 123.45 }
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const projectId = {{ (project_id or '') | tojson }};
    const fileInput = document.getElementById('asbuilt-file');
    const geojsonTextarea = document.getElementById('asbuilt-geojson');
    const lengthInput = document.getElementById('asbuilt-length');
    const proposedRevisionInput = document.getElementById('asbuilt-proposed-revision');
    const preview = document.getElementById('asbuilt-preview');
    const msg = document.getElementById('asbuilt-message');
    const submitBtn = document.getElementById('asbuilt-submit');

    function setMessage(text, kind) {
        if (!msg) return;
        msg.textContent = text || '';
        msg.className = 'mt-3 text-sm ' + (kind === 'error' ? 'text-red-600 dark:text-red-400' : kind === 'ok' ? 'text-emerald-700 dark:text-emerald-300' : 'text-slate-600 dark:text-slate-300');
    }

    function haversineMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (d) => (d * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function extractLineStringGeojson(input) {
        if (!input || typeof input !== 'object') return null;
        if (input.type === 'LineString' && Array.isArray(input.coordinates)) return input;
        if (input.type === 'Feature' && input.geometry && input.geometry.type === 'LineString') return input.geometry;
        if (input.type === 'FeatureCollection' && Array.isArray(input.features)) {
            for (const f of input.features) {
                if (f && f.type === 'Feature' && f.geometry && f.geometry.type === 'LineString') return f.geometry;
            }
        }
        return null;
    }

    function computeLengthMeters(line) {
        const coords = line.coordinates || [];
        if (coords.length < 2) return 0;
        let total = 0;
        for (let i = 1; i < coords.length; i++) {
            const [lon1, lat1] = coords[i - 1];
            const [lon2, lat2] = coords[i];
            if ([lon1, lat1, lon2, lat2].some((v) => typeof v !== 'number')) continue;
            total += haversineMeters(lat1, lon1, lat2, lon2);
        }
        return total;
    }

    function updatePreview(parsed) {
        if (!preview) return;
        const line = extractLineStringGeojson(parsed);
        if (!line) {
            preview.classList.add('hidden');
            refreshSubmitState();
            return;
        }
        const length = computeLengthMeters(line);
        const pts = Array.isArray(line.coordinates) ? line.coordinates.length : 0;
        preview.textContent = `Valid LineString detected with ${pts} points. Computed length: ${length.toFixed(2)} m.`;
        preview.classList.remove('hidden');
        if (!lengthInput.value) {
            lengthInput.value = String(Number.isFinite(length) ? length.toFixed(2) : '');
        }
        refreshSubmitState();
    }

    function refreshSubmitState() {
        const raw = (geojsonTextarea?.value || '').trim();
        if (!raw) {
            submitBtn.disabled = true;
            return;
        }
        try {
            const parsed = JSON.parse(raw);
            const line = extractLineStringGeojson(parsed);
            submitBtn.disabled = !line;
        } catch {
            submitBtn.disabled = true;
        }
    }

    async function readFileAsJson(file) {
        const text = await file.text();
        return JSON.parse(text);
    }

    fileInput?.addEventListener('change', async () => {
        setMessage('', 'info');
        try {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const parsed = await readFileAsJson(file);
            geojsonTextarea.value = JSON.stringify(parsed, null, 2);
            updatePreview(parsed);
        } catch (e) {
            setMessage(e?.message || 'Failed to read file.', 'error');
        }
    });

    geojsonTextarea?.addEventListener('input', () => {
        setMessage('', 'info');
        try {
            const raw = geojsonTextarea.value.trim();
            if (!raw) {
                preview?.classList.add('hidden');
                return;
            }
            const parsed = JSON.parse(raw);
            updatePreview(parsed);
        } catch {
            refreshSubmitState();
        }
    });

    submitBtn?.addEventListener('click', async () => {
        setMessage('', 'info');
        if (!projectId) {
            setMessage('Missing project_id.', 'error');
            return;
        }
        const raw = (geojsonTextarea?.value || '').trim();
        if (!raw) {
            setMessage('Please upload or paste GeoJSON first.', 'error');
            return;
        }
        let parsed;
        try {
            parsed = JSON.parse(raw);
        } catch {
            setMessage('GeoJSON is not valid JSON.', 'error');
            return;
        }
        const line = extractLineStringGeojson(parsed);
        if (!line) {
            setMessage('GeoJSON must contain a LineString geometry.', 'error');
            return;
        }

        const proposedRevisionId = (proposedRevisionInput?.value || '').trim() || null;
        const lengthVal = (lengthInput?.value || '').trim();
        const lengthMeters = lengthVal ? Number(lengthVal) : computeLengthMeters(line);
        if (!Number.isFinite(lengthMeters) || lengthMeters <= 0) {
            setMessage('Could not compute a valid length. Provide a length in meters.', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        try {
            const payload = {
                project_id: projectId,
                proposed_revision_id: proposedRevisionId,
                geojson: line,
                actual_length_meters: lengthMeters
            };
            const res = await fetch('/api/vendor/as-built', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw new Error(data.detail || data.error || `Request failed (${res.status})`);
            }
            setMessage(`As-built submitted successfully. Submission ID: ${data.id}`, 'ok');
        } catch (e) {
            setMessage(e?.message || 'Could not submit as-built. Please fix any issues and try again.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit As-Built';
            refreshSubmitState();
        }
    });
    refreshSubmitState();
})();
</script>
{% endblock %}

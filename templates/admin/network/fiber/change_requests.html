{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import submit_button, table_shell, table_head, table_row, table_select_cell, empty_state %}
{% block title %}Fiber Change Requests - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Fiber change requests</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Review vendor edits before they are applied.</p>
    </div>

    {% if bulk_status == "approved" %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200">
        Bulk approval completed. Skipped: {{ skipped or 0 }}.
    </div>
    {% endif %}

    {% set columns = [
        {'label': 'Request'},
        {'label': 'Asset'},
        {'label': 'Operation'},
        {'label': 'Conflict'},
        {'label': 'Vendor'},
        {'label': 'Requested By'},
        {'label': 'Submitted'}
    ] %}
    {% set actions_html %}
    <div class="flex items-center gap-2">
        <label class="inline-flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300">
            <input type="checkbox" name="force_apply" value="true" class="h-4 w-4 rounded border-slate-300">
            Apply despite conflicts
        </label>
        {{ submit_button("Bulk approve", color="emerald", size="sm") }}
    </div>
    {% endset %}
    <form method="post" action="/admin/network/fiber-change-requests/bulk-approve">
        {% call table_shell(
            table_id="fiber-change-requests",
            color="emerald",
            bulk_actions=actions_html,
            bulk_label="Selected",
            bulk_selectable=true
        ) %}
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                {{ table_head(columns, selectable=true) }}
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for req in requests %}
                    {% call table_row(color="emerald") %}
                        {{ table_select_cell(req.id, name="request_ids", aria_label="Select request") }}
                        <td class="px-6 py-3 font-medium text-slate-900 dark:text-white">
                            <a href="/admin/network/fiber-change-requests/{{ req.id }}" class="text-primary-600 hover:underline">
                                {{ req.id }}
                            </a>
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {{ req.asset_type }}
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {{ req.operation.value }}
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {% if conflicts[req.id|string] %}
                            <span class="rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Yes</span>
                            {% else %}
                            <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">No</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {{ req.requested_vendor.name if req.requested_vendor else "-" }}
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {{ req.requested_by.first_name if req.requested_by else "-" }}
                        </td>
                        <td class="px-6 py-3 text-slate-600 dark:text-slate-300">
                            {{ req.created_at.strftime("%Y-%m-%d %H:%M") if req.created_at else "-" }}
                        </td>
                    {% endcall %}
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12">
                            {{ empty_state("No pending requests", "Vendor submissions will appear here.") }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}
    </form>
</div>

{% endblock %}

{% set prefill = prefill or {} %}
<form id="service-order-create-form" method="POST" action="{{ action_url }}" class="space-y-5">
    {% if error %}
    <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-400">
        {{ error }}
    </div>
    {% endif %}

    <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900">
        <div class="flex items-start justify-between gap-4">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider text-slate-400">Service Order</p>
                <h2 class="mt-1 text-lg font-semibold text-slate-900 dark:text-white">Provisioning details</h2>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Confirm the account and service, then assign the request.</p>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-primary-50 text-primary-600 dark:bg-primary-500/10 dark:text-primary-300">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-8 4h10a2 2 0 002-2V6a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
            </div>
        </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
            <div class="sm:col-span-2">
                <label for="account_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Account <span class="text-red-500">*</span></label>
                <select name="account_id" id="account_id" required
                    class="mt-1 block w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-700 dark:bg-slate-800 dark:text-white">
                    <option value="" disabled {% if not prefill.account_id %}selected{% endif %}>Select an account</option>
                    {% for account in accounts or [] %}
                        {% if account.subscriber and account.subscriber.person %}
                            {% set account_label = account.subscriber.person.first_name ~ ' ' ~ account.subscriber.person.last_name %}
                        {% elif account.subscriber and account.subscriber.organization %}
                            {% set account_label = account.subscriber.organization.name %}
                        {% else %}
                            {% set account_label = 'Account' %}
                        {% endif %}
                        {% if account.account_number %}
                            {% set account_label = account_label ~ ' (' ~ account.account_number ~ ')' %}
                        {% endif %}
                        <option value="{{ account.id }}" {% if prefill.account_id and prefill.account_id == account.id|string %}selected{% endif %}>
                            {{ account_label }}
                        </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Billed account for the service order.</p>
            </div>

            <div class="sm:col-span-2">
                <label for="subscription_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subscription</label>
                <select name="subscription_id" id="subscription_id"
                    data-selected-id="{{ prefill.subscription_id or '' }}"
                    class="mt-1 block w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-700 dark:bg-slate-800 dark:text-white">
                    <option value="" selected>Select an account first</option>
                </select>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400" data-subscription-hint>Select an account to load subscriptions.</p>
            </div>

            <div>
                <label for="project_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Project type</label>
                <select name="project_type" id="project_type"
                    class="mt-1 block w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-700 dark:bg-slate-800 dark:text-white">
                    <option value="" {% if not prefill.project_type %}selected{% endif %}>Select a project type</option>
                    {% for project_type in project_types or [] %}
                        <option value="{{ project_type }}" {% if prefill.project_type and prefill.project_type == project_type %}selected{% endif %}>
                            {{ project_type | replace('_', ' ') | title }}
                        </option>
                    {% endfor %}
                </select>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Optional project classification for field work.</p>
            </div>

            <div>
                <label for="requested_by_contact_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Requested by</label>
                <div class="relative" data-typeahead-url="/api/v1/search/contacts" data-typeahead-min="2" data-typeahead-limit="8">
                    <input type="text" name="requested_by_contact_search" data-typeahead-input
                           value="{{ prefill.contact_label or '' }}"
                           placeholder="Search contacts..."
                           class="mt-1 block w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-700 dark:bg-slate-800 dark:text-white">
                    <input type="hidden" name="requested_by_contact_id" data-typeahead-hidden value="{{ prefill.requested_by_contact_id or '' }}">
                    <div data-typeahead-results></div>
                </div>
            </div>

            <div class="sm:col-span-2">
                <label for="notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Provisioning notes</label>
                <textarea name="notes" id="notes" rows="4"
                    placeholder="Add technical notes, timelines, or provisioning constraints..."
                    class="mt-1 block w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-700 dark:bg-slate-800 dark:text-white">{{ prefill.notes or '' }}</textarea>
            </div>
        </div>
    </div>
</form>
<script>
(() => {
    const accountSelect = document.getElementById("account_id");
    const subscriptionSelect = document.getElementById("subscription_id");
    const hintEl = document.querySelector("[data-subscription-hint]");
    if (!accountSelect || !subscriptionSelect) {
        return;
    }
    let activeRequest = null;
    const resetSelect = (label) => {
        subscriptionSelect.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = label;
        option.selected = true;
        subscriptionSelect.appendChild(option);
        subscriptionSelect.disabled = true;
        if (hintEl) {
            hintEl.textContent = label;
        }
    };
    const buildOptionLabel = (sub) => {
        const base = sub.offer && sub.offer.name ? sub.offer.name : "Subscription";
        const suffix = sub.id ? ` â€¢ ${String(sub.id).slice(0, 8).toUpperCase()}` : "";
        return `${base}${suffix}`;
    };
    const loadSubscriptions = async (accountId) => {
        if (!accountId) {
            resetSelect("Select an account first");
            return;
        }
        if (subscriptionSelect.dataset.accountId !== accountId) {
            subscriptionSelect.dataset.selectedId = "";
            subscriptionSelect.dataset.accountId = accountId;
        }
        subscriptionSelect.disabled = true;
        subscriptionSelect.innerHTML = "";
        const loading = document.createElement("option");
        loading.value = "";
        loading.textContent = "Loading subscriptions...";
        loading.selected = true;
        subscriptionSelect.appendChild(loading);
        if (hintEl) {
            hintEl.textContent = "Loading subscriptions...";
        }
        if (activeRequest) {
            activeRequest.abort();
        }
        const controller = new AbortController();
        activeRequest = controller;
        try {
            const response = await fetch(`/api/v1/catalog/subscriptions?account_id=${encodeURIComponent(accountId)}&limit=200`, {
                signal: controller.signal
            });
            if (!response.ok) {
                throw new Error("Failed to load subscriptions");
            }
            const data = await response.json();
            subscriptionSelect.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = data.items && data.items.length > 0 ? "Select a subscription" : "No subscriptions found";
            placeholder.selected = true;
            subscriptionSelect.appendChild(placeholder);
            if (hintEl) {
                hintEl.textContent = placeholder.textContent;
            }
            const selectedId = subscriptionSelect.dataset.selectedId || "";
            (data.items || []).forEach((sub) => {
                const opt = document.createElement("option");
                opt.value = sub.id;
                opt.textContent = buildOptionLabel(sub);
                if (selectedId && String(sub.id) === String(selectedId)) {
                    opt.selected = true;
                    placeholder.selected = false;
                }
                subscriptionSelect.appendChild(opt);
            });
            subscriptionSelect.disabled = false;
        } catch (error) {
            if (error.name === "AbortError") {
                return;
            }
            resetSelect("Unable to load subscriptions");
        }
    };
    accountSelect.addEventListener("change", () => loadSubscriptions(accountSelect.value));
    loadSubscriptions(accountSelect.value);
})();
</script>

{% extends "layouts/admin.html" %}

{% block title %}{{ 'Edit' if order else 'New' }} Service Order - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/operations/service-orders" class="hover:text-primary-600">Service Orders</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">{{ 'Edit' if order else 'New' }}</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ 'Edit Service Order' if order else 'Create Service Order' }}</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">{{ 'Update service order details' if order else 'Capture a new service order request' }}</p>
        </div>
    </div>

    <form method="POST" action="{{ action_url }}" class="space-y-6">
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h2 class="font-semibold text-slate-900 dark:text-white">Order Details</h2>
            </div>
            <div class="p-6 space-y-6">
                {% if error %}
                <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-400">
                    {{ error }}
                </div>
                {% endif %}

                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subscription <span class="text-red-500">*</span></label>
                        <div class="relative mt-1" data-typeahead-url="/api/v1/search/subscriptions" data-typeahead-min="2" data-typeahead-limit="8">
                            <input type="text" data-typeahead-input
                                   id="subscription_search"
                                   value="{{ subscription_label or '' }}"
                                   class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                                   placeholder="Search subscriptions..." required>
                            <input type="hidden" name="subscription_id" id="subscription_id" data-typeahead-hidden value="{{ order.subscription_id if order and order.subscription_id else (prefill.subscription_id if prefill and prefill.subscription_id else '') }}">
                            <div data-typeahead-results></div>
                        </div>
                        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Pick the service; billing account is inferred.</p>
                        <input type="hidden" name="account_id" id="account_id" value="{{ order.account_id if order and order.account_id else (prefill.account_id if prefill and prefill.account_id else '') }}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Billing Account</label>
                        <div id="account_preview" class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700 dark:border-slate-600 dark:bg-slate-700/60 dark:text-slate-200">
                            {{ account_label or 'Select a subscription to load the billing account.' }}
                        </div>
                    </div>

                    <div>
                        <label for="project_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Project Type</label>
                        <select name="project_type" id="project_type"
                            class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            <option value="" {% if (not order or not order.project_type) and not (prefill and prefill.project_type) %}selected{% endif %}>Select a project type</option>
                            {% for project_type in project_types or [] %}
                            <option value="{{ project_type }}" {% if (order and order.project_type and order.project_type.value == project_type) or (prefill and prefill.project_type == project_type) %}selected{% endif %}>
                                {{ project_type | replace('_', ' ') | title }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Used to create the project when submitted.</p>
                    </div>

                    <div>
                        <label for="requested_by_contact_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Requested By</label>
                        {% if order and order.requested_by_contact %}
                            {% set contact_label = order.requested_by_contact.first_name ~ ' ' ~ order.requested_by_contact.last_name %}
                        {% else %}
                            {% set contact_label = '' %}
                        {% endif %}
                        <div class="relative" data-typeahead-url="/api/v1/search/contacts" data-typeahead-min="2" data-typeahead-limit="8">
                            <input type="text" name="requested_by_contact_search" data-typeahead-input
                                   value="{{ contact_label }}"
                                   placeholder="Search contacts..."
                                   class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            <input type="hidden" name="requested_by_contact_id" data-typeahead-hidden value="{{ order.requested_by_contact_id if order else (prefill.requested_by_contact_id if prefill and prefill.requested_by_contact_id else '') }}">
                            <div data-typeahead-results></div>
                        </div>
                    </div>

                    <div class="sm:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Notes</label>
                        <textarea name="notes" id="notes" rows="4"
                            placeholder="Additional details about this service order..."
                            class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">{{ order.notes if order else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end gap-3">
            <a href="/admin/operations/service-orders" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                Cancel
            </a>
            <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                {{ 'Save Changes' if order else 'Create Order' }}
            </button>
        </div>
    </form>
</div>
<script>
(() => {
    const subscriptionInput = document.getElementById("subscription_id");
    const accountInput = document.getElementById("account_id");
    const accountPreview = document.getElementById("account_preview");
    if (!subscriptionInput || !accountInput || !accountPreview) {
        return;
    }
    const updateAccount = async (subscriptionId) => {
        if (!subscriptionId) {
            accountInput.value = "";
            accountPreview.textContent = "Select a subscription to load the billing account.";
            return;
        }
        try {
            const response = await fetch(`/admin/operations/subscription-account?subscription_id=${encodeURIComponent(subscriptionId)}`);
            if (!response.ok) {
                throw new Error("Failed to load account");
            }
            const data = await response.json();
            accountInput.value = data.account_id || "";
            accountPreview.textContent = data.account_label || "Billing account unavailable.";
        } catch (error) {
            accountInput.value = "";
            accountPreview.textContent = "Unable to load billing account.";
        }
    };
    subscriptionInput.addEventListener("change", (event) => updateAccount(event.target.value));
    updateAccount(subscriptionInput.value);
})();
</script>
{% endblock %}

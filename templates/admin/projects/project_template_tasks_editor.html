{% extends "layouts/admin.html" %}

{% block title %}Edit Template Tasks - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/projects/templates" class="hover:text-primary-600">Project Templates</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <a href="/admin/projects/templates/{{ template.id }}" class="hover:text-primary-600">{{ template.name }}</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">Edit Tasks</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Edit Template Tasks</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Reorder tasks and assign dependencies.</p>
        </div>
    </div>

    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-200">
        {{ error }}
    </div>
    {% endif %}

    <form method="POST" action="/admin/projects/templates/{{ template.id }}/tasks/editor" class="space-y-6">
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h2 class="font-semibold text-slate-900 dark:text-white">Tasks</h2>
                <button type="button" id="add-task" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-primary-700">
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Task
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div id="tasks-list" data-initial='{{ tasks_payload | tojson }}'></div>
                <input type="hidden" name="tasks_json" id="tasks-json" value="">
            </div>
        </div>

        <div class="flex items-center justify-end gap-3">
            <a href="/admin/projects/templates/{{ template.id }}" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                Cancel
            </a>
            <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save Tasks
            </button>
        </div>
    </form>
</div>

<script>
(() => {
    const tasksList = document.getElementById("tasks-list");
    const tasksJsonInput = document.getElementById("tasks-json");
    const addTaskButton = document.getElementById("add-task");
    const initial = tasksList.dataset.initial ? JSON.parse(tasksList.dataset.initial) : [];

    const createClientId = () => {
        if (typeof crypto !== "undefined" && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return Math.random().toString(36).slice(2);
    };

    let tasks = initial.map((task) => ({
        client_id: task.client_id || task.id || createClientId(),
        title: task.title || "",
        description: task.description || "",
        effort_hours: task.effort_hours ?? "",
        dependencies: Array.isArray(task.dependencies) ? task.dependencies.slice() : [],
    }));

    const syncJson = () => {
        tasksJsonInput.value = JSON.stringify(tasks);
    };

    const buildDependencyOptions = (currentIndex) => {
        const allowed = tasks.slice(0, currentIndex);
        return allowed.map((task) => ({
            id: task.client_id,
            label: task.title ? task.title : "Untitled task",
        }));
    };

    const buildDependencyExtras = (currentIndex, selectedIds) => {
        const allowedIds = new Set(tasks.slice(0, currentIndex).map((task) => task.client_id));
        const extras = [];
        selectedIds.forEach((id) => {
            if (!allowedIds.has(id)) {
                const task = tasks.find((item) => item.client_id === id);
                const label = task && task.title ? task.title : "Unknown task";
                extras.push({ id, label: `${label} [after]` });
            }
        });
        return extras;
    };

    const render = () => {
        tasksList.innerHTML = "";
        if (!tasks.length) {
            const empty = document.createElement("p");
            empty.className = "text-sm text-slate-500 dark:text-slate-400";
            empty.textContent = "No tasks yet. Add your first task.";
            tasksList.appendChild(empty);
            syncJson();
            return;
        }

        tasks.forEach((task, index) => {
            const card = document.createElement("div");
            card.className = "rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-900/40";

            const header = document.createElement("div");
            header.className = "flex flex-wrap items-center justify-between gap-2";
            const title = document.createElement("p");
            title.className = "text-sm font-semibold text-slate-900 dark:text-white";
            title.textContent = `Task ${index + 1}`;
            const controls = document.createElement("div");
            controls.className = "flex items-center gap-2";

            const up = document.createElement("button");
            up.type = "button";
            up.className = "rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300";
            up.textContent = "Up";
            up.disabled = index === 0;
            up.addEventListener("click", () => {
                if (index > 0) {
                    const temp = tasks[index - 1];
                    tasks[index - 1] = tasks[index];
                    tasks[index] = temp;
                    render();
                }
            });

            const down = document.createElement("button");
            down.type = "button";
            down.className = "rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300";
            down.textContent = "Down";
            down.disabled = index === tasks.length - 1;
            down.addEventListener("click", () => {
                if (index < tasks.length - 1) {
                    const temp = tasks[index + 1];
                    tasks[index + 1] = tasks[index];
                    tasks[index] = temp;
                    render();
                }
            });

            const remove = document.createElement("button");
            remove.type = "button";
            remove.className = "rounded border border-red-200 bg-white px-2 py-1 text-xs text-red-600 hover:bg-red-50 dark:border-red-900/40 dark:bg-slate-800 dark:text-red-400";
            remove.textContent = "Remove";
            remove.addEventListener("click", () => {
                tasks.splice(index, 1);
                render();
            });

            controls.append(up, down, remove);
            header.append(title, controls);

            const grid = document.createElement("div");
            grid.className = "mt-3 grid gap-4 md:grid-cols-2";

            const titleWrap = document.createElement("div");
            const titleLabel = document.createElement("label");
            titleLabel.className = "block text-xs font-semibold text-slate-500 dark:text-slate-400";
            titleLabel.textContent = "Title";
            const titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.className = "mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:text-white";
            titleInput.value = task.title;
            titleInput.addEventListener("input", (event) => {
                task.title = event.target.value;
                syncJson();
            });
            titleInput.addEventListener("change", () => {
                render();
            });
            titleWrap.append(titleLabel, titleInput);

            const descWrap = document.createElement("div");
            const descLabel = document.createElement("label");
            descLabel.className = "block text-xs font-semibold text-slate-500 dark:text-slate-400";
            descLabel.textContent = "Description";
            const descInput = document.createElement("textarea");
            descInput.rows = 2;
            descInput.className = "mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:text-white";
            descInput.value = task.description;
            descInput.addEventListener("input", (event) => {
                task.description = event.target.value;
                syncJson();
            });
            descWrap.append(descLabel, descInput);

            const effortWrap = document.createElement("div");
            const effortLabel = document.createElement("label");
            effortLabel.className = "block text-xs font-semibold text-slate-500 dark:text-slate-400";
            effortLabel.textContent = "Effort (hours)";
            const effortInput = document.createElement("input");
            effortInput.type = "number";
            effortInput.min = "0";
            effortInput.placeholder = "e.g. 24";
            effortInput.className = "mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:text-white";
            effortInput.value = task.effort_hours;
            effortInput.addEventListener("input", (event) => {
                task.effort_hours = event.target.value;
                syncJson();
            });
            effortWrap.append(effortLabel, effortInput);

            const depWrap = document.createElement("div");
            depWrap.className = "md:col-span-2";
            const depLabel = document.createElement("label");
            depLabel.className = "block text-xs font-semibold text-slate-500 dark:text-slate-400";
            depLabel.textContent = "Depends On (earlier tasks only)";
            const depSelect = document.createElement("select");
            depSelect.multiple = true;
            depSelect.size = Math.min(5, Math.max(2, index));
            depSelect.className = "mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:text-white";

            const allowedOptions = buildDependencyOptions(index);
            const extras = buildDependencyExtras(index, task.dependencies || []);
            const allOptions = [...allowedOptions, ...extras];
            allOptions.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option.id;
                opt.textContent = option.label;
                if ((task.dependencies || []).includes(option.id)) {
                    opt.selected = true;
                }
                depSelect.appendChild(opt);
            });

            depSelect.addEventListener("change", () => {
                const selected = Array.from(depSelect.selectedOptions).map((opt) => opt.value);
                task.dependencies = selected;
                syncJson();
            });

            depWrap.append(depLabel, depSelect);

            grid.append(titleWrap, descWrap, effortWrap, depWrap);
            card.append(header, grid);
            tasksList.appendChild(card);
        });

        syncJson();
    };

    addTaskButton.addEventListener("click", () => {
        tasks.push({
            client_id: createClientId(),
            title: "",
            description: "",
            effort_hours: "",
            dependencies: [],
        });
        render();
    });

    render();
})();
</script>
{% endblock %}

{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import danger_button, table_shell, table_row, empty_state, filter_bar, filter_select, search_input %}
{% block title %}Projects - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Projects</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Coordinate builds, expansions, and cross-functional initiatives</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="/admin/projects/tasks" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                View Tasks
            </a>
            <a href="/admin/projects/new" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                New Project
            </a>
        </div>
    </div>
    {% if notice == "splynx_exists" %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800 dark:border-amber-900/40 dark:bg-amber-900/20 dark:text-amber-100">
        Customer already exists on Splynx.
    </div>
    {% endif %}

    {% set query_params = [] %}
    {% if search %}{% set _ = query_params.append('search=' ~ (search|urlencode)) %}{% endif %}
    {% if project_type %}{% set _ = query_params.append('project_type=' ~ project_type) %}{% endif %}
    {% if pm %}{% set _ = query_params.append('pm=' ~ pm) %}{% endif %}
    {% if spc %}{% set _ = query_params.append('spc=' ~ spc) %}{% endif %}
    {% if per_page %}{% set _ = query_params.append('per_page=' ~ per_page) %}{% endif %}
    {% set base_query = query_params | join('&') %}

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-6">
        <a href="/admin/projects{% if base_query %}?{{ base_query }}{% endif %}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if not status %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">All</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ total_count }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-slate-400 dark:bg-slate-500"></span>
            </div>
        </a>
        <a href="/admin/projects?{{ (query_params + ['status=planned']) | join('&') }}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if status == 'planned' %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Planned</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ status_counts.get('planned', 0) }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-slate-400 dark:bg-slate-500"></span>
            </div>
        </a>
        <a href="/admin/projects?{{ (query_params + ['status=active']) | join('&') }}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if status == 'active' %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Active</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ status_counts.get('active', 0) }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-emerald-500"></span>
            </div>
        </a>
        <a href="/admin/projects?{{ (query_params + ['status=on_hold']) | join('&') }}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if status == 'on_hold' %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">On Hold</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ status_counts.get('on_hold', 0) }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-amber-500"></span>
            </div>
        </a>
        <a href="/admin/projects?{{ (query_params + ['status=completed']) | join('&') }}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if status == 'completed' %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Completed</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ status_counts.get('completed', 0) }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-sky-500"></span>
            </div>
        </a>
        <a href="/admin/projects?{{ (query_params + ['status=canceled']) | join('&') }}" class="rounded-xl border px-4 py-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md {% if status == 'canceled' %}border-primary-300 bg-primary-50 ring-1 ring-primary-200 dark:border-primary-500/60 dark:bg-primary-500/10{% else %}border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Canceled</p>
                    <p class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">{{ status_counts.get('canceled', 0) }}</p>
                </div>
                <span class="h-3 w-3 rounded-full bg-rose-500"></span>
            </div>
        </a>
    </div>

    {% call filter_bar() %}
        <form id="projects-filter-form" method="get" action="/admin/projects" class="space-y-4">
            {# Preserve pagination size when applying filters; always reset to page 1. #}
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <input type="hidden" name="page" value="1">
            <div class="w-full lg:max-w-3xl">
                <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Search</label>
                {{ search_input("search", search or "", "Search by project name, code, number, region...", "primary") }}
            </div>
            <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-5 xl:items-end">
                <div class="w-full">
                    {{ filter_select("status", [
                        {"value": "", "label": "All Status"},
                        {"value": "planned", "label": "Planned"},
                        {"value": "active", "label": "Active"},
                        {"value": "on_hold", "label": "On Hold"},
                        {"value": "completed", "label": "Completed"},
                        {"value": "canceled", "label": "Canceled"}
                    ], status or '', "Status", "primary") }}
                </div>
                <div class="w-full">
                    {% set project_type_options = [{"value": "", "label": "All Project Types"}] %}
                    {% for item in project_types %}
                        {% set _ = project_type_options.append({"value": item, "label": item.replace('_', ' ').title()}) %}
                    {% endfor %}
                    {{ filter_select("project_type", project_type_options, project_type or '', "Project Type", "primary") }}
                </div>
                <div class="w-full">
                    {% set pm_filter_options = [{"value": "", "label": "All Project Managers"}, {"value": "me", "label": "Me"}] %}
                    {% for option in pm_options or [] %}
                        {% set _ = pm_filter_options.append(option) %}
                    {% endfor %}
                    {{ filter_select("pm", pm_filter_options, pm or '', "PM", "primary") }}
                </div>
                <div class="w-full">
                    {% set spc_filter_options = [{"value": "", "label": "All Site Coordinators"}, {"value": "me", "label": "Me"}] %}
                    {% for option in spc_options or [] %}
                        {% set _ = spc_filter_options.append(option) %}
                    {% endfor %}
                    {{ filter_select("spc", spc_filter_options, spc or '', "SPC", "primary") }}
                </div>
                <div class="flex items-end">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                        Apply Filters
                    </button>
                </div>
            </div>
        </form>
        <div class="mt-3 flex justify-end">
            <details id="projects-column-picker" class="relative">
                <summary class="inline-flex cursor-pointer list-none items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M6 12h12m-9 5h6"/>
                    </svg>
                    Table Fields
                    <svg class="h-4 w-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </summary>
                <div class="absolute right-0 z-50 mt-2 w-64 rounded-xl border border-slate-200 bg-white p-3 shadow-xl dark:border-slate-700 dark:bg-slate-900">
                    <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Show Columns</p>
                    <div id="projects-column-options" class="max-h-72 space-y-2 overflow-y-auto pr-1">
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="project" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500" checked>
                            <span>Project</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="customer" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500" checked>
                            <span>Customer</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="status" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500" checked>
                            <span>Status</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="priority" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500" checked>
                            <span>Priority</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="created" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500" checked>
                            <span>Created</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="code" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Code</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="type" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Project Type</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="region" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Region</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="owner" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Owner</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="manager" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Manager</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="project_manager" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Project Manager</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="assistant_manager" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Site Coordinator</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="start_at" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Start Date</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="due_at" data-project-column-option class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-primary-500">
                            <span>Due Date</span>
                        </label>
                    </div>
                </div>
            </details>
        </div>
    {% endcall %}

    <div x-data="{ activeView: 'table' }">
        <!-- View Tabs -->
        <div class="mb-4 flex items-center gap-1 rounded-xl border border-slate-200 bg-white p-1 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <button type="button"
                    x-on:click="activeView = 'table'"
                    :class="activeView === 'table' ? 'bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/50'"
                    class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18M3 18h18M3 6h18"/></svg>
                Table
            </button>
            <button type="button"
                    x-on:click="activeView = 'kanban'; $nextTick(() => { if (window.DotmacKanban) window.DotmacKanban.initAll(); })"
                    :class="activeView === 'kanban' ? 'bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/50'"
                    class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
                Kanban
            </button>
            <button type="button"
                    x-on:click="activeView = 'gantt'; $nextTick(() => { if (window.DotmacGantt) window.DotmacGantt.initAll(); })"
                    :class="activeView === 'gantt' ? 'bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-50 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/50'"
                    class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-8 4h12M8 15h4"/></svg>
                Gantt
            </button>
        </div>

        <!-- Kanban View -->
        <div x-show="activeView === 'kanban'" x-cloak class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs text-slate-500 dark:text-slate-400">Drag to update status. Fields are configurable per board.</p>
            <div class="mt-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/30 dark:text-slate-400">
                Manage Kanban settings in System Settings → Projects.
            </div>
            <div
                class="mt-4"
                id="projects-kanban"
                data-kanban
                data-kanban-endpoint="/api/v1/projects/kanban"
                data-update-endpoint="/api/v1/projects/kanban/move"
                data-config='{"columnField":"status","idField":"id","titleField":"name","subtitleField":"project_type","metaFields":["status","due_date"]}'>
            </div>
        </div>

        <!-- Gantt View -->
        <div x-show="activeView === 'gantt'" x-cloak class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs text-slate-500 dark:text-slate-400">Drag the bar handle to update the due date.</p>
            <div class="mt-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/30 dark:text-slate-400">
                Manage Gantt settings in System Settings → Projects.
            </div>
            <div
                class="mt-4"
                id="projects-gantt"
                data-gantt
                data-gantt-endpoint="/api/v1/projects/gantt"
                data-update-endpoint="/api/v1/projects/gantt/due-date"
                data-config='{"idField":"id","titleField":"name","startField":"start_date","dragField":"due_date"}'>
            </div>
        </div>

        <!-- Table View -->
        <div x-show="activeView === 'table'">
    {% set pad = 'px-6 py-3' %}
    {% call table_shell(table_id="projects-table", color="primary") %}
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead>
                <tr class="border-b border-slate-100 dark:border-slate-700/50">
                    <th data-project-column="project" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Project</th>
                    <th data-project-column="code" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Code</th>
                    <th data-project-column="type" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Project Type</th>
                    <th data-project-column="customer" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Customer</th>
                    <th data-project-column="region" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Region</th>
                    <th data-project-column="status" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                    <th data-project-column="priority" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Priority</th>
                    <th data-project-column="owner" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Owner</th>
                    <th data-project-column="manager" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Manager</th>
                    <th data-project-column="project_manager" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Project Manager</th>
                    <th data-project-column="assistant_manager" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Site Coordinator</th>
                    <th data-project-column="start_at" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Start Date</th>
                    <th data-project-column="due_at" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Due Date</th>
                    <th data-project-column="created" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Created</th>
                    <th class="{{ pad }}"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 bg-white dark:divide-slate-700 dark:bg-slate-800">
                {% if projects %}
                {% for project in projects %}
                {% set status_val = project.status.value if project.status else 'planned' %}
                {% set project_type_label = project.project_type.value | replace('_', ' ') | title if project.project_type else '—' %}
                {% set owner_label = project.owner.display_name or ((project.owner.first_name or '') ~ ' ' ~ (project.owner.last_name or '') | trim) if project.owner else '—' %}
                {% set manager_label = project.manager.display_name or ((project.manager.first_name or '') ~ ' ' ~ (project.manager.last_name or '') | trim) if project.manager else '—' %}
                {% set pm_label = project.project_manager.display_name or ((project.project_manager.first_name or '') ~ ' ' ~ (project.project_manager.last_name or '') | trim) if project.project_manager else '—' %}
                {% set spc_label = project.assistant_manager.display_name or ((project.assistant_manager.first_name or '') ~ ' ' ~ (project.assistant_manager.last_name or '') | trim) if project.assistant_manager else '—' %}
                {% call table_row(color="primary") %}
                    <td data-project-column="project" class="{{ pad }}">
                        <p class="text-sm font-medium text-slate-900 dark:text-white">{{ project.name }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ project.code | default(project.number or (project.id|string|truncate(8, True, ''))) }}</p>
                    </td>
                    <td data-project-column="code" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ project.code or project.number or '—' }}
                    </td>
                    <td data-project-column="type" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ project_type_label }}
                    </td>
                    <td data-project-column="customer" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {% if project.subscriber %}
                        {% set subscriber = project.subscriber %}
                        <a href="/admin/subscribers/{{ subscriber.id }}" class="font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400">
                            {% if subscriber.person %}
                                {{ subscriber.person.first_name }} {{ subscriber.person.last_name }}
                                {% elif subscriber.organization %}
                                {{ subscriber.organization.legal_name or subscriber.organization.name }}
                                {% else %}
                                Subscriber
                                {% endif %}
                            </a>
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td data-project-column="region" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ project.region or '—' }}
                    </td>
                    <td data-project-column="status" class="{{ pad }}">
                        <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-700 dark:text-slate-300">{{ status_val | replace('_', ' ') | title }}</span>
                    </td>
                    <td data-project-column="priority" class="{{ pad }}">
                        <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">{{ project.priority.value if project.priority else 'normal' }}</span>
                    </td>
                    <td data-project-column="owner" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ owner_label or '—' }}
                    </td>
                    <td data-project-column="manager" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ manager_label or '—' }}
                    </td>
                    <td data-project-column="project_manager" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ pm_label or '—' }}
                    </td>
                    <td data-project-column="assistant_manager" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {{ spc_label or '—' }}
                    </td>
                    <td data-project-column="start_at" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">
                        {{ project.start_at.strftime('%b %d, %Y %H:%M') if project.start_at else '—' }}
                    </td>
                    <td data-project-column="due_at" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">
                        {{ project.due_at.strftime('%b %d, %Y %H:%M') if project.due_at else '—' }}
                    </td>
                    <td data-project-column="created" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ project.created_at.strftime('%b %d, %Y') if project.created_at else 'N/A' }}</td>
                    <td class="{{ pad }} text-right">
                        <a href="/admin/projects/{{ project.number or project.id }}" class="text-sm font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400">View</a>
                        <span class="px-1.5 text-slate-300">|</span>
                        <a href="/admin/projects/{{ project.number or project.id }}/edit" class="text-sm font-medium text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white">Edit</a>
                            <span class="px-1.5 text-slate-300">|</span>
                            <form method="post"
                                  action="/admin/projects/{{ project.number or project.id }}/delete"
                                  class="inline"
                                  onsubmit="return confirm('Delete this project?')">
                                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                                <button type="submit"
                                        class="inline-flex items-center px-3 py-1.5 text-xs gap-1.5 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 font-semibold text-white shadow-lg shadow-red-500/25 transition-all hover:shadow-xl hover:shadow-red-500/30 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Delete
                                </button>
                            </form>
                        </td>
                {% endcall %}
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="20" class="px-6 py-12">
                            {{ empty_state("No projects", "Projects will appear here once created.") }}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        {% if total_pages and total_pages > 1 %}
        {% set search_param = '&search=' ~ (search|urlencode) if search else '' %}
        {% set status_param = '&status=' ~ status if status else '' %}
        {% set project_type_param = '&project_type=' ~ project_type if project_type else '' %}
        {% set pm_param = '&pm=' ~ pm if pm else '' %}
        {% set spc_param = '&spc=' ~ spc if spc else '' %}
        <div class="flex flex-col items-center justify-between gap-4 border-t border-slate-200 px-4 py-3 dark:border-slate-700 sm:flex-row">
            <div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                <span>Page {{ page }} of {{ total_pages }}</span>
                <label class="inline-flex items-center gap-2">
                    <span>Rows</span>
                    {# Avoid `new URL(...)` because SES lockdown can remove URL constructor. #}
                    <form method="get" action="/admin/projects" class="inline">
                        <input type="hidden" name="search" value="{{ search or '' }}">
                        <input type="hidden" name="status" value="{{ status or '' }}">
                        <input type="hidden" name="project_type" value="{{ project_type or '' }}">
                        <input type="hidden" name="pm" value="{{ pm or '' }}">
                        <input type="hidden" name="spc" value="{{ spc or '' }}">
                        <input type="hidden" name="page" value="1">
                        <select name="per_page"
                                class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-sm text-slate-700 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200"
                                onchange="this.form.submit()">
                            {% for size in [10, 25, 50, 100] %}
                            <option value="{{ size }}" {% if per_page|int == size %}selected{% endif %}>{{ size }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </label>
            </div>
            <div class="flex items-center gap-2">
                {% if page > 1 %}
                <a href="/admin/projects?page={{ page - 1 }}&per_page={{ per_page }}{{ search_param }}{{ status_param }}{{ project_type_param }}{{ pm_param }}{{ spc_param }}" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Previous</a>
                {% endif %}
                {% if page < total_pages %}
                <a href="/admin/projects?page={{ page + 1 }}&per_page={{ per_page }}{{ search_param }}{{ status_param }}{{ project_type_param }}{{ pm_param }}{{ spc_param }}" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% endcall %}
        </div>{# /table view #}
    </div>{# /x-data tabs #}
</div>
{% endblock %}

{% block charts_js %}
<script src="/static/js/kanban.js" defer></script>
<script src="/static/js/gantt.js" defer></script>
<script defer>
document.addEventListener("DOMContentLoaded", () => {
    const kanbanKey = "kanban_config";
    const ganttKey = "gantt_config";
    const kanbanEl = document.getElementById("projects-kanban");
    const ganttEl = document.getElementById("projects-gantt");

    async function fetchSetting(key) {
        const response = await fetch(`/api/v1/settings/projects/${key}`, {
            credentials: "same-origin",
        });
        if (response.status === 404) return null;
        if (!response.ok) throw new Error(`Settings fetch failed: ${response.status}`);
        const payload = await response.json();
        return payload.value_json || null;
    }


    function applyKanbanConfig(config) {
        kanbanEl.dataset.kanbanEndpoint = config.endpoint;
        kanbanEl.dataset.updateEndpoint = config.updateEndpoint;
        kanbanEl.dataset.config = JSON.stringify({
            columnField: config.columnField,
            idField: config.idField,
            titleField: config.titleField,
            subtitleField: config.subtitleField,
            metaFields: config.metaFields,
        });
        if (window.DotmacKanban) window.DotmacKanban.initAll();
    }

    function applyGanttConfig(config) {
        ganttEl.dataset.ganttEndpoint = config.endpoint;
        ganttEl.dataset.updateEndpoint = config.updateEndpoint;
        ganttEl.dataset.config = JSON.stringify({
            idField: config.idField,
            titleField: config.titleField,
            startField: config.startField,
            dragField: config.dragField,
        });
        if (window.DotmacGantt) window.DotmacGantt.initAll();
    }


    const defaultKanbanConfig = {
        endpoint: kanbanEl.dataset.kanbanEndpoint || "",
        updateEndpoint: kanbanEl.dataset.updateEndpoint || "",
        columnField: "status",
        idField: "id",
        titleField: "name",
        subtitleField: "project_type",
        metaFields: ["status", "due_date"],
    };

    const defaultGanttConfig = {
        endpoint: ganttEl.dataset.ganttEndpoint || "",
        updateEndpoint: ganttEl.dataset.updateEndpoint || "",
        idField: "id",
        titleField: "name",
        startField: "start_date",
        dragField: "due_date",
    };

    function normalizeKanbanConfig(config) {
        const merged = { ...defaultKanbanConfig, ...(config || {}) };
        if (!merged.endpoint) merged.endpoint = defaultKanbanConfig.endpoint;
        if (!merged.updateEndpoint) merged.updateEndpoint = defaultKanbanConfig.updateEndpoint;
        if (!merged.columnField) merged.columnField = defaultKanbanConfig.columnField;
        if (!merged.idField) merged.idField = defaultKanbanConfig.idField;
        if (!merged.titleField) merged.titleField = defaultKanbanConfig.titleField;
        if (!merged.subtitleField) merged.subtitleField = defaultKanbanConfig.subtitleField;
        if (!Array.isArray(merged.metaFields)) {
            merged.metaFields = defaultKanbanConfig.metaFields;
        }
        return merged;
    }

    function normalizeGanttConfig(config) {
        const merged = { ...defaultGanttConfig, ...(config || {}) };
        if (!merged.endpoint) merged.endpoint = defaultGanttConfig.endpoint;
        if (!merged.updateEndpoint) merged.updateEndpoint = defaultGanttConfig.updateEndpoint;
        if (!merged.idField) merged.idField = defaultGanttConfig.idField;
        if (!merged.titleField) merged.titleField = defaultGanttConfig.titleField;
        if (!merged.startField) merged.startField = defaultGanttConfig.startField;
        if (!merged.dragField) merged.dragField = defaultGanttConfig.dragField;
        return merged;
    }

    (async () => {
        let kanbanConfig = normalizeKanbanConfig(defaultKanbanConfig);
        let ganttConfig = normalizeGanttConfig(defaultGanttConfig);
        try {
            const savedKanbanConfig = await fetchSetting(kanbanKey);
            if (savedKanbanConfig) {
                kanbanConfig = normalizeKanbanConfig(savedKanbanConfig);
            }
        } catch (error) {
            console.warn(error);
        }
        try {
            const savedGanttConfig = await fetchSetting(ganttKey);
            if (savedGanttConfig) {
                ganttConfig = normalizeGanttConfig(savedGanttConfig);
            }
        } catch (error) {
            console.warn(error);
        }
        applyKanbanConfig(kanbanConfig);
        applyGanttConfig(ganttConfig);
    })();
});
</script>
<script src="/static/js/ui-filter-state.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const userId = "{{ (current_user.get('person_id') if current_user and current_user.get('person_id') else 'anon') }}";
    if (!window.DotmacUiFilterState || !window.DotmacUiFilterState.init) return;
    const columnDefinitions = [
        "project",
        "customer",
        "status",
        "priority",
        "created",
        "code",
        "type",
        "region",
        "owner",
        "manager",
        "project_manager",
        "assistant_manager",
        "start_at",
        "due_at"
    ];
    window.DotmacUiFilterState.init({
        formId: "projects-filter-form",
        fields: ["search", "status", "project_type", "pm", "spc"],
        filterStorageKey: `admin:projects:filters:${userId}`,
        columns: {
            optionSelector: "[data-project-column-option]",
            storageKey: `admin:projects:columns:${userId}`,
            cellAttr: "data-project-column",
            validKeys: columnDefinitions,
            defaultVisible: ["project", "customer", "status", "priority", "created"],
        },
    });
});
</script>
{% endblock %}

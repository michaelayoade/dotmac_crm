{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import danger_button %}
{% block title %}{{ survey.name }} - Surveys - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
        <a href="/admin/surveys" class="hover:text-slate-700 dark:hover:text-slate-200">Surveys</a>
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        <span class="text-slate-700 dark:text-slate-200">{{ survey.name }}</span>
    </nav>

    <!-- Header + Actions -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ survey.name }}</h1>
                {% set status_colors = {'draft': 'bg-slate-100 text-slate-700 dark:bg-slate-600/30 dark:text-slate-300', 'active': 'bg-green-100 text-green-700 dark:bg-green-600/20 dark:text-green-400', 'paused': 'bg-amber-100 text-amber-700 dark:bg-amber-600/20 dark:text-amber-400', 'closed': 'bg-red-100 text-red-700 dark:bg-red-600/20 dark:text-red-400'} %}
                <span class="inline-flex rounded-full px-2.5 py-0.5 text-xs font-semibold {{ status_colors.get(survey.status.value, 'bg-slate-100 text-slate-700') }}">
                    {{ survey.status.value | capitalize }}
                </span>
            </div>
            {% if survey.description %}
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">{{ survey.description }}</p>
            {% endif %}
            <div class="mt-1 flex items-center gap-4 text-xs text-slate-400 dark:text-slate-500">
                <span>Trigger: {{ survey.trigger_type.value | replace('_', ' ') | title }}</span>
                {% if survey.public_slug %}
                <span>Slug: <code class="rounded bg-slate-100 px-1.5 py-0.5 text-xs dark:bg-slate-700">/s/{{ survey.public_slug }}</code></span>
                {% endif %}
                <span>Created {{ survey.created_at.strftime('%b %d, %Y') }}</span>
            </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
            {% if survey.status.value == 'draft' or survey.status.value == 'paused' %}
            <form method="POST" action="/admin/surveys/{{ survey.id }}/activate" class="inline">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token(request) if csrf_token is defined else '' }}">
                <button type="submit" class="rounded-lg bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 transition-colors">Activate</button>
            </form>
            {% endif %}
            {% if survey.status.value == 'active' %}
            <form method="POST" action="/admin/surveys/{{ survey.id }}/pause" class="inline">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token(request) if csrf_token is defined else '' }}">
                <button type="submit" class="rounded-lg bg-amber-500 px-4 py-2 text-sm font-medium text-white hover:bg-amber-600 transition-colors">Pause</button>
            </form>
            <form method="POST" action="/admin/surveys/{{ survey.id }}/send" class="inline">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token(request) if csrf_token is defined else '' }}">
                <button type="submit" class="rounded-lg bg-teal-600 px-4 py-2 text-sm font-medium text-white hover:bg-teal-700 transition-colors">Send Now</button>
            </form>
            {% endif %}
            {% if survey.status.value != 'closed' %}
            <form method="POST" action="/admin/surveys/{{ survey.id }}/close" class="inline">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token(request) if csrf_token is defined else '' }}">
                <button type="submit" class="rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition-colors">Close Survey</button>
            </form>
            {% endif %}
            {% if survey.status.value in ['draft', 'paused'] %}
            <a href="/admin/surveys/{{ survey.id }}/edit" class="rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition-colors">Edit</a>
            {% endif %}
        </div>
    </div>

    <!-- Analytics Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
        <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">Invited</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{{ stats.total_invited }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">Responses</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{{ stats.total_responses }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">Response Rate</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{{ "%.1f" | format(stats.response_rate) }}%</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">Avg Rating</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{% if stats.avg_rating %}{{ "%.1f" | format(stats.avg_rating) }}{% else %}-{% endif %}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">NPS Score</p>
            <p class="mt-1 text-2xl font-bold {% if stats.nps_score is not none %}{{ 'text-green-600' if stats.nps_score >= 50 else ('text-amber-600' if stats.nps_score >= 0 else 'text-red-600') }}{% else %}text-slate-900 dark:text-white{% endif %}">
                {% if stats.nps_score is not none %}{{ stats.nps_score | int }}{% else %}-{% endif %}
            </p>
        </div>
    </div>

    <!-- Question Breakdown -->
    {% if stats.question_breakdown %}
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Question Breakdown</h2>
        </div>
        <div class="divide-y divide-slate-200 dark:divide-slate-700">
            {% for qb in stats.question_breakdown %}
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-900 dark:text-white">{{ qb.label }}</p>
                        <p class="text-xs text-slate-400 dark:text-slate-500">{{ qb.type | replace('_', ' ') | title }} &middot; {{ qb.response_count }} responses</p>
                    </div>
                    {% if qb.avg_value is not none %}
                    <span class="text-lg font-bold text-teal-600 dark:text-teal-400">{{ "%.1f" | format(qb.avg_value) }}</span>
                    {% endif %}
                </div>
                {% if qb.distribution %}
                <div class="mt-3 flex flex-wrap gap-2">
                    {% for key, count in qb.distribution.items() %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-700 dark:bg-slate-700 dark:text-slate-300">
                        {{ key }}: {{ count }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Questions List -->
    {% if survey.questions %}
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Questions ({{ survey.questions | length }})</h2>
        </div>
        <div class="divide-y divide-slate-100 dark:divide-slate-700">
            {% for q in survey.questions %}
            <div class="px-6 py-3 flex items-center gap-3">
                <span class="flex h-6 w-6 items-center justify-center rounded-full bg-teal-100 text-xs font-bold text-teal-700 dark:bg-teal-600/20 dark:text-teal-400">{{ loop.index }}</span>
                <div class="flex-1">
                    <p class="text-sm text-slate-700 dark:text-slate-300">{{ q.label }}</p>
                    <p class="text-xs text-slate-400">{{ q.type | replace('_', ' ') | title }}{% if q.get('required', true) %} &middot; Required{% endif %}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Responses -->
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Recent Responses</h2>
            <span class="text-xs text-slate-400 dark:text-slate-500">{{ responses | length }} shown</span>
        </div>
        {% if responses %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Rating</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Answers</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for resp in responses %}
                    <tr>
                        <td class="px-6 py-3 text-sm text-slate-500 dark:text-slate-400 whitespace-nowrap">{{ resp.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                        <td class="px-6 py-3 text-sm text-slate-700 dark:text-slate-300">{% if resp.rating %}{{ resp.rating }}/5{% else %}-{% endif %}</td>
                        <td class="px-6 py-3 text-sm text-slate-500 dark:text-slate-400 max-w-md truncate">
                            {% if resp.responses %}
                            {% for key, val in resp.responses.items() %}
                            <span class="inline-block mr-2"><strong>{{ key }}:</strong> {{ val | truncate(40) }}</span>
                            {% endfor %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center text-sm text-slate-400 dark:text-slate-500">No responses yet.</div>
        {% endif %}
    </div>

    <!-- Invitations -->
    {% if invitations %}
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Invitations</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Recipient</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Sent</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for inv in invitations %}
                    <tr>
                        <td class="px-6 py-3">
                            <div class="text-sm text-slate-700 dark:text-slate-300">
                                {% set person = person_map.get(inv.person_id | string) %}
                                {{ person.display_name if person else inv.email }}
                            </div>
                            <div class="text-xs text-slate-400">{{ inv.email }}</div>
                        </td>
                        <td class="px-6 py-3">
                            {% set inv_colors = {'pending': 'bg-slate-100 text-slate-700', 'sent': 'bg-blue-100 text-blue-700', 'opened': 'bg-amber-100 text-amber-700', 'completed': 'bg-green-100 text-green-700', 'expired': 'bg-red-100 text-red-700'} %}
                            <span class="inline-flex rounded-full px-2 py-0.5 text-xs font-medium {{ inv_colors.get(inv.status.value, 'bg-slate-100 text-slate-700') }}">
                                {{ inv.status.value | capitalize }}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-sm text-slate-500 dark:text-slate-400">
                            {{ inv.sent_at.strftime('%b %d, %Y') if inv.sent_at else '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Danger Zone -->
    {% if survey.status.value in ['draft', 'paused', 'closed'] %}
    <div class="rounded-xl border border-red-200 bg-red-50 p-6 dark:border-red-800 dark:bg-red-900/20">
        <h3 class="text-sm font-semibold text-red-700 dark:text-red-400">Danger Zone</h3>
        <p class="mt-1 text-xs text-red-600 dark:text-red-400/80">Deactivating a survey hides it from the list. This cannot be undone.</p>
        {{ danger_button("Deactivate Survey", "Confirm Deactivate", "Are you sure you want to deactivate this survey?", "/admin/surveys/" ~ survey.id ~ "/delete") }}
    </div>
    {% endif %}
</div>
{% endblock %}

{% extends "layouts/admin.html" %}

{% block title %}Lead Details - Admin{% endblock %}

{% block content %}
{% set status_label = status_val | replace('_', ' ') | title %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/crm/leads" class="hover:text-primary-600">Leads</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">Details</span>
            </nav>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
                    {{ lead.title or ('Lead ' ~ lead.id|string|truncate(8, True, '')) }}
                </h1>
                <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-300">
                    {{ status_label }}
                </span>
            </div>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Lead ID: {{ lead.id }}</p>
        </div>
        <div class="flex items-center gap-2">
            <a href="/admin/crm/leads" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
                Back to leads
            </a>
            <a href="/admin/crm/quotes/new?lead_id={{ lead.id }}" class="inline-flex items-center gap-2 rounded-lg border border-primary-200 bg-primary-50 px-4 py-2 text-sm font-medium text-primary-700 hover:bg-primary-100 dark:border-primary-700/50 dark:bg-primary-900/20 dark:text-primary-200 dark:hover:bg-primary-900/30">
                Create Quote
            </a>
            <a href="/admin/crm/leads/{{ lead.id }}/edit" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                Edit Lead
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-6">
            <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Lead Overview</h2>
                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Pipeline</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ pipeline.name if pipeline else '—' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Stage</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ stage.name if stage else '—' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Region</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ lead.region or '—' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Owner</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ owner_label }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Status</p>
                        <form action="/admin/crm/leads/{{ lead.id }}/status" method="post" class="mt-1">
                            <select name="status" hx-trigger="change" hx-post="/admin/crm/leads/{{ lead.id }}/status" hx-swap="none"
                                    class="rounded-lg border border-slate-200 bg-slate-50/50 px-2.5 py-1 text-sm font-medium text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white">
                                {% for s in ['new', 'contacted', 'qualified', 'proposal', 'negotiation', 'won', 'lost'] %}
                                <option value="{{ s }}" {% if status_val == s %}selected{% endif %}>{{ s | replace('_', ' ') | title }}</option>
                                {% endfor %}
                            </select>
                            <noscript><button type="submit" class="ml-1 rounded-lg bg-primary-600 px-2 py-1 text-xs text-white">Save</button></noscript>
                        </form>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Estimated Value</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">
                            {% if lead.estimated_value %}
                                {{ lead.currency or '' }} {{ "{:,.2f}".format(lead.estimated_value) }}
                            {% else %}
                                —
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Weighted Value</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">
                            {% if lead.weighted_value %}
                                {{ lead.currency or '' }} {{ "{:,.2f}".format(lead.weighted_value) }}
                            {% else %}
                                —
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Probability</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">
                            {% if lead.probability is not none %}
                            <span class="inline-flex items-center gap-2">
                                <span class="h-2 w-16 rounded-full bg-slate-200 dark:bg-slate-700">
                                    <span class="block h-2 rounded-full bg-primary-500" style="width: {{ lead.probability }}%"></span>
                                </span>
                                {{ lead.probability }}%
                            </span>
                            {% else %}
                                —
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Expected Close</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">
                            {{ lead.expected_close_date.strftime('%b %d, %Y') if lead.expected_close_date else '—' }}
                        </p>
                    </div>
                    {% if lead.lost_reason %}
                    <div class="sm:col-span-2">
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Lost Reason</p>
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ lead.lost_reason }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Active</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ 'Yes' if lead.is_active else 'No' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Created</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ lead.created_at.strftime('%b %d, %Y %H:%M') if lead.created_at else '—' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Last Updated</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ lead.updated_at.strftime('%b %d, %Y %H:%M') if lead.updated_at else '—' }}</p>
                    </div>
                </div>
            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Notes</h2>
                <div class="mt-3 text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
                    {{ lead.notes or 'No notes provided.' }}
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Contact</h2>
                {% if contact %}
                <div class="mt-4 space-y-2">
                    <p class="text-sm font-semibold text-slate-900 dark:text-white">
                        {{ contact.display_name or 'Contact' }}
                    </p>
                    <p class="text-sm text-slate-600 dark:text-slate-300">{{ contact.email or '—' }}</p>
                    <p class="text-sm text-slate-600 dark:text-slate-300">{{ contact.phone or '—' }}</p>
                    <a href="/admin/crm/contacts/{{ contact.id }}" class="inline-flex items-center gap-2 text-sm font-medium text-primary-600 hover:text-primary-700">
                        View contact
                    </a>
                </div>
                {% else %}
                <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">No contact linked.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

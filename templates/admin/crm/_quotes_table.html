{% from "components/ui/macros.html" import danger_button, empty_state, icon_delete, icon_download, icon_edit, icon_view, pagination, row_action, status_badge, table_shell, table_row %}
{% set pad = 'px-6 py-3' %}
{% set user_roles = current_user.roles if current_user is defined and current_user else [] %}
{% set user_roles_lower = user_roles | map('lower') | list %}
{% set can_delete_quotes = 'admin' in user_roles_lower %}

{% call table_shell(table_id="quotes-table", color="cyan", bulk_selectable=False, search=False) %}
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead>
                <tr class="border-b border-slate-100 dark:border-slate-700/50">
                    <th scope="col" class="w-12 {{ pad }}">
                        <input type="checkbox"
                               data-select-all
                               class="h-4 w-4 rounded border-slate-300 text-cyan-600 focus:ring-cyan-500 focus:ring-offset-0 dark:border-slate-600 dark:bg-slate-700 dark:checked:bg-cyan-500 cursor-pointer">
                    </th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Quote</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Lead</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Contact</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Status</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Total</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Expires</th>
                    <th scope="col" class="{{ pad }} text-right text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                {% if quotes %}
                {% for quote in quotes %}
                {% set contact = contacts_map.get(quote.contact_id|string) if quote.contact_id else None %}
                {% set lead = lead_map.get(quote.lead_id|string) if quote.lead_id else None %}
                {% set stored_name = quote.metadata_.get('quote_name') if quote.metadata_ and quote.metadata_.get('quote_name') else '' %}
                {% set quote_name = stored_name if stored_name else (contact.display_name if contact and contact.display_name else (contact.email if contact else '')) %}
                {% set status_val = quote.status.value if quote.status else 'draft' %}

                {% call table_row(color="cyan") %}
                    <td class="w-12 {{ pad }}">
                        <input type="checkbox"
                               data-quote-select
                               data-quote-id="{{ quote.id }}"
                               class="h-4 w-4 rounded border-slate-300 text-cyan-600 focus:ring-cyan-500 focus:ring-offset-0 dark:border-slate-600 dark:bg-slate-700 dark:checked:bg-cyan-500 cursor-pointer">
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 text-white font-semibold text-sm shadow-sm">
                                {{ (quote_name[0] if quote_name else 'Q') | upper }}
                            </div>
                            <div class="min-w-0">
                                <a href="/admin/crm/quotes/{{ quote.id }}" class="group/link flex items-center gap-1.5">
                                    <span class="text-sm font-semibold text-slate-900 group-hover/link:text-cyan-600 dark:text-white dark:group-hover/link:text-cyan-400 transition-colors">
                                        {{ quote_name if quote_name else ('Quote ' ~ (quote.id | string | truncate(8, True, ''))) }}
                                    </span>
                                    <svg class="h-3.5 w-3.5 text-slate-400 opacity-0 transition-all group-hover/link:opacity-100 group-hover/link:translate-x-0.5 group-hover/link:text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </a>
                                <p class="mt-0.5 truncate text-xs text-slate-500 dark:text-slate-400">{{ quote.id | string | truncate(12, True, '') }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="whitespace-nowrap {{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {% if lead %}
                        <a href="/admin/crm/leads/{{ lead.id }}" class="hover:text-cyan-600 dark:hover:text-cyan-400">
                            {{ lead.title if lead.title else (lead.id|string|truncate(8, True, '')) }}
                        </a>
                        {% else %}
                        <span class="text-slate-400">—</span>
                        {% endif %}
                    </td>
                    <td class="whitespace-nowrap {{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        {% if contact %}
                        {{ contact.display_name if contact.display_name else contact.email }}
                        {% else %}
                        <span class="text-slate-400">—</span>
                        {% endif %}
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        {% if status_val == 'draft' %}
                        {{ status_badge("Draft", "pending") }}
                        {% elif status_val == 'sent' %}
                        {{ status_badge("Sent", "info") }}
                        {% elif status_val == 'accepted' %}
                        {{ status_badge("Accepted", "active") }}
                        {% elif status_val == 'rejected' %}
                        {{ status_badge("Rejected", "inactive") }}
                        {% elif status_val == 'expired' %}
                        {{ status_badge("Expired", "inactive") }}
                        {% else %}
                        {{ status_badge(status_val | replace('_', ' ') | title, "pending") }}
                        {% endif %}
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        <span class="text-sm font-medium text-slate-900 dark:text-white">
                            {{ quote.currency }} {{ "{:,.2f}".format(quote.total or 0) }}
                        </span>
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        {% if quote.expires_at %}
                        {% set days_left = (quote.expires_at - today).days if today is defined and quote.expires_at else none %}
                        {% if days_left is not none and days_left < 0 %}
                        <span class="inline-flex items-center gap-1 text-sm font-medium text-red-600 dark:text-red-400">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            Expired
                        </span>
                        {% elif days_left is not none and days_left <= 3 %}
                        <span class="inline-flex items-center gap-1 text-sm font-medium text-red-600 dark:text-red-400">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                            {{ quote.expires_at.strftime('%b %d, %Y') }} <span class="text-xs">({{ days_left }}d)</span>
                        </span>
                        {% elif days_left is not none and days_left <= 7 %}
                        <span class="inline-flex items-center gap-1 text-sm font-medium text-amber-600 dark:text-amber-400">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                            {{ quote.expires_at.strftime('%b %d, %Y') }} <span class="text-xs">({{ days_left }}d)</span>
                        </span>
                        {% else %}
                        <span class="text-sm text-slate-600 dark:text-slate-300">
                            {{ quote.expires_at.strftime('%b %d, %Y') }}
                        </span>
                        {% endif %}
                        {% else %}
                        <span class="text-sm text-slate-400">—</span>
                        {% endif %}
                    </td>
                    <td class="whitespace-nowrap {{ pad }} text-right">
                        <div class="flex items-center justify-end gap-1 opacity-0 transition-opacity group-hover:opacity-100">
                            {{ row_action("/admin/crm/quotes/" ~ quote.id, icon_view(), "View details", "cyan") }}
                            {{ row_action("/admin/crm/quotes/" ~ quote.id ~ "/edit", icon_edit(), "Edit quote", "slate") }}
                            {% if can_delete_quotes %}
                            {{ danger_button("Delete", "Confirm Delete", "Delete this quote?", "/admin/crm/quotes/" ~ quote.id ~ "/delete", size="sm") }}
                            {% endif %}
                        </div>
                    </td>
                {% endcall %}
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-12">
                        {{ empty_state("No quotes found", "Create your first quote to get started.", "/admin/crm/quotes/new", "New Quote") }}
                    </td>
                </tr>
                {% endif %}
            </tbody>
    </table>

    {# Pagination #}
    {% if total_pages > 1 %}
    <div class="border-t border-slate-100 px-5 py-4 dark:border-slate-700/50">
        {{ pagination(page, total_pages, total, "/admin/crm/quotes", {"status": status, "lead_id": lead_id, "search": search}) }}
    </div>
    {% endif %}
{% endcall %}

<script>
// Selection handling for this table partial
(function() {
    const selectAll = document.querySelector('[data-select-all]');
    const checkboxes = document.querySelectorAll('[data-quote-select]');

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const ids = [];
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                if (this.checked) ids.push(cb.dataset.quoteId);
            });
            document.dispatchEvent(new CustomEvent('quotes-select-all', {
                detail: { checked: this.checked, ids: ids }
            }));
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const selectedIds = [];
            checkboxes.forEach(c => {
                if (c.checked) selectedIds.push(c.dataset.quoteId);
            });

            if (selectAll) {
                selectAll.checked = selectedIds.length === checkboxes.length;
                selectAll.indeterminate = selectedIds.length > 0 && selectedIds.length < checkboxes.length;
            }

            document.dispatchEvent(new CustomEvent('quotes-selection-change', {
                detail: { selectedIds: selectedIds }
            }));
        });
    });
})();
</script>

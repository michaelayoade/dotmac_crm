{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import danger_button, warning_button %}
{% block title %}{{ campaign.name }} - Campaign - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb & Header -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/crm/inbox" class="hover:text-primary-600">CRM</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <a href="/admin/crm/campaigns" class="hover:text-primary-600">Campaigns</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">{{ campaign.name|truncate(40) }}</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ campaign.name }}</h1>
            <div class="mt-1 flex items-center gap-3">
                {% set status_colors = {
                    'draft': 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300',
                    'scheduled': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-500/20 dark:text-yellow-400',
                    'sending': 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400',
                    'sent': 'bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400',
                    'completed': 'bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400',
                    'cancelled': 'bg-red-100 text-red-700 dark:bg-red-500/20 dark:text-red-400',
                } %}
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold {{ status_colors.get(campaign.status.value, 'bg-slate-100 text-slate-600') }}">
                    {{ campaign.status.value|capitalize }}
                </span>
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold {{ 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400' if campaign.campaign_type.value == 'one_time' else 'bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-400' }}">
                    {{ campaign.campaign_type.value|replace('_', ' ')|title }}
                </span>
                <span class="text-sm text-slate-500 dark:text-slate-400">Created {{ campaign.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            {% if campaign.status.value == 'draft' %}
            <a href="/admin/crm/campaigns/{{ campaign.id }}/edit"
               class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200">Edit</a>
            <a href="/admin/crm/campaigns/{{ campaign.id }}/preview"
               class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200">Preview</a>
            {{ warning_button("Send Now", "Confirm Send", "Send this campaign now?", "/admin/crm/campaigns/" ~ campaign.id ~ "/send", size="sm") }}
            {% endif %}
            {% if campaign.status.value == 'draft' %}
            <form method="post" action="/admin/crm/campaigns/{{ campaign.id }}/schedule" class="inline-flex items-center gap-2">
                <input type="datetime-local" name="scheduled_at" required
                       class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <button type="submit" class="rounded-lg border border-yellow-300 bg-yellow-50 px-3 py-2 text-sm font-medium text-yellow-700 hover:bg-yellow-100 dark:border-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400">Schedule</button>
            </form>
            {% endif %}
            {% if campaign.status.value in ['scheduled', 'sending'] %}
            {{ warning_button("Cancel", "Confirm Cancel", "Cancel this campaign?", "/admin/crm/campaigns/" ~ campaign.id ~ "/cancel", size="sm") }}
            {% endif %}
            {% if campaign.status.value == 'draft' %}
            {{ danger_button("Delete", "Confirm Delete", "Delete this campaign?", "/admin/crm/campaigns/" ~ campaign.id ~ "/delete", size="sm") }}
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-6">
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Recipients</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{{ stats.total_recipients }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Sent</p>
            <p class="mt-1 text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.sent_count }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Delivered</p>
            <p class="mt-1 text-2xl font-bold text-green-600 dark:text-green-400">{{ stats.delivered_count }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Failed</p>
            <p class="mt-1 text-2xl font-bold text-red-600 dark:text-red-400">{{ stats.failed_count }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Opened</p>
            <p class="mt-1 text-2xl font-bold text-purple-600 dark:text-purple-400">{{ stats.opened_count }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Clicked</p>
            <p class="mt-1 text-2xl font-bold text-amber-600 dark:text-amber-400">{{ stats.clicked_count }}</p>
        </div>
    </div>

    <!-- Campaign Info -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Email Details</h2>
            <dl class="space-y-3">
                <div>
                    <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Subject</dt>
                    <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ campaign.subject or '(not set)' }}</dd>
                </div>
                <div>
                    <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">From</dt>
                    <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ campaign.from_name or '' }} {{ '<' ~ campaign.from_email ~ '>' if campaign.from_email else '(not set)' }}</dd>
                </div>
                {% if campaign.reply_to %}
                <div>
                    <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Reply-To</dt>
                    <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ campaign.reply_to }}</dd>
                </div>
                {% endif %}
                {% if campaign.scheduled_at %}
                <div>
                    <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Scheduled</dt>
                    <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ campaign.scheduled_at.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>

        <!-- Audience Preview -->
        <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Audience</h2>
            {% if campaign.status.value == 'draft' %}
            <div hx-get="/admin/crm/campaigns/{{ campaign.id }}/preview-audience"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <p class="text-sm text-slate-500 dark:text-slate-400">Loading audience preview...</p>
            </div>
            {% else %}
            <p class="text-sm text-slate-600 dark:text-slate-300">{{ campaign.total_recipients }} recipients targeted.</p>
            {% endif %}
        </div>
    </div>

    <!-- Nurture Steps (for nurture campaigns) -->
    {% if campaign.campaign_type.value == 'nurture' %}
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Nurture Steps</h2>
        </div>
        <div hx-get="/admin/crm/campaigns/{{ campaign.id }}/steps"
             hx-trigger="load"
             hx-swap="innerHTML">
            <p class="text-sm text-slate-500 dark:text-slate-400">Loading steps...</p>
        </div>
    </div>
    {% endif %}

    <!-- Recipients Table -->
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Recipients</h2>
        </div>
        <div hx-get="/admin/crm/campaigns/{{ campaign.id }}/recipients"
             hx-trigger="load"
             hx-swap="innerHTML">
            <p class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">Loading recipients...</p>
        </div>
    </div>
</div>
{% endblock %}

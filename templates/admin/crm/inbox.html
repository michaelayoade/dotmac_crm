{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import submit_button %}
{% block title %}Inbox - Admin{% endblock %}

{% block head %}
<script src="/static/js/inbox-websocket.js"></script>
<script>
    // Disable view transitions for inbox to prevent refresh flicker
    document.addEventListener('DOMContentLoaded', function() {
        htmx.config.globalViewTransitions = false;
    });
</script>
<!-- Inbox styles are now in static/css/src/main.css -->
{% endblock %}

{% block content_container_class %}max-w-none px-0 py-0 h-full{% endblock %}

{% block content %}
<div x-data="inboxController()"
     x-init="init()"
     x-effect="updateNewConversationTarget()"
     x-on:toggle-contact-panel.window="toggleContactPanel()"
     x-on:show-contact-panel.window="showContactPanel = true"
     x-on:conversation-read.window="if (typeof stats?.unread === 'number' && stats.unread > 0) { stats.unread -= 1 }"
     class="flex h-[calc(100vh-4rem)] min-h-0 w-full overflow-hidden rounded-2xl border border-slate-200/60 bg-white font-editorial shadow-sm dark:border-slate-700/60 dark:bg-slate-900">

    {% if reply_error %}
    <div x-data="{ showReplyToast: true }"
         x-show="showReplyToast"
         class="pointer-events-auto fixed right-6 top-6 z-50 w-[22rem] rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 shadow-lg dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        <div class="flex items-start gap-2">
            <svg class="mt-0.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="flex-1">
                <div class="font-semibold">Reply failed</div>
                {% if reply_error_detail %}
                <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ reply_error_detail }}</div>
                {% else %}
                <div class="mt-1 text-xs text-red-600 dark:text-red-300">Meta rejected the outbound message.</div>
                {% endif %}
            </div>
            <button type="button"
                    @click="showReplyToast = false"
                    class="ml-1 inline-flex h-6 w-6 items-center justify-center rounded-md text-red-500 hover:bg-red-100 hover:text-red-700 dark:text-red-300 dark:hover:bg-red-900/30"
                    aria-label="Dismiss">
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>
    {% endif %}

    <div class="pointer-events-none fixed bottom-6 right-6 z-50 flex w-[22rem] flex-col gap-3">
        <template x-for="notification in notifications" :key="notification.id">
            <div class="pointer-events-auto group relative overflow-hidden rounded-2xl border border-slate-200/70 bg-white/95 p-4 shadow-xl shadow-slate-900/10 backdrop-blur transition hover:-translate-y-0.5 hover:border-amber-200 dark:border-slate-700/60 dark:bg-slate-900/90 dark:hover:border-amber-500/40">
                <div class="absolute left-0 top-0 h-full w-1.5"
                     :class="notification.kind === 'reminder' ? 'bg-gradient-to-b from-amber-500 to-orange-500' : 'bg-gradient-to-b from-emerald-500 to-teal-500'"></div>
                <div class="flex items-start gap-3 pl-2.5">
                    <div class="mt-0.5 flex h-9 w-9 items-center justify-center rounded-xl bg-slate-900/5 text-slate-600 dark:bg-white/10 dark:text-slate-200"
                         :class="notification.kind === 'reminder' ? 'text-amber-600 dark:text-amber-300' : 'text-emerald-600 dark:text-emerald-300'">
                        <svg class="h-4.5 w-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path x-show="notification.kind === 'reminder'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            <path x-show="notification.kind !== 'reminder'" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-6 4h4m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="flex-1 cursor-pointer"
                         @click="openNotification(notification)">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <div class="text-sm font-semibold text-slate-900 dark:text-white" x-text="notification.title"></div>
                                <div class="text-xs text-slate-500 dark:text-slate-400" x-text="notification.subtitle || 'Assigned conversation'"></div>
                            </div>
                            <div class="text-[10px] uppercase tracking-wide text-slate-400 dark:text-slate-400" x-text="notification.timeLabel"></div>
                        </div>
                        <p class="mt-2 text-xs text-slate-600 line-clamp-2 dark:text-slate-300" x-text="notification.preview || 'New message received.'"></p>
                        <div class="mt-3 inline-flex items-center gap-1 text-xs font-semibold text-amber-600 group-hover:gap-2 transition-all dark:text-amber-300">
                            Open & reply
                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                    <button type="button"
                            @click.prevent.stop="dismissNotification(notification.id)"
                            class="relative z-10 ml-1 inline-flex h-7 w-7 items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
                            aria-label="Dismiss notification">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Left Sidebar - Channel Filters & Conversation List -->
    <aside class="w-full flex-shrink-0 flex flex-col border-r border-slate-200/60 bg-slate-50/50 dark:border-slate-700/60 dark:bg-slate-900/60"
           :class="selectedConversation && isNarrowViewport ? 'hidden' : 'flex'"
           :style="isNarrowViewport ? '' : 'width: 20rem;'">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-700/60">
            <div class="flex items-center gap-3">
                <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25">
                    <svg class="w-5.5 h-5.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 tracking-tight dark:text-white">Inbox</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                        <span class="font-semibold text-amber-600 dark:text-amber-400" x-text="stats.unread">{{ stats.unread }}</span> unread conversations
                        <span x-show="wsConnected"
                              class="ml-2 inline-flex items-center gap-1 text-emerald-600 dark:text-emerald-400"
                              title="Real-time updates active">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[10px] uppercase tracking-wide font-medium">Live</span>
                        </span>
                        <span x-show="wsDisconnectedPermanently" x-cloak
                              class="ml-2 inline-flex items-center gap-1 text-red-500 dark:text-red-400"
                              title="Real-time updates offline — refresh to reconnect">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                            <span class="text-[10px] uppercase tracking-wide font-medium">Offline</span>
                        </span>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button type="button" @click="showNewConversation = true"
                        class="flex h-9 w-9 items-center justify-center rounded-lg text-slate-500 hover:text-amber-600 hover:bg-amber-50 transition-colors dark:text-slate-400 dark:hover:text-amber-400 dark:hover:bg-amber-500/10"
                        title="New conversation">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7H5"/>
                    </svg>
                </button>
                <button type="button"
                        @click="toggleNotificationSound()"
                        :class="notificationSoundEnabled ? 'text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 dark:text-emerald-400 dark:hover:text-emerald-300 dark:hover:bg-emerald-500/10' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800'"
                        class="flex h-9 w-9 items-center justify-center rounded-lg transition-colors"
                        :aria-label="notificationSoundEnabled ? 'Mute notification sound' : 'Enable notification sound'"
                        title="Toggle notification sound">
                    <svg x-show="notificationSoundEnabled" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H3v6h3l5 4V5z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.5 8.5a5 5 0 010 7"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6a8 8 0 010 12"/>
                    </svg>
                    <svg x-show="!notificationSoundEnabled" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H3v6h3l5 4V5z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6l-12 12"/>
                    </svg>
                </button>
                <a href="/admin/crm/inbox/settings"
                   class="flex h-9 w-9 items-center justify-center rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800"
                   title="Inbox settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.370.996-.608.07 2.296-1.065 2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.370-2.370.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </a>
            </div>
        </div>

        <!-- Search -->
        <div class="px-4 py-3">
            <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3.5">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <input type="text"
                       name="search"
                       data-search-input="true"
                       placeholder="Search conversations..."
                       x-model="searchQuery"
                       @keydown="markSearchInteracted($event)"
                       @paste="markSearchInteracted()"
                       @drop="markSearchInteracted()"
                       @input.debounce.300ms="filterConversations({ fromInput: true })"
                       autocomplete="new-password"
                       data-lpignore="true"
                       data-1p-ignore="true"
                       autocapitalize="off"
                       autocorrect="off"
                       spellcheck="false"
                       class="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-900 placeholder-slate-400 transition-all focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 dark:bg-slate-800/50 dark:border-slate-600 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
            </div>
        </div>

        {# <!-- Channel Filters (disabled) -->
        <div class="px-4 pb-3">
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-thin">
                <button @click="setChannel(null)"
                        :class="!currentChannel ? 'bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md shadow-amber-500/20' : 'bg-white text-slate-600 border border-slate-200 hover:border-amber-300 hover:text-amber-600 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-amber-500/50 dark:hover:text-amber-400'"
                        class="flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <span>All</span>
                    <span class="font-mono-tight opacity-80">{{ stats.all }}</span>
                </button>
                <button @click="setChannel('email')"
                        :class="currentChannel === 'email' ? 'channel-badge channel-email' : 'bg-white text-slate-600 border border-slate-200 hover:border-violet-300 hover:text-violet-600 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-violet-500/50 dark:hover:text-violet-400'"
                        class="channel-email flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <span>Email</span>
                    <span class="font-mono-tight opacity-70">{{ channel_stats.email }}</span>
                </button>
                <button @click="setChannel('whatsapp')"
                        :class="currentChannel === 'whatsapp' ? 'channel-badge channel-whatsapp' : 'bg-white text-slate-600 border border-slate-200 hover:border-green-300 hover:text-green-600 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-green-500/50 dark:hover:text-green-400'"
                        class="channel-whatsapp flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    <span>WhatsApp</span>
                    <span class="font-mono-tight opacity-70">{{ channel_stats.whatsapp }}</span>
                </button>
                <button @click="setChannel('facebook_messenger')"
                        :class="currentChannel === 'facebook_messenger' ? 'channel-badge channel-facebook_messenger' : 'bg-white text-slate-600 border border-slate-200 hover:border-blue-300 hover:text-blue-600 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-blue-500/50 dark:hover:text-blue-400'"
                        class="channel-facebook_messenger flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    <span>Facebook</span>
                    <span class="font-mono-tight opacity-70">{{ channel_stats.facebook_messenger }}</span>
                </button>
                <button @click="setChannel('instagram_dm')"
                        :class="currentChannel === 'instagram_dm' ? 'channel-badge channel-instagram_dm' : 'bg-white text-slate-600 border border-slate-200 hover:border-pink-300 hover:text-pink-600 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-pink-500/50 dark:hover:text-pink-400'"
                        class="channel-instagram_dm flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03z"/>
                    </svg>
                    <span>Instagram</span>
                    <span class="font-mono-tight opacity-70">{{ channel_stats.instagram_dm }}</span>
                </button>
                <button @click="setChannel('comments')"
                        :class="currentChannel === 'comments' ? 'channel-badge channel-facebook_messenger' : 'bg-white text-slate-600 border border-slate-200 hover:border-slate-300 hover:text-slate-900 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:border-slate-500 dark:hover:text-slate-200'"
                        class="flex items-center gap-1.5 px-3.5 py-2 rounded-xl text-xs font-semibold transition-all whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-6 4h8M5 20h8l6-6V5a2 2 0 00-2-2H5a2 2 0 00-2 2v13a2 2 0 002 2z"/>
                    </svg>
                    <span>Comments</span>
                    <span class="font-mono-tight opacity-70">{{ channel_stats.comments }}</span>
                </button>
            </div>
        </div>
        #}

        <!-- Status Tabs -->
        {% if current_channel != 'comments' %}
        <div class="px-4 pb-3 border-b border-slate-200/60 dark:border-slate-700/60">
            <div class="flex gap-1 p-1 bg-slate-100 rounded-xl dark:bg-slate-800/50">
                <button @click="setStatus(null)"
                        :class="!currentStatus ? 'bg-white text-amber-700 shadow-sm dark:bg-slate-700 dark:text-amber-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                        class="flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all">
                    All
                </button>
                <button @click="setStatus('open')"
                        :class="currentStatus === 'open' ? 'bg-white text-emerald-700 shadow-sm dark:bg-slate-700 dark:text-emerald-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                        class="flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 status-dot"></span>
                    Open
                </button>
                <button @click="setStatus('pending')"
                        :class="currentStatus === 'pending' ? 'bg-white text-amber-700 shadow-sm dark:bg-slate-700 dark:text-amber-400' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                        class="flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                    Pending
                </button>
                <button @click="setStatus('resolved')"
                        :class="currentStatus === 'resolved' ? 'bg-white text-slate-700 shadow-sm dark:bg-slate-700 dark:text-slate-300' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                        class="flex-1 px-3 py-2 rounded-lg text-xs font-semibold transition-all">
                    Done
                </button>
            </div>
        </div>
        {% endif %}

        <div class="px-4 pb-3 border-b border-slate-200/60 dark:border-slate-700/60">
            <div class="flex flex-col gap-2">
                {% if current_channel != 'comments' %}
                <div class="flex gap-1 p-1 bg-slate-100 rounded-xl dark:bg-slate-800/50">
                    <button @click="setAssignment(null)"
                            :class="!currentAssignment ? 'bg-white text-slate-700 shadow-sm dark:bg-slate-700 dark:text-slate-200' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                            class="flex-1 px-3 py-2 rounded-lg text-[11px] font-semibold transition-all">
                        All
                    </button>
                    <button @click="setAssignment('assigned')"
                            :class="currentAssignment === 'assigned' ? 'bg-white text-emerald-700 shadow-sm dark:bg-slate-700 dark:text-emerald-300' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                            class="flex-1 px-3 py-2 rounded-lg text-[11px] font-semibold transition-all">
                        Assigned to me
                    </button>
                    <button @click="setAssignment('my_team')"
                            :class="currentAssignment === 'my_team' ? 'bg-white text-cyan-700 shadow-sm dark:bg-slate-700 dark:text-cyan-300' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                            class="flex-1 px-3 py-2 rounded-lg text-[11px] font-semibold transition-all">
                        My Team
                    </button>
                    <button @click="setAssignment('unassigned')"
                            :class="currentAssignment === 'unassigned' ? 'bg-white text-amber-700 shadow-sm dark:bg-slate-700 dark:text-amber-300' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                            class="flex-1 px-3 py-2 rounded-lg text-[11px] font-semibold transition-all">
                        Unassigned
                    </button>
                </div>
                {% endif %}

                <div class="flex items-center gap-2" x-show="availableInboxes(currentChannel).length">
                    <span class="text-[11px] font-semibold text-slate-500 dark:text-slate-400">Inbox</span>
                    <select x-model="currentInboxTargetId"
                            @change="filterConversations()"
                            class="flex-1 rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-[11px] font-semibold text-slate-700 shadow-sm focus:border-amber-500 focus:outline-none dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">
                        <option value="">All inboxes</option>
                        <template x-for="inbox in availableInboxes(currentChannel)" :key="inbox.target_id">
                            <option :value="inbox.target_id"
                                    x-text="formatInboxOption(inbox)"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>

        <div class="px-4 py-2 border-b border-slate-200/60 dark:border-slate-700/60"
             x-show="listStale"
             x-transition
             x-cloak>
            <div class="flex items-center justify-between rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs font-semibold text-amber-800 dark:border-amber-800/60 dark:bg-amber-900/30 dark:text-amber-200">
                <span>New activity in the inbox.</span>
                <button @click="acknowledgeListStale()"
                        class="rounded-md bg-amber-600 px-2.5 py-1 text-[11px] font-semibold text-white hover:bg-amber-700">
                    Refresh list
                </button>
            </div>
        </div>

        <!-- Conversation List -->
        <div id="conversation-list" class="flex-1 overflow-y-auto inbox-scroll">
            {% if current_channel == 'comments' %}
                {% include "admin/crm/_comment_list.html" %}
            {% else %}
                {% include "admin/crm/_conversation_list.html" %}
            {% endif %}
        </div>
    </aside>

    <!-- Center - Message Thread -->
    <main class="flex-1 flex flex-col min-w-0 min-h-0 bg-white dark:bg-slate-950 inbox-mesh"
          :class="!selectedConversation && !selectedCommentId && isNarrowViewport ? 'hidden' : 'flex'">
        <div class="px-6 pt-4"
             x-show="threadStale && selectedConversation"
             x-transition
             x-cloak>
            <div class="flex items-center justify-between rounded-lg border border-cyan-200 bg-cyan-50 px-3 py-2 text-xs font-semibold text-cyan-800 dark:border-cyan-800/60 dark:bg-cyan-900/30 dark:text-cyan-200">
                <span>New messages available.</span>
                <button @click="acknowledgeThreadStale()"
                        class="rounded-md bg-cyan-600 px-2.5 py-1 text-[11px] font-semibold text-white hover:bg-cyan-700">
                    Refresh thread
                </button>
            </div>
        </div>
        <div id="message-thread" class="flex-1 flex flex-col min-h-0">
            {% if current_channel == 'comments' %}
                {% include "admin/crm/_comment_thread.html" %}
            {% elif selected_comment %}
                {% include "admin/crm/_comment_thread.html" %}
            {% elif selected_conversation %}
                {% with conversation=selected_conversation, messages=messages %}
                    {% include "admin/crm/_message_thread.html" %}
                {% endwith %}
            {% else %}
                <!-- Empty State -->
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center px-8 animate-fade-in-up">
                        <div class="relative mx-auto mb-6">
                            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-200/60 flex items-center justify-center dark:from-slate-800 dark:to-slate-900 dark:border-slate-700/50">
                                <svg class="w-10 h-10 text-slate-400 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                            </div>
                            <div class="absolute -right-2 -top-2 h-6 w-6 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center shadow-lg shadow-amber-500/25">
                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2 dark:text-white">Select a conversation</h3>
                        <p class="text-slate-500 text-sm max-w-xs mx-auto dark:text-slate-400">Choose a conversation from the list to view messages and respond to your customers.</p>
                        <button @click="showNewConversation = true" class="mt-6 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 transition-all hover:shadow-xl hover:shadow-amber-500/30 hover:-translate-y-0.5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7H5"/></svg>
                            New Conversation
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- Right Sidebar - Contact Details -->
    <aside class="hidden lg:block w-80 flex-shrink-0 border-l border-slate-200/60 bg-slate-50/50 overflow-y-auto inbox-scroll dark:border-slate-700/60 dark:bg-slate-900/40"
           x-show="showContactPanel"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-x-4"
           x-transition:enter-end="opacity-100 translate-x-0"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100 translate-x-0"
           x-transition:leave-end="opacity-0 translate-x-4">
        <div id="contact-details">
            {% if contact_details %}
                {% with contact=contact_details, conversation_id=(selected_conversation.id if selected_conversation else None) %}
                    {% include "admin/crm/_contact_details.html" %}
                {% endwith %}
            {% endif %}
        </div>
    </aside>

    <!-- New conversation modal -->
    <div x-cloak
         x-show="showNewConversation"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="showNewConversation = false"
         class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 backdrop-blur-sm px-4 py-8">
        <div @click.stop
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             class="w-full max-w-2xl rounded-2xl border border-slate-200/60 bg-white p-6 shadow-2xl dark:border-slate-700/60 dark:bg-slate-900">
            <div class="flex items-start justify-between">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7H5"/></svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Start a new conversation</h2>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Send the first message across any channel.</p>
                    </div>
                </div>
                <button @click="showNewConversation = false"
                        class="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors dark:hover:bg-slate-800 dark:hover:text-slate-200">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            {% if new_error %}
            <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 dark:border-red-500/30 dark:bg-red-500/10">
                <div class="flex items-center gap-2 text-sm font-medium text-red-700 dark:text-red-300">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Could not start the conversation.
                </div>
                {% if new_error_detail %}
                <div class="mt-1 text-xs text-red-600 dark:text-red-400">{{ new_error_detail }}</div>
                {% endif %}
            </div>
            {% endif %}

            <form method="POST"
                  action="/admin/crm/inbox/conversation/new"
                  enctype="multipart/form-data"
                  class="mt-6 space-y-4">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                <div class="grid gap-4 sm:grid-cols-2">
                    <div>
                        <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Channel</label>
                        <select name="channel_type"
                                x-model="newConversationChannel"
                                class="block w-full appearance-none rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                            <option value="email">Email</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="facebook_messenger">Facebook</option>
                            <option value="instagram_dm">Instagram</option>
                        </select>
                    </div>
                    <template x-if="availableInboxes(newConversationChannel).length > 1">
                        <div>
                            <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                                   x-text="newConversationChannel === 'email' ? 'Email inbox' : 'WhatsApp inbox'"></label>
                            <select name="channel_target_id"
                                    x-model="newConversationTargetId"
                                    class="block w-full appearance-none rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                                <template x-for="inbox in availableInboxes(newConversationChannel)" :key="inbox.target_id">
                                    <option :value="inbox.target_id" x-text="inbox.name || 'Inbox'"></option>
                                </template>
                            </select>
                        </div>
                    </template>
                    <div x-show="newConversationChannel !== 'whatsapp'">
                        <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Contact name</label>
                        <input name="contact_name"
                               x-model="newConversationContactName"
                               placeholder="e.g. Ola Adebayo"
                               class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
                    </div>
                    <div x-show="newConversationChannel === 'whatsapp'" class="sm:col-span-2">
                        <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Contact</label>
                        <div class="relative">
                            <input type="text"
                                   x-model="whatsappContactQuery"
                                   @input="searchWhatsappContacts()"
                                   placeholder="Search contact by name or number"
                                   class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
                            <template x-if="whatsappContactLoading">
                                <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-slate-400">Searching…</div>
                            </template>
                            <div x-show="whatsappContactResults.length"
                                 class="absolute z-50 mt-2 w-full rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-900">
                                <template x-for="contact in whatsappContactResults" :key="contact.id">
                                    <button type="button"
                                            @click="selectWhatsappContact(contact)"
                                            class="flex w-full items-center justify-between px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-800">
                                        <span x-text="contact.name"></span>
                                        <span class="text-xs text-slate-400" x-text="contact.whatsapp_address"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                        <template x-if="whatsappContactError">
                            <p class="mt-1 text-xs text-red-600 dark:text-red-400" x-text="whatsappContactError"></p>
                        </template>
                        <template x-if="selectedWhatsappContact">
                            <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                                Selected: <span class="font-semibold text-slate-700 dark:text-slate-200" x-text="selectedWhatsappContact.name"></span>
                                · <span x-text="selectedWhatsappContact.whatsapp_address"></span>
                            </div>
                        </template>
                        <input type="hidden" name="contact_id" :value="selectedWhatsappContact ? selectedWhatsappContact.id : ''">
                        <input type="hidden" name="contact_name" :value="selectedWhatsappContact ? selectedWhatsappContact.name : ''">
                    </div>
                </div>

                <div>
                        <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                               x-text="newConversationChannel === 'email' ? 'Recipient email' : (newConversationChannel === 'whatsapp' ? 'WhatsApp number' : 'Recipient ID')"></label>
                    <input name="contact_address"
                           x-model="newConversationContactAddress"
                           x-bind:type="newConversationChannel === 'email' ? 'email' : 'text'"
                           placeholder="Enter address"
                           :readonly="newConversationChannel === 'whatsapp'"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
                </div>

                <div x-show="newConversationChannel === 'whatsapp'">
                    <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">WhatsApp template</label>
                    <div class="relative">
                        <select x-model="selectedWhatsappTemplateKey"
                                @change="applyWhatsappTemplate()"
                                class="block w-full appearance-none rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                            <option value="">Select template</option>
                            <template x-for="tmpl in whatsappTemplates" :key="tmpl.name + '::' + tmpl.language">
                                <option :value="tmpl.name + '::' + tmpl.language"
                                        x-text="`${tmpl.name} · ${tmpl.language}`"></option>
                            </template>
                        </select>
                        <template x-if="whatsappTemplatesLoading">
                            <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-slate-400">Loading…</div>
                        </template>
                    </div>
                    <template x-if="whatsappTemplateHeader">
                        <div class="mt-3">
                            <template x-if="whatsappTemplateHeader.format === 'TEXT'">
                                <div class="grid gap-2">
                                    <template x-for="param in whatsappTemplateHeader.params" :key="`header-${param}`">
                                        <div>
                                            <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                                                   x-text="`Header ${param}`"></label>
                                            <input type="text"
                                                   x-model="whatsappTemplateHeaderValues[param]"
                                                   @input="applyWhatsappTemplateParameters()"
                                                   required
                                                   class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="whatsappTemplateHeader.format && whatsappTemplateHeader.format !== 'TEXT'">
                                <div>
                                    <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                                           x-text="`Header ${whatsappTemplateHeader.format} URL`"></label>
                                    <input type="url"
                                           x-model="whatsappTemplateHeaderMediaUrl"
                                           @input="applyWhatsappTemplateParameters()"
                                           required
                                           placeholder="https://..."
                                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="whatsappTemplateParams.length">
                        <div class="mt-3 grid gap-2">
                            <template x-for="param in whatsappTemplateParams" :key="param">
                                <div>
                                    <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                                           x-text="`Parameter ${param}`"></label>
                                    <input type="text"
                                           x-model="whatsappTemplateParamValues[param]"
                                           @input="applyWhatsappTemplateParameters()"
                                           required
                                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="whatsappTemplateButtons.length">
                        <div class="mt-3 grid gap-2">
                            <template x-for="btn in whatsappTemplateButtons" :key="`button-${btn.index}`">
                                <div>
                                    <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"
                                           x-text="`Button ${btn.index + 1} URL param`"></label>
                                    <input type="text"
                                           x-model="whatsappTemplateButtonValues[btn.index]"
                                           @input="applyWhatsappTemplateParameters()"
                                           required
                                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:border-amber-500">
                                </div>
                            </template>
                        </div>
                    </template>
                    <input type="hidden" name="whatsapp_template_name" :value="selectedWhatsappTemplateName">
                    <input type="hidden" name="whatsapp_template_language" :value="selectedWhatsappTemplateLanguage">
                    <input type="hidden" name="whatsapp_template_components" :value="whatsappTemplateComponentsJson">
                    <template x-if="whatsappTemplateError">
                        <p class="mt-1 text-xs text-red-600 dark:text-red-400" x-text="whatsappTemplateError"></p>
                    </template>
                </div>

                <div x-show="newConversationChannel === 'email'">
                    <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Subject</label>
                    <input name="subject"
                           placeholder="Subject"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
                </div>

                <div x-show="newConversationChannel === 'email'">
                    <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">CC</label>
                    <input name="cc_addresses"
                           type="text"
                           placeholder="name@company.com, another@company.com"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500">
                </div>

                <div>
                    <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Message</label>
                    <textarea name="message"
                              x-ref="newConversationMessage"
                              rows="4"
                              placeholder="Write your message..."
                              :readonly="newConversationChannel === 'whatsapp' && selectedWhatsappTemplateName"
                              class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 transition-all focus:border-amber-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500 dark:focus:border-amber-500"></textarea>
                </div>

                <div data-new-conversation-attachments
                     class="rounded-xl border border-slate-200/80 bg-slate-50/60 px-3 py-2 dark:border-slate-700/60 dark:bg-slate-800/40">
                    <div class="flex items-center justify-between gap-3">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
                            Attachments
                        </p>
                        <button type="button"
                                onclick="const root=this.closest('[data-new-conversation-attachments]'); const i=root ? root.querySelector('input[type=file][name=attachments]') : null; if(i){i.click();}"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                            Attach file
                        </button>
                    </div>
                    <input type="file"
                           name="attachments"
                           multiple
                           accept="image/jpeg,image/png,image/gif,image/webp,application/pdf"
                           class="hidden">
                    <p data-attachments-selected
                       class="mt-1 text-[11px] text-slate-500 dark:text-slate-400"></p>
                </div>

                <div class="flex items-center justify-end gap-3 pt-2">
                    <button type="button"
                            @click="showNewConversation = false"
                            class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 shadow-sm transition-all hover:bg-slate-50 hover:border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600">
                        Cancel
                    </button>
                    {{ submit_button("Start conversation", color="amber", loading_label="Starting...") }}
                </div>
            </form>
        </div>
    </div>

    <!-- Right panel (split view) -->
    <aside class="hidden lg:block w-[30rem] flex-shrink-0 border-l border-slate-200/60 bg-white overflow-y-auto inbox-scroll dark:border-slate-700/60 dark:bg-slate-950"
           x-cloak
           x-show="sidePanel"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 translate-x-4"
           x-transition:enter-end="opacity-100 translate-x-0"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100 translate-x-0"
           x-transition:leave-end="opacity-0 translate-x-4">
        <div class="flex items-center justify-between border-b border-slate-200 px-5 py-4 dark:border-slate-700">
            <div>
                <h3 class="text-sm font-semibold text-slate-900 dark:text-white"
                    x-text="sidePanel === 'ticket' ? 'Create Ticket' : 'Create Service Order'"></h3>
                <p class="text-xs text-slate-500 dark:text-slate-400"
                   x-text="sidePanel === 'ticket' ? 'Keep the inbox visible for reference.' : 'Provision service without leaving the inbox.'"></p>
            </div>
            <button type="button"
                    @click="closeSidePanel()"
                    class="flex h-8 w-8 items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:hover:bg-slate-800 dark:hover:text-slate-200"
                    aria-label="Close panel">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="p-5">
            <div x-show="sidePanel === 'ticket'"
                 id="ticket-create-panel-body"
                 class="text-sm text-slate-500">
                Loading ticket form...
            </div>
        </div>
        <div class="flex items-center justify-end gap-3 border-t border-slate-200 px-5 py-4 dark:border-slate-700">
            <button type="button"
                    @click="closeSidePanel()"
                    class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
                Cancel
            </button>
            <button x-show="sidePanel === 'ticket'"
                    type="button"
                    :disabled="!ticketFormLoaded"
                    @click="submitTicketForm()"
                    :class="!ticketFormLoaded ? 'opacity-60 cursor-not-allowed' : ''"
                    class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900">
                Create Ticket
            </button>
        </div>
    </aside>
</div>

<script>
function inboxController() {
    return {
        searchQuery: {{ (search or "") | tojson }},
        currentChannel: {{ current_channel | tojson }},
        currentStatus: {{ current_status | tojson }},
        currentOutboxStatus: {{ (current_outbox_status or "") | tojson }} || null,
        currentAssignment: {{ (current_assignment or "") | tojson }} || null,
        currentInboxTargetId: {{ (current_target_id or "") | tojson }} || null,
        selectedConversation: {{ (selected_conversation.id if selected_conversation else None) | tojson }},
        selectedContactId: {{ (selected_conversation.contact.id if selected_conversation else None) | tojson }},
        selectedCommentId: {{ ((selected_comment.id | string) if selected_comment else None) | tojson }},
        paginationLimit: {{ (pagination_limit or 150) | tojson }},
        stats: {{ (stats or {}) | tojson }},
        showContactPanel: false,
        sidePanel: null,
        showNewConversation: {{ (new_error is not none) | tojson }},
        newConversationChannel: 'email',
        newConversationTargetId: null,
        newConversationContactName: '',
        newConversationContactAddress: '',
        emailInboxes: {{ (email_inboxes or []) | tojson }},
        whatsappInboxes: {{ (whatsapp_inboxes or []) | tojson }},
        facebookInboxes: {{ (facebook_inboxes or []) | tojson }},
        instagramInboxes: {{ (instagram_inboxes or []) | tojson }},
        facebookCommentInboxes: {{ (facebook_comment_inboxes or []) | tojson }},
        instagramCommentInboxes: {{ (instagram_comment_inboxes or []) | tojson }},
        whatsappTemplates: [],
        whatsappTemplatesLoading: false,
        whatsappTemplateError: null,
        selectedWhatsappTemplateKey: '',
        selectedWhatsappTemplateName: '',
        selectedWhatsappTemplateLanguage: '',
        whatsappTemplateParams: [],
        whatsappTemplateParamValues: {},
        whatsappTemplateComponentsJson: '',
        whatsappTemplateHeader: null,
        whatsappTemplateHeaderValues: {},
        whatsappTemplateHeaderMediaUrl: '',
        whatsappTemplateButtons: [],
        whatsappTemplateButtonValues: {},
        whatsappContactQuery: '',
        whatsappContactResults: [],
        whatsappContactLoading: false,
        whatsappContactError: null,
        selectedWhatsappContact: null,
        _whatsappContactTimer: null,
        isTyping: false,
        typingConversationId: null,
        typingTimer: null,
        // Ticket form in the right-side panel is loaded via HTMX; don't allow submits until it's present.
        ticketFormLoaded: false,
        typingSendTimer: null,
        wsConnected: false,
        wsDisconnectedPermanently: false,
        inboxWs: null,
        refreshTimer: null,
        refreshDelayMs: 800,
        pendingThreadRefresh: false,
        listStale: false,
        threadStale: false,
        summaryQueue: new Map(),
        summaryFlushTimer: null,
        summaryFlushScheduled: false,
        maxSummaryFlushPerTick: 10,
        lastSummaryFlushAt: 0,
        minSummaryFlushIntervalMs: 200,
        pendingMessageAttachments: [],
        pendingPrivateAttachments: [],
        notifications: [],
        notificationAutoDismissSeconds: {{ (notification_auto_dismiss_seconds or 12) | tojson }},
        notificationSoundEnabled: true,
        notificationAudioContext: null,
        replyTo: null,
        searchInteracted: false,
        isNarrowViewport: false,
        _initialized: false,
        viewportMediaQuery: null,
        viewportListener: null,
        init() {
            // Guard against double initialization (Alpine Devtools can trigger this)
            if (this._initialized) {
                console.debug('[Inbox] Already initialized, skipping');
                return;
            }
            this._initialized = true;
            this.initializeSearchState();
            this.scheduleSearchAutofillGuard();
            this.initViewportMode();

            // Setup HTMX event listeners
            document.body.addEventListener('htmx:afterSwap', (e) => {
                if (e.detail.target.id === 'message-thread') {
                    this.scrollToBottom();
                    this.resizeEmailFrames();
                    this.initQuoteHandlers();
                    this.renderQuotePreview();
                    this.syncMessageAttachmentField();
                    this.isTyping = false;
                    this.typingConversationId = null;
                    this.threadStale = false;
                    this.restoreDraft(this.selectedConversation);
                    window.dispatchEvent(new CustomEvent('conversation-read'));
                }
                if (e.detail.target.id === 'conversation-list') {
                    this.storeConversationCache();
                    this.subscribeVisibleConversations();
                    // Re-apply selected highlight after list refresh
                    if (this.selectedConversation) {
                        const row = document.querySelector(
                            `[data-conversation-id="${this.selectedConversation}"]`
                        );
                        if (row) row.classList.add('active');
                    }
                }
                if (e.detail.target && e.detail.target.id === 'ticket-create-panel-body') {
                    this.ticketFormLoaded = !!document.getElementById('ticket-create-form');
                    const titleEl = document.querySelector('#ticket-create-panel-body input[name="title"]');
                    if (titleEl) {
                        // Defer slightly so the element is focusable after swap.
                        setTimeout(() => titleEl.focus(), 0);
                    }
                }
            });
            document.body.addEventListener('htmx:beforeRequest', (e) => {
                if (e.detail.target && e.detail.target.id === 'ticket-create-panel-body') {
                    this.ticketFormLoaded = false;
                    this.openTicketPanel();
                }
            });

            // Initialize WebSocket connection
            this.initWebSocket();
            this.initNotificationSound();
            this.updateNewConversationTarget();
            this.normalizeInboxTarget();
            this.resizeEmailFrames();
            this.initQuoteHandlers();

            // Keep HTML email iframes in sync with theme toggles (the iframe can't inherit `.dark`).
            if (!this._emailThemeObserver) {
                this._emailThemeObserver = new MutationObserver(() => this.resizeEmailFrames());
                this._emailThemeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
            }

            // Setup WebSocket event listeners
            window.addEventListener('inbox-new-message', (e) => {
                const payload = e.detail || {};
                const summary = payload.summary || payload;
                if (summary && summary.conversation_id) {
                    this.queueConversationSummary(summary);
                } else if (!this.updateConversationRow(summary)) {
                    this.refreshConversations();
                }
                if (payload.conversation_id && this.selectedConversation === payload.conversation_id) {
                    this.scheduleRefresh('thread');
                }
            });
            window.addEventListener('inbox-message-status', (e) => {
                const payload = e.detail || {};
                if (payload.conversation_id && this.selectedConversation === payload.conversation_id) {
                    this.scheduleRefresh('thread');
                }
            });
            window.addEventListener('inbox-conversation-updated', (e) => {
                const payload = e.detail || {};
                const summary = payload.summary || payload;
                if (summary && summary.conversation_id) {
                    this.queueConversationSummary(summary);
                } else if (!this.updateConversationRow(summary)) {
                    this.refreshConversations();
                }
            });
            window.addEventListener('inbox-conversation-summary', (e) => {
                const summary = e.detail || {};
                if (summary && summary.conversation_id) {
                    this.queueConversationSummary(summary);
                } else if (!this.updateConversationRow(summary)) {
                    this.refreshConversations();
                }
            });
            window.addEventListener('inbox-ws-connected', () => {
                this.wsConnected = true;
                this.wsDisconnectedPermanently = false;
                if (this.selectedConversation && this.inboxWs) {
                    this.inboxWs.subscribe(this.selectedConversation);
                }
                this.subscribeVisibleConversations();
            });
            window.addEventListener('inbox-ws-reconnected', () => {
                this.refreshConversations();
            });
            window.addEventListener('inbox-ws-disconnected', () => {
                this.wsConnected = false;
            });
            window.addEventListener('inbox-ws-max-retries', () => {
                this.wsDisconnectedPermanently = true;
            });
            window.addEventListener('inbox-agent-notification', (e) => {
                this.handleAgentNotification(e.detail);
            });
            window.addEventListener('inbox-user-typing', (e) => {
                const payload = e.detail || {};
                if (!payload.conversation_id) return;
                if (this.selectedConversation !== payload.conversation_id) return;
                if (payload.is_typing) {
                    this.isTyping = true;
                    this.typingConversationId = payload.conversation_id;
                    if (this.typingTimer) {
                        clearTimeout(this.typingTimer);
                    }
                    this.typingTimer = setTimeout(() => {
                        this.isTyping = false;
                        this.typingConversationId = null;
                    }, 2500);
                } else if (this.typingConversationId === payload.conversation_id) {
                    this.isTyping = false;
                    this.typingConversationId = null;
                }
            });
            window.addEventListener('inbox-list-refresh', () => {
                this.refreshConversations();
            });

            // Fallback polling when websocket is unavailable.
            setInterval(() => {
                if (!document.hidden) {
                    // Only poll when websocket is down to avoid redundant refreshes.
                    if (!this.wsConnected) {
                        this.autoRefresh();
                    }
                }
            }, 5000);

            this.restoreConversationCache();
            this.subscribeVisibleConversations();
            if (this.selectedConversation && this.currentChannel !== 'comments') {
                requestAnimationFrame(() => {
                    this.refreshThread(true);
                });
            }
        },
        initViewportMode() {
            this.viewportMediaQuery = window.matchMedia('(max-width: 639px)');
            const syncViewport = () => {
                this.isNarrowViewport = !!this.viewportMediaQuery && this.viewportMediaQuery.matches;
            };
            syncViewport();
            this.viewportListener = syncViewport;
            if (this.viewportMediaQuery.addEventListener) {
                this.viewportMediaQuery.addEventListener('change', syncViewport);
            } else if (this.viewportMediaQuery.addListener) {
                this.viewportMediaQuery.addListener(syncViewport);
            }
        },
        draftKey(conversationId) {
            if (!conversationId) return null;
            return `crm:inbox:draft:${conversationId}`;
        },
        storeDraft(conversationId, text) {
            const key = this.draftKey(conversationId);
            if (!key) return;
            try {
                localStorage.setItem(key, text || '');
            } catch (err) {
                console.log('[Inbox] draft store failed', err);
            }
        },
        clearDraft(conversationId) {
            const key = this.draftKey(conversationId);
            if (!key) return;
            try {
                localStorage.removeItem(key);
            } catch (err) {
                console.log('[Inbox] draft clear failed', err);
            }
        },
        restoreDraft(conversationId) {
            const key = this.draftKey(conversationId);
            if (!key) return;
            try {
                const draft = localStorage.getItem(key);
                if (!draft) return;
                const input = document.querySelector('#message-thread textarea[name="message"]');
                if (input && !input.value.trim()) {
                    input.value = draft;
                    input.dispatchEvent(new Event('input'));
                }
            } catch (err) {
                console.log('[Inbox] draft restore failed', err);
            }
        },
        sendTypingIndicator(conversationId) {
            if (!conversationId || !this.inboxWs) return;
            this.inboxWs.sendTyping(conversationId, true);
            if (this.typingSendTimer) {
                clearTimeout(this.typingSendTimer);
            }
            this.typingSendTimer = setTimeout(() => {
                this.inboxWs.sendTyping(conversationId, false);
            }, 2000);
        },
        initQuoteHandlers() {
            if (!this._quoteDelegated) {
                this._quoteDelegated = true;
                document.body.addEventListener('click', (event) => {
                    const btn = event.target?.closest?.('[data-quote-button]');
                    if (!btn) return;
                    this.setQuoteFromButton(btn);
                });
            }
            const clearBtn = document.querySelector('[data-clear-quote]');
            if (clearBtn && clearBtn.dataset.quoteBound !== '1') {
                clearBtn.dataset.quoteBound = '1';
                clearBtn.addEventListener('click', () => {
                    this.clearQuote();
                });
            }
        },
        setQuoteFromButton(btn) {
            if (!btn) return;
            const id = btn.dataset.quoteId || '';
            if (!id) return;
            const author = btn.dataset.quoteAuthor || 'Unknown';
            const content = (btn.dataset.quoteContent || '').trim();
            const sentAt = btn.dataset.quoteSentAt || null;
            this.replyTo = {
                id,
                author,
                content,
                sentAt
            };
            const replyInput = document.querySelector('input[name="reply_to_message_id"]');
            if (replyInput) {
                replyInput.value = id;
            }
            this.renderQuotePreview();
            const messageInput = document.querySelector('#message-thread textarea[name="message"]');
            if (messageInput) {
                messageInput.focus();
            }
        },
        renderQuotePreview() {
            const preview = document.getElementById('reply-preview');
            const authorEl = document.getElementById('reply-preview-author');
            const contentEl = document.getElementById('reply-preview-content');
            if (!preview || !authorEl || !contentEl) return;
            if (!this.replyTo) {
                preview.classList.add('hidden');
                authorEl.textContent = 'Unknown';
                contentEl.textContent = 'Attachment';
                return;
            }
            const previewContent = this.replyTo.content ? this.replyTo.content : 'Attachment';
            authorEl.textContent = this.replyTo.author || 'Unknown';
            contentEl.textContent = previewContent;
            preview.classList.remove('hidden');
        },
        clearQuote() {
            this.replyTo = null;
            const replyInput = document.querySelector('input[name="reply_to_message_id"]');
            if (replyInput) {
                replyInput.value = '';
            }
            this.renderQuotePreview();
        },
        resizeEmailFrames() {
            const frames = document.querySelectorAll('iframe.email-html-frame');
            const isDark = document.documentElement.classList.contains('dark');
            const lightCss = `
                :root{color-scheme:light;}
                html,body{background:transparent !important;}
                body{margin:0;padding:0;overflow:hidden;box-sizing:border-box;color:#0f172a !important;}
                img,table,td,th{max-width:100% !important;}
                table{width:100% !important;}
                body,body *{background-color:transparent !important;color:inherit !important;}
                a,a *{color:#2563eb !important;}
            `;
            const darkCss = `
                :root{color-scheme:dark;}
                html,body{background:transparent !important;}
                body{margin:0;padding:0;overflow:hidden;box-sizing:border-box;color:#e2e8f0 !important;}
                img,table,td,th{max-width:100% !important;}
                table{width:100% !important;}
                body,body *{background-color:transparent !important;color:inherit !important;border-color:rgba(148,163,184,0.25) !important;}
                a,a *{color:#93c5fd !important;}
            `;
            frames.forEach((frame) => {
                const resize = () => {
                    try {
                        const doc = frame.contentDocument || frame.contentWindow?.document;
                        if (!doc) return;
                        const body = doc.body;
                        const html = doc.documentElement;
                        if (!body || !html) return;
                        // Theme the iframe content to match the app's light/dark toggle.
                        const mount = doc.head || html;
                        let styleEl = doc.getElementById('__dm_email_theme');
                        if (!styleEl) {
                            styleEl = doc.createElement('style');
                            styleEl.id = '__dm_email_theme';
                            mount.appendChild(styleEl);
                        }
                        styleEl.textContent = isDark ? darkCss : lightCss;
                        body.style.margin = '0';
                        body.style.padding = '0';
                        body.style.overflow = 'hidden';
                        html.style.overflow = 'hidden';
                        html.style.width = '100%';
                        const height = Math.max(
                            body.scrollHeight,
                            body.offsetHeight,
                            html.scrollHeight,
                            html.offsetHeight
                        );
                        if (height > 0) {
                            frame.style.height = '0px';
                            frame.style.height = `${height}px`;
                            frame.style.overflow = 'hidden';
                            frame.style.width = '100%';
                        }
                    } catch (err) {
                        // Ignore resize failures for sandboxed content.
                    }
                };
                let attempts = 0;
                const retry = () => {
                    if (attempts >= 5) return;
                    attempts += 1;
                    resize();
                    if (!frame.style.height || frame.style.height === '0px') {
                        setTimeout(retry, 200 * attempts);
                    }
                };
                frame.addEventListener('load', retry, { once: true });
                // Fallbacks if load already fired or doesn't fire.
                requestAnimationFrame(retry);
            });
        },
        availableInboxes(channel) {
            if (channel === 'email') return this.emailInboxes || [];
            if (channel === 'whatsapp') return this.whatsappInboxes || [];
            if (channel === 'facebook_messenger') return this.facebookInboxes || [];
            if (channel === 'instagram_dm') return this.instagramInboxes || [];
            if (channel === 'comments') {
                return [...(this.facebookCommentInboxes || []), ...(this.instagramCommentInboxes || [])];
            }
            return [
                ...(this.emailInboxes || []),
                ...(this.whatsappInboxes || []),
                ...(this.facebookInboxes || []),
                ...(this.instagramInboxes || []),
                ...(this.facebookCommentInboxes || []),
                ...(this.instagramCommentInboxes || [])
            ];
        },
        formatInboxOption(inbox) {
            const name = inbox.name || 'Inbox';
            const channel = inbox.channel || null;
            const kind = inbox.kind || 'inbox';
            const channelLabelMap = {
                email: 'Email',
                whatsapp: 'WhatsApp',
                facebook: 'Facebook',
                instagram: 'Instagram'
            };
            const kindLabel = kind === 'comments' ? 'Comments' : 'Inbox';
            if (this.currentChannel && this.currentChannel !== 'comments') {
                return name;
            }
            if (!channel) {
                return name;
            }
            const channelLabel = channelLabelMap[channel] || 'Inbox';
            return `${channelLabel} ${kindLabel} · ${name}`;
        },
        normalizeInboxTarget() {
            if (!this.currentInboxTargetId) {
                return;
            }
            const inboxes = this.availableInboxes(this.currentChannel);
            if (!inboxes.length || !inboxes.some((i) => i.target_id === this.currentInboxTargetId)) {
                this.currentInboxTargetId = null;
            }
        },
        resetWhatsappTemplateSelection() {
            this.selectedWhatsappTemplateKey = '';
            this.selectedWhatsappTemplateName = '';
            this.selectedWhatsappTemplateLanguage = '';
            this.whatsappTemplateParams = [];
            this.whatsappTemplateParamValues = {};
            this.whatsappTemplateComponentsJson = '';
            this.whatsappTemplateHeader = null;
            this.whatsappTemplateHeaderValues = {};
            this.whatsappTemplateHeaderMediaUrl = '';
            this.whatsappTemplateButtons = [];
            this.whatsappTemplateButtonValues = {};
            if (this.$refs && this.$refs.newConversationMessage) {
                this.$refs.newConversationMessage.value = '';
            }
        },
        resetWhatsappContactSelection() {
            this.whatsappContactQuery = '';
            this.whatsappContactResults = [];
            this.whatsappContactLoading = false;
            this.whatsappContactError = null;
            this.selectedWhatsappContact = null;
            this.newConversationContactName = '';
            this.newConversationContactAddress = '';
        },
        selectWhatsappContact(contact) {
            this.selectedWhatsappContact = contact;
            this.newConversationContactName = contact.name || '';
            this.newConversationContactAddress = contact.whatsapp_address || '';
            this.whatsappContactResults = [];
            this.whatsappContactQuery = contact.name || '';
        },
        searchWhatsappContacts() {
            const term = (this.whatsappContactQuery || '').trim();
            this.whatsappContactError = null;
            if (this._whatsappContactTimer) {
                clearTimeout(this._whatsappContactTimer);
            }
            if (term.length < 2) {
                this.whatsappContactResults = [];
                this.whatsappContactLoading = false;
                return;
            }
            this._whatsappContactTimer = setTimeout(async () => {
                this.whatsappContactLoading = true;
                try {
                    const resp = await fetch(`/admin/crm/inbox/whatsapp-contacts?search=${encodeURIComponent(term)}`);
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}`);
                    }
                    const payload = await resp.json();
                    this.whatsappContactResults = Array.isArray(payload.contacts) ? payload.contacts : [];
                    if (!this.whatsappContactResults.length) {
                        this.whatsappContactError = 'No WhatsApp contacts found.';
                    }
                } catch (err) {
                    this.whatsappContactError = 'Failed to search WhatsApp contacts.';
                    this.whatsappContactResults = [];
                } finally {
                    this.whatsappContactLoading = false;
                }
            }, 250);
        },
        extractWhatsappTemplateHeader(template) {
            if (!template || !Array.isArray(template.components)) {
                return null;
            }
            const header = template.components.find((comp) => comp.type === 'HEADER');
            if (!header) {
                return null;
            }
            const format = header.format || null;
            if (format === 'TEXT') {
                const text = header.text || '';
                const matches = [...text.matchAll(/\{\{(\d+)\}\}/g)];
                const params = matches.map((m) => Number(m[1])).filter((n) => !Number.isNaN(n));
                const unique = Array.from(new Set(params)).sort((a, b) => a - b);
                if (!unique.length) {
                    return null;
                }
                return { format: 'TEXT', params: unique.map((n) => String(n)) };
            }
            if (format) {
                return { format };
            }
            return null;
        },
        extractWhatsappTemplateButtons(template) {
            if (!template || !Array.isArray(template.components)) {
                return [];
            }
            const buttons = template.components.find((comp) => comp.type === 'BUTTONS');
            if (!buttons || !Array.isArray(buttons.buttons)) {
                return [];
            }
            const paramButtons = [];
            buttons.buttons.forEach((btn, idx) => {
                if ((btn.type || '').toUpperCase() !== 'URL') {
                    return;
                }
                const url = btn.url || '';
                if (url.includes('{{1}}')) {
                    paramButtons.push({ index: idx });
                }
            });
            return paramButtons;
        },
        extractWhatsappTemplateParams(template) {
            if (!template || !Array.isArray(template.components)) {
                return [];
            }
            const body = template.components.find((comp) => comp.type === 'BODY');
            if (!body || !body.text) {
                return [];
            }
            const matches = [...body.text.matchAll(/\{\{(\d+)\}\}/g)];
            const params = matches.map((m) => Number(m[1])).filter((n) => !Number.isNaN(n));
            const unique = Array.from(new Set(params)).sort((a, b) => a - b);
            return unique.map((n) => String(n));
        },
        applyWhatsappTemplateParameters() {
            const template = this.whatsappTemplates.find(
                (tmpl) => tmpl.name === this.selectedWhatsappTemplateName && tmpl.language === this.selectedWhatsappTemplateLanguage
            );
            if (!template) {
                this.whatsappTemplateComponentsJson = '';
                return;
            }
            const components = [];

            if (this.whatsappTemplateHeader) {
                if (this.whatsappTemplateHeader.format === 'TEXT') {
                    const params = this.whatsappTemplateHeader.params.map((param) => {
                        const value = this.whatsappTemplateHeaderValues[param];
                        return { type: 'text', text: value || '' };
                    });
                    if (params.length) {
                        components.push({ type: 'header', parameters: params });
                    }
                } else if (this.whatsappTemplateHeaderMediaUrl) {
                    const kind = this.whatsappTemplateHeader.format?.toLowerCase();
                    const payload = {};
                    if (kind === 'image') {
                        payload.image = { link: this.whatsappTemplateHeaderMediaUrl };
                    } else if (kind === 'video') {
                        payload.video = { link: this.whatsappTemplateHeaderMediaUrl };
                    } else if (kind === 'document') {
                        payload.document = { link: this.whatsappTemplateHeaderMediaUrl };
                    }
                    if (Object.keys(payload).length) {
                        components.push({ type: 'header', parameters: [{ type: kind, ...payload }] });
                    }
                }
            }

            const bodyParams = this.whatsappTemplateParams.map((param) => {
                const value = this.whatsappTemplateParamValues[param];
                return { type: 'text', text: value || '' };
            });
            if (bodyParams.length) {
                components.push({ type: 'body', parameters: bodyParams });
            }

            if (this.whatsappTemplateButtons.length) {
                this.whatsappTemplateButtons.forEach((btn) => {
                    const value = this.whatsappTemplateButtonValues[btn.index];
                    if (value !== undefined) {
                        components.push({
                            type: 'button',
                            sub_type: 'url',
                            index: String(btn.index),
                            parameters: [{ type: 'text', text: value || '' }],
                        });
                    }
                });
            }
            this.whatsappTemplateComponentsJson = JSON.stringify(components);

            if (this.$refs && this.$refs.newConversationMessage && template.body) {
                let preview = template.body;
                for (const param of this.whatsappTemplateParams) {
                    const value = this.whatsappTemplateParamValues[param] || '';
                    const token = '{' + '{' + param + '}' + '}';
                    preview = preview.split(token).join(value);
                }
                this.$refs.newConversationMessage.value = preview;
            }
        },
        applyWhatsappTemplate() {
            const key = this.selectedWhatsappTemplateKey || '';
            const parts = key.split('::');
            this.selectedWhatsappTemplateName = parts[0] || '';
            this.selectedWhatsappTemplateLanguage = parts[1] || '';
            if (!this.selectedWhatsappTemplateName) {
                if (this.$refs && this.$refs.newConversationMessage) {
                    this.$refs.newConversationMessage.value = '';
                }
                this.whatsappTemplateParams = [];
                this.whatsappTemplateParamValues = {};
                this.whatsappTemplateComponentsJson = '';
                return;
            }
            const match = this.whatsappTemplates.find(
                (tmpl) => tmpl.name === this.selectedWhatsappTemplateName && tmpl.language === this.selectedWhatsappTemplateLanguage
            );
            if (match && this.$refs && this.$refs.newConversationMessage) {
                this.$refs.newConversationMessage.value = match.body || '';
            }
            this.whatsappTemplateHeader = this.extractWhatsappTemplateHeader(match);
            this.whatsappTemplateParams = this.extractWhatsappTemplateParams(match);
            this.whatsappTemplateButtons = this.extractWhatsappTemplateButtons(match);
            this.whatsappTemplateParamValues = {};
            this.whatsappTemplateHeaderValues = {};
            this.whatsappTemplateHeaderMediaUrl = '';
            this.whatsappTemplateButtonValues = {};
            if (this.whatsappTemplateParams.length) {
                this.whatsappTemplateParams.forEach((param) => {
                    this.whatsappTemplateParamValues[param] = '';
                });
            }
            if (this.whatsappTemplateHeader && this.whatsappTemplateHeader.format === 'TEXT') {
                this.whatsappTemplateHeader.params.forEach((param) => {
                    this.whatsappTemplateHeaderValues[param] = '';
                });
            }
            if (this.whatsappTemplateButtons.length) {
                this.whatsappTemplateButtons.forEach((btn) => {
                    this.whatsappTemplateButtonValues[btn.index] = '';
                });
            }
            this.applyWhatsappTemplateParameters();
        },
        async loadWhatsappTemplates() {
            if (!this.newConversationTargetId) {
                this.whatsappTemplates = [];
                this.whatsappTemplateError = 'Select a WhatsApp inbox to load templates.';
                return;
            }
            this.resetWhatsappTemplateSelection();
            this.whatsappTemplatesLoading = true;
            this.whatsappTemplateError = null;
            try {
                const resp = await fetch(`/admin/crm/inbox/whatsapp-templates?target_id=${encodeURIComponent(this.newConversationTargetId)}`);
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                const payload = await resp.json();
                const templates = Array.isArray(payload.templates) ? payload.templates : [];
                this.whatsappTemplates = templates.filter((t) => (t.status || '').toLowerCase() === 'approved');
                if (!this.whatsappTemplates.length) {
                    this.whatsappTemplateError = 'No approved WhatsApp templates found.';
                }
            } catch (err) {
                this.whatsappTemplateError = 'Failed to load WhatsApp templates.';
                this.whatsappTemplates = [];
            } finally {
                this.whatsappTemplatesLoading = false;
            }
        },
        updateNewConversationTarget() {
            const inboxes = this.availableInboxes(this.newConversationChannel);
            if (!inboxes.length) {
                this.newConversationTargetId = null;
                return;
            }
            if (!this.newConversationTargetId || !inboxes.some((i) => i.target_id === this.newConversationTargetId)) {
                this.newConversationTargetId = inboxes[0].target_id;
            }
            if (this.newConversationChannel === 'whatsapp') {
                this.loadWhatsappTemplates();
                if (!this.selectedWhatsappContact) {
                    this.resetWhatsappContactSelection();
                }
            } else if (this.whatsappTemplates.length || this.selectedWhatsappTemplateName) {
                this.whatsappTemplates = [];
                this.whatsappTemplateError = null;
                this.resetWhatsappTemplateSelection();
                this.resetWhatsappContactSelection();
            }
        },

        initWebSocket() {
            // Get token from cookie or session storage
            const token = this.getAccessToken();
            this.inboxWs = new InboxWebSocket({
                token: token,
                onStatusChange: (connected) => {
                    this.wsConnected = connected;
                }
            });
            this.inboxWs.connect(token);
        },

        initNotificationSound() {
            const stored = localStorage.getItem('inboxNotificationSoundEnabled');
            if (stored !== null) {
                this.notificationSoundEnabled = stored === '1' || stored === 'true';
            }
        },

        toggleNotificationSound() {
            this.notificationSoundEnabled = !this.notificationSoundEnabled;
            localStorage.setItem('inboxNotificationSoundEnabled', this.notificationSoundEnabled ? '1' : '0');
            if (this.notificationSoundEnabled) {
                this.primeNotificationSound();
            }
        },

        primeNotificationSound() {
            try {
                if (!this.notificationAudioContext) {
                    this.notificationAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.notificationAudioContext.state === 'suspended') {
                    this.notificationAudioContext.resume();
                }
            } catch (error) {
                console.warn('[Inbox] Notification sound unavailable', error);
            }
        },

        playNotificationSound() {
            if (!this.notificationSoundEnabled) return;
            try {
                if (!this.notificationAudioContext) {
                    this.notificationAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const context = this.notificationAudioContext;
                if (context.state === 'suspended') {
                    context.resume();
                }
                const oscillator = context.createOscillator();
                const gain = context.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.value = 880;
                gain.gain.value = 0.0001;
                oscillator.connect(gain);
                gain.connect(context.destination);
                const now = context.currentTime;
                gain.gain.exponentialRampToValueAtTime(0.18, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            } catch (error) {
                console.warn('[Inbox] Notification sound error', error);
            }
        },

        handleAgentNotification(payload) {
            if (!payload) return;
            const isConversation = !!payload.conversation_id;
            const isTicket = !!payload.ticket_id;
            if (!isConversation && !isTicket) return;
            if (isConversation && this.selectedConversation && this.selectedConversation === payload.conversation_id) {
                return;
            }
            const existing = this.notifications.filter((note) => {
                if (isConversation) return note.conversationId !== payload.conversation_id;
                if (isTicket) return note.ticketId !== payload.ticket_id;
                return true;
            });
            const notification = this.buildNotification(payload);
            this.notifications = [notification, ...existing].slice(0, 4);
            if (notification.autoDismissMs > 0) {
                notification.timeoutId = setTimeout(() => {
                    this.dismissNotification(notification.id);
                }, notification.autoDismissMs);
            }
            this.playNotificationSound();
        },

        buildNotification(payload) {
            const id = `notif-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            const createdAt = payload.last_message_at ? new Date(payload.last_message_at) : new Date();
            const autoDismissMs = (this.notificationAutoDismissSeconds || 0) * 1000;
            const ticketRef = payload.ticket_number || payload.ticket_id || null;
            const computedUrl = payload.conversation_id
                ? null
                : (ticketRef ? `/admin/support/tickets/${ticketRef}` : null);
            const targetUrl = payload.target_url || computedUrl;
            return {
                id,
                kind: payload.kind || 'reply',
                title: payload.title || 'New message',
                subtitle: payload.subtitle || null,
                preview: payload.preview || null,
                conversationId: payload.conversation_id,
                contactId: payload.contact_id || null,
                channel: payload.channel || null,
                ticketId: payload.ticket_id || null,
                ticketNumber: payload.ticket_number || null,
                targetUrl,
                timeLabel: this.formatTimeLabel(createdAt),
                autoDismissMs,
                timeoutId: null
            };
        },

        dismissNotification(notificationId) {
            const item = this.notifications.find((note) => note.id === notificationId);
            if (item && item.timeoutId) {
                clearTimeout(item.timeoutId);
            }
            this.notifications = this.notifications.filter((note) => note.id !== notificationId);
        },

        openNotification(notification) {
            if (!notification) return;
            if (notification.targetUrl) {
                window.location.href = notification.targetUrl;
                return;
            }
            if (!notification.conversationId) return;
            this.dismissNotification(notification.id);
            this.selectConversation(notification.conversationId, notification.contactId);
        },

        formatTimeLabel(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return 'now';
            }
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },

        getAccessToken() {
            // Try to get token from session storage or cookie
            return sessionStorage.getItem('access_token') ||
                   document.cookie.split('; ').find(row => row.startsWith('session_token='))?.split('=')[1] ||
                   null;
        },

        getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.content) return meta.content;
            const match = document.cookie.match(/csrf_token=([^;]+)/);
            return match ? match[1] : '';
        },

        submitPrivateNote(event) {
            const form = event.target;
            const bodyField = form.querySelector('textarea[name="body"]');
            const visibilityField = form.querySelector('select[name="visibility"]');
            const mentionsField = form.querySelector('input[name="mentions"]');
            const errorEl = form.querySelector('[data-private-note-error]');
            const conversationId = form.getAttribute('data-conversation-id');
            if (errorEl) errorEl.textContent = '';

            const body = bodyField ? bodyField.value : '';
            const visibility = visibilityField ? visibilityField.value : null;
            let mentions = [];
            if (mentionsField && mentionsField.value) {
                try { mentions = JSON.parse(mentionsField.value) || []; } catch (err) { mentions = []; }
            }
            const token = this.getCsrfToken();

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/html',
                    'X-CSRF-Token': token || ''
                },
                body: JSON.stringify({ body, visibility, attachments: this.pendingPrivateAttachments, mentions })
            })
            .then(async (response) => {
                if (!response.ok) {
                    let detail = 'Unable to save note';
                    try {
                        const data = await response.json();
                        detail = data.detail || detail;
                    } catch (err) {}
                    throw new Error(detail);
                }
                return response.text();
            })
            .then((html) => {
                if (html) {
                    const list = document.querySelector('#message-list');
                    if (list) {
                        list.insertAdjacentHTML('beforeend', html);
                        this.scrollToBottom();
                    }
                }
                if (bodyField) bodyField.value = '';
                this.pendingPrivateAttachments = [];
                if (conversationId) {
                    sessionStorage.removeItem(`privateNoteDraft:${conversationId}`);
                    sessionStorage.setItem(`privateNoteOpen:${conversationId}`, '0');
                }
                if (this.showContactPanel && this.selectedContactId) {
                    htmx.ajax('GET', `/admin/crm/inbox/contact/${this.selectedContactId}?conversation_id=${this.selectedConversation || ''}`, {
                        target: '#contact-details',
                        swap: 'innerHTML transition:false'
                    });
                }
            })
            .catch((err) => {
                if (errorEl) errorEl.textContent = err.message;
            });
        },

        deletePrivateNote(event) {
            const button = event.currentTarget;
            const noteId = button?.getAttribute('data-note-id');
            const conversationId = button?.getAttribute('data-conversation-id');
            if (!noteId || !conversationId) {
                return;
            }
            if (!confirm('Delete this private note?')) {
                return;
            }
            const token = this.getCsrfToken();
            fetch(`/admin/crm/inbox/conversation/${conversationId}/private_note/${noteId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-Token': token || ''
                }
            })
            .then(async (response) => {
                if (!response.ok) {
                    let detail = 'Unable to delete note';
                    try {
                        const data = await response.json();
                        detail = data.detail || detail;
                    } catch (err) {}
                    throw new Error(detail);
                }
                const wrapper = button.closest('[data-private-note-item]');
                if (wrapper) {
                    wrapper.remove();
                }
                if (this.showContactPanel && this.selectedContactId) {
                    htmx.ajax('GET', `/admin/crm/inbox/contact/${this.selectedContactId}?conversation_id=${this.selectedConversation || ''}`, {
                        target: '#contact-details',
                        swap: 'innerHTML transition:false'
                    });
                }
            })
            .catch((err) => {
                alert(err.message);
            });
        },

        syncMessageAttachmentField() {
            const hidden = document.querySelector('input[type="hidden"][name="attachments"]');
            if (hidden) {
                hidden.value = JSON.stringify(this.pendingMessageAttachments);
            }
        },

        uploadAttachments(event, kind = 'message') {
            if (!this.selectedConversation) {
                console.warn('[Inbox] No conversation selected for attachments');
                return;
            }
            const files = event.target.files;
            if (!files || !files.length) return;
            const token = this.getCsrfToken();
            const formData = new FormData();
            Array.from(files).forEach((file) => formData.append('files', file));

            fetch(`/admin/crm/inbox/conversation/${this.selectedConversation}/attachments`, {
                method: 'POST',
                headers: { 'X-CSRF-Token': token || '' },
                body: formData
            })
            .then(async (response) => {
                if (!response.ok) {
                    let detail = 'Upload failed';
                    try {
                        const data = await response.json();
                        detail = data.detail || detail;
                    } catch (err) {}
                    throw new Error(detail);
                }
                return response.json();
            })
            .then((data) => {
                const attachments = data.attachments || [];
                if (kind === 'private') {
                    this.pendingPrivateAttachments = [...this.pendingPrivateAttachments, ...attachments];
                    return;
                }
                this.pendingMessageAttachments = [...this.pendingMessageAttachments, ...attachments];
                this.syncMessageAttachmentField();
            })
            .catch((err) => {
                console.error('[Inbox] attachment upload failed', err);
            })
            .finally(() => {
                event.target.value = '';
            });
        },

        removeAttachment(index, kind = 'message') {
            if (kind === 'private') {
                this.pendingPrivateAttachments = this.pendingPrivateAttachments.filter((_, idx) => idx !== index);
                return;
            }
            this.pendingMessageAttachments = this.pendingMessageAttachments.filter((_, idx) => idx !== index);
            this.syncMessageAttachmentField();
        },

        setChannel(channel) {
            this.currentChannel = channel;
            if (channel === 'comments') {
                this.currentStatus = null;
                this.currentAssignment = null;
            }
            this.normalizeInboxTarget();
            this.filterConversations();
        },

        setStatus(status) {
            if (this.currentChannel === 'comments') {
                return;
            }
            this.currentStatus = status;
            this.filterConversations();
        },

        setAssignment(assignment) {
            if (this.currentChannel === 'comments') {
                return;
            }
            this.currentAssignment = assignment;
            this.filterConversations();
        },

        markSearchInteracted(event) {
            if (!event) {
                this.searchInteracted = true;
                return;
            }

            // Treat only real text-edit actions as intent. Ignore navigation keys.
            const key = String(event.key || '').toLowerCase();
            if (
                key === 'tab' ||
                key === 'shift' ||
                key === 'control' ||
                key === 'alt' ||
                key === 'meta' ||
                key === 'capslock' ||
                key === 'escape' ||
                key === 'arrowup' ||
                key === 'arrowdown' ||
                key === 'arrowleft' ||
                key === 'arrowright' ||
                key === 'home' ||
                key === 'end' ||
                key === 'pageup' ||
                key === 'pagedown'
            ) {
                return;
            }
            this.searchInteracted = true;
        },

        scheduleSearchAutofillGuard() {
            const runGuard = () => {
                if (this.searchInteracted || this.hasExplicitSearchParam()) {
                    return;
                }
                const value = (this.searchQuery || '').trim();
                if (!value) {
                    return;
                }
                this.searchQuery = '';
                const searchInput = document.querySelector("input[data-search-input='true'][name='search']");
                if (searchInput && searchInput.value) {
                    searchInput.value = '';
                }
            };

            window.setTimeout(runGuard, 150);
            window.setTimeout(runGuard, 500);
            window.setTimeout(runGuard, 1200);
            window.setTimeout(runGuard, 2500);
        },

        initializeSearchState() {
            if (this.hasExplicitSearchParam()) {
                this.searchInteracted = true;
                return;
            }
            if ((this.searchQuery || '').trim()) {
                this.searchQuery = '';
            }
            this.searchInteracted = false;
        },

        hasExplicitSearchParam() {
            const params = new URLSearchParams(window.location.search || '');
            return (params.get('search') || '').trim().length > 0;
        },

        effectiveSearchQuery() {
            const value = (this.searchQuery || '').trim();
            if (!value) {
                return '';
            }
            if (this.searchInteracted || this.hasExplicitSearchParam()) {
                return value;
            }
            return '';
        },

        guardAutofilledSearch() {
            if (this.searchInteracted || this.hasExplicitSearchParam()) {
                return;
            }
            if (!(this.searchQuery || '').trim()) {
                return;
            }
            const searchInput = document.querySelector("input[data-search-input='true'][name='search']");
            if (searchInput && document.activeElement === searchInput) {
                return;
            }
            this.searchQuery = '';
        },

        cacheKey() {
            const channel = this.currentChannel || 'all';
            const status = this.currentStatus || 'all';
            const assignment = this.currentAssignment || 'all';
            const targetId = this.currentInboxTargetId || 'all';
            const search = this.effectiveSearchQuery();
            return `crm:conversations:${channel}:${status}:${assignment}:${targetId}:${search}`;
        },

        restoreConversationCache() {
            if (this.currentChannel === 'comments') {
                return;
            }
            try {
                const cached = localStorage.getItem(this.cacheKey());
                if (cached) {
                    const list = document.querySelector('#conversation-list');
                    if (list) {
                        list.innerHTML = cached;
                        setTimeout(() => this.refreshConversations(), 0);
                    }
                }
            } catch (err) {
                console.log('[Inbox] cache restore failed', err);
            }
        },

        storeConversationCache() {
            if (this.currentChannel === 'comments') {
                return;
            }
            try {
                const list = document.querySelector('#conversation-list');
                if (list) {
                    localStorage.setItem(this.cacheKey(), list.innerHTML);
                }
            } catch (err) {
                console.log('[Inbox] cache store failed', err);
            }
        },

        filterConversations(options = {}) {
            this.guardAutofilledSearch();
            if (options.fromInput && !this.searchInteracted && !this.hasExplicitSearchParam()) {
                return;
            }

            const params = new URLSearchParams();
            if (this.currentChannel) params.set('channel', this.currentChannel);
            if (this.currentStatus) params.set('status', this.currentStatus);
            if (this.currentOutboxStatus) params.set('outbox_status', this.currentOutboxStatus);
            if (this.currentAssignment) params.set('assignment', this.currentAssignment);
            if (this.currentInboxTargetId) params.set('target_id', this.currentInboxTargetId);
            const effectiveSearch = this.effectiveSearchQuery();
            if (effectiveSearch) params.set('search', effectiveSearch);
            params.set('page', '1');
            params.set('limit', String(this.paginationLimit));

            if (this.currentChannel === 'comments') {
                window.location = `/admin/crm/inbox?${params.toString()}`;
                return;
            }

            htmx.ajax('GET', `/admin/crm/inbox/conversations?${params.toString()}`, {
                target: '#conversation-list',
                swap: 'innerHTML transition:false'
            });
        },

        scheduleRefresh(scope = 'both') {
            if (this.currentChannel === 'comments') {
                return;
            }
            clearTimeout(this.refreshTimer);
            this.refreshTimer = setTimeout(() => {
                if (scope === 'list' || scope === 'both') {
                    this.refreshConversations();
                }
                if (scope === 'thread' || scope === 'both') {
                    if (this.selectedConversation) {
                        this.refreshThread(true);
                    }
                }
            }, this.refreshDelayMs);
        },

        selectConversation(convId, contactId) {
            // Unsubscribe from previous conversation
            if (this.inboxWs && this.selectedConversation) {
                this.inboxWs.unsubscribe(this.selectedConversation);
            }

            this.selectedConversation = convId;
            this.selectedContactId = contactId;
            this.selectedCommentId = null;
            this.showContactPanel = false;
            this.sidePanel = null;
            this.clearQuote();
            this.threadStale = false;
            this.pendingMessageAttachments = [];
            this.pendingPrivateAttachments = [];
            this.syncMessageAttachmentField();

            // Subscribe to new conversation
            if (this.inboxWs && convId) {
                this.inboxWs.subscribe(convId);
            }

            // Load conversation thread
            htmx.ajax('GET', `/admin/crm/inbox/conversation/${convId}`, {
                target: '#message-thread',
                swap: 'innerHTML transition:false'
            });

            const contactPanel = document.querySelector('#contact-details');
            if (contactPanel) {
                contactPanel.innerHTML = '';
            }

            // Update URL without reload
            const params = new URLSearchParams(window.location.search);
            params.set('conversation_id', convId);
            params.delete('comment_id');
            const effectiveSearch = this.effectiveSearchQuery();
            if (effectiveSearch) {
                params.set('search', effectiveSearch);
            } else {
                params.delete('search');
            }
            if (params.get('channel') === 'comments') {
                params.delete('channel');
            }
            window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
        },

        selectComment(commentId) {
            if (this.inboxWs && this.selectedConversation) {
                this.inboxWs.unsubscribe(this.selectedConversation);
            }

            this.selectedConversation = null;
            this.selectedContactId = null;
            this.selectedCommentId = commentId;
            this.showContactPanel = false;
            this.sidePanel = null;
            this.clearQuote();
            this.threadStale = false;

            const params = new URLSearchParams();
            params.set('comment_id', commentId);
            const effectiveSearch = this.effectiveSearchQuery();
            if (effectiveSearch) params.set('search', effectiveSearch);
            if (this.currentInboxTargetId) params.set('target_id', this.currentInboxTargetId);

            htmx.ajax('GET', `/admin/crm/inbox/comments/thread?${params.toString()}`, {
                target: '#message-thread',
                swap: 'innerHTML transition:false'
            });

            const contactPanel = document.querySelector('#contact-details');
            if (contactPanel) {
                contactPanel.innerHTML = '';
            }

            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('conversation_id');
            urlParams.set('comment_id', commentId);
            if (effectiveSearch) {
                urlParams.set('search', effectiveSearch);
            } else {
                urlParams.delete('search');
            }
            if (this.currentInboxTargetId) {
                urlParams.set('target_id', this.currentInboxTargetId);
            } else {
                urlParams.delete('target_id');
            }
            if (urlParams.get('channel') === 'comments') {
                urlParams.delete('channel');
            }
            window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
        },

        openTicketPanel() {
            this.sidePanel = 'ticket';
            this.showContactPanel = false;
        },

        submitTicketForm() {
            const panel = document.getElementById('ticket-create-panel-body');
            const form = panel ? panel.querySelector('#ticket-create-form') : null;
            if (!form) return;
            const titleInput = form.querySelector('input[name="title"]');
            if (titleInput && typeof titleInput.value === 'string') {
                titleInput.value = titleInput.value.trim();
            }
            if (typeof form.reportValidity === 'function' && !form.reportValidity()) {
                return;
            }
            const submitter = form.querySelector('button[type="submit"], input[type="submit"]');
            if (typeof form.requestSubmit === 'function') {
                form.requestSubmit(submitter || undefined);
                return;
            }
            form.submit();
        },

        closeSidePanel() {
            this.sidePanel = null;
        },

        closeTicketPanel() {
            this.closeSidePanel();
        },

        refreshConversations(force = false) {
            if (this.currentChannel === 'comments') {
                return;
            }
            // When a thread is open, refresh the list silently in the
            // background so new conversations appear without losing the
            // agent's current view.  Previously this only set listStale
            // which required a manual click.
            this.listStale = false;
            this.filterConversations();
        },

        refreshComments() {
            const params = new URLSearchParams();
            const effectiveSearch = this.effectiveSearchQuery();
            if (effectiveSearch) params.set('search', effectiveSearch);
            if (this.selectedCommentId) params.set('comment_id', this.selectedCommentId);
            if (this.currentInboxTargetId) params.set('target_id', this.currentInboxTargetId);
            params.set('page', '1');
            params.set('limit', String(this.paginationLimit));

            htmx.ajax('GET', `/admin/crm/inbox/comments/list?${params.toString()}`, {
                target: '#conversation-list',
                swap: 'innerHTML transition:false'
            });
            htmx.ajax('GET', `/admin/crm/inbox/comments/thread?${params.toString()}`, {
                target: '#message-thread',
                swap: 'innerHTML transition:false'
            });
        },

        autoRefresh() {
            if (this.currentChannel === 'comments') {
                this.refreshComments();
                return;
            }
            this.refreshConversations(true);
            if (this.selectedConversation) {
                this.refreshThread(false);
            }
        },

        refreshThread(force = false) {
            if (this.currentChannel === 'comments') {
                return;
            }
            if (!this.selectedConversation) {
                return;
            }
            const input = document.querySelector('#message-thread textarea[name="message"]');
            const isComposing = input && (document.activeElement === input || input.value.trim() !== '');
            if (isComposing) {
                if (force) {
                    this.pendingThreadRefresh = true;
                }
                this.threadStale = true;
                return;
            }
            if (this.pendingThreadRefresh) {
                this.pendingThreadRefresh = false;
            }
            this.threadStale = false;
            htmx.ajax('GET', `/admin/crm/inbox/conversation/${this.selectedConversation}`, {
                target: '#message-thread',
                swap: 'innerHTML transition:false'
            });
        },
        acknowledgeListStale() {
            this.refreshConversations();
        },
        acknowledgeThreadStale() {
            if (!this.selectedConversation) {
                return;
            }
            this.refreshThread(true);
        },
        flushPendingThreadRefresh() {
            if (!this.pendingThreadRefresh) {
                return;
            }
            this.pendingThreadRefresh = false;
            this.refreshThread(true);
        },

        subscribeVisibleConversations() {
            if (!this.inboxWs || !this.inboxWs.isConnected()) {
                return;
            }
            const visibleIds = new Set();
            const rows = document.querySelectorAll('[data-conversation-id]');
            rows.forEach((row) => {
                const convId = row.getAttribute('data-conversation-id');
                if (convId) {
                    visibleIds.add(convId);
                    this.inboxWs.subscribe(convId);
                }
            });
            // Unsubscribe from conversations no longer visible (except selected)
            for (const subId of this.inboxWs.subscriptions) {
                if (!visibleIds.has(subId) && subId !== this.selectedConversation) {
                    this.inboxWs.unsubscribe(subId);
                }
            }
        },

        updateConversationRow(summary) {
            if (!summary || !summary.conversation_id) {
                return false;
            }
            const row = document.querySelector(
                `[data-conversation-id="${summary.conversation_id}"]`
            );
            if (!row) {
                return false;
            }
            if (summary.channel) {
                row.className = row.className.replace(/channel-[^\s]+/g, '').trim();
                row.classList.add(`channel-${summary.channel}`);
            }
            if (typeof summary.unread_count === 'number') {
                const badge = row.querySelector('[data-role="unread-count"]');
                if (badge) {
                    if (summary.unread_count > 0) {
                        badge.textContent = String(summary.unread_count);
                        badge.classList.remove('hidden');
                        row.classList.add('unread');
                    } else {
                        badge.textContent = '';
                        badge.classList.add('hidden');
                        row.classList.remove('unread');
                    }
                }
            }
            if (summary.preview) {
                const preview = row.querySelector('[data-role="preview"]');
                if (preview) {
                    preview.textContent = summary.preview;
                }
            }
            if (summary.last_message_at) {
                const timeEl = row.querySelector('[data-role="last-message-at"]');
                if (timeEl) {
                    timeEl.dataset.timestamp = summary.last_message_at;
                    const date = new Date(summary.last_message_at);
                    timeEl.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
            this.moveConversationRowToTop(row);
            return true;
        },

        moveConversationRowToTop(row) {
            if (!row) {
                return;
            }
            const container = row.parentElement;
            if (!container) {
                return;
            }
            if (container.firstElementChild === row) {
                return;
            }
            container.prepend(row);
        },

        queueConversationSummary(summary) {
            if (!summary || !summary.conversation_id) {
                return;
            }
            const key = String(summary.conversation_id);
            const existing = this.summaryQueue.get(key) || {};
            this.summaryQueue.set(key, { ...existing, ...summary });
            this.scheduleSummaryFlush();
        },

        scheduleSummaryFlush() {
            if (this.summaryFlushScheduled) {
                return;
            }
            const now = Date.now();
            const elapsed = now - this.lastSummaryFlushAt;
            const delay = Math.max(this.minSummaryFlushIntervalMs - elapsed, 0);
            this.summaryFlushScheduled = true;
            if (delay > 0) {
                this.summaryFlushTimer = setTimeout(() => {
                    this.summaryFlushTimer = null;
                    requestAnimationFrame(() => this.flushConversationSummaries());
                }, delay);
            } else {
                requestAnimationFrame(() => this.flushConversationSummaries());
            }
        },

        flushConversationSummaries() {
            this.summaryFlushScheduled = false;
            if (!this.summaryQueue.size) {
                return;
            }
            this.lastSummaryFlushAt = Date.now();
            const entries = Array.from(this.summaryQueue.values());
            this.summaryQueue.clear();
            let applied = 0;
            let needsListRefresh = false;
            for (const summary of entries) {
                if (this.updateConversationRow(summary)) {
                    applied += 1;
                } else {
                    // Conversation not in DOM (new conversation) — trigger
                    // a background list refresh so it appears automatically
                    // instead of just showing the stale banner.
                    needsListRefresh = true;
                }
                if (applied >= this.maxSummaryFlushPerTick) {
                    break;
                }
            }
            if (needsListRefresh) {
                this.refreshConversations();
            }
            if (entries.length > applied) {
                for (const summary of entries.slice(applied)) {
                    if (summary && summary.conversation_id) {
                        this.summaryQueue.set(String(summary.conversation_id), summary);
                    }
                }
                this.summaryFlushScheduled = false;
                this.scheduleSummaryFlush();
            }
        },

        scrollToBottom() {
            const container = document.querySelector('#messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        toggleContactPanel() {
            const nextState = !this.showContactPanel;
            this.showContactPanel = nextState;
            if (nextState && this.selectedContactId) {
                htmx.ajax('GET', `/admin/crm/inbox/contact/${this.selectedContactId}?conversation_id=${this.selectedConversation || ''}`, {
                    target: '#contact-details',
                    swap: 'innerHTML transition:false'
                });
            }
        },

        openContactPanel(contactId) {
            this.selectedContactId = contactId;
            this.showContactPanel = true;
            htmx.ajax('GET', `/admin/crm/inbox/contact/${contactId}?conversation_id=${this.selectedConversation || ''}`, {
                target: '#contact-details',
                swap: 'innerHTML transition:false'
            });
        }
    }
}
</script>

{% endblock %}

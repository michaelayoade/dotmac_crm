{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import danger_button, status_badge, submit_button, typeahead_input, warning_button, table_shell, table_row, empty_state %}

{% block title %}Inbox Settings - Admin{% endblock %}

{% block breadcrumbs %}
<a href="/admin/dashboard" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">Dashboard</a>
<span class="text-slate-400">/</span>
<a href="/admin/crm/inbox" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">Inbox</a>
<span class="text-slate-400">/</span>
<span class="text-slate-700 dark:text-slate-200">Settings</span>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">Inbox Settings</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Configure email and WhatsApp connectors for the inbox.</p>
        </div>
        <a href="/admin/crm/inbox"
           class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to inbox
        </a>
    </div>

    {% if email_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Email settings saved.
    </div>
    {% endif %}
    {% if email_warning %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 dark:border-amber-500/30 dark:bg-amber-500/10 dark:text-amber-300">
        Email settings saved, but the SMTP test failed.
        {% if email_warning_detail %}
        <div class="mt-1 text-xs text-amber-700 dark:text-amber-200">{{ email_warning_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if email_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Email settings could not be saved. Check your inputs.
        {% if email_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ email_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if whatsapp_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        WhatsApp settings saved.
    </div>
    {% endif %}
    {% if whatsapp_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        WhatsApp settings could not be saved. Check your inputs.
    </div>
    {% endif %}
    {% if team_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Team created.
    </div>
    {% endif %}
    {% if team_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Team could not be created.
        {% if team_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ team_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if agent_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Agent created.
    </div>
    {% endif %}
    {% if agent_deleted %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Agent deleted.
    </div>
    {% endif %}
    {% if agent_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Agent action failed.
        {% if agent_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ agent_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if assignment_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Agent assigned to team.
    </div>
    {% endif %}
    {% if assignment_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Agent could not be assigned.
        {% if assignment_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ assignment_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if notification_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Notification settings saved.
    </div>
    {% endif %}
    {% if notification_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Notification settings could not be saved.
        {% if notification_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ notification_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if csat_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        CSAT inbox settings saved.
    </div>
    {% endif %}
    {% if csat_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        CSAT settings could not be saved.
        {% if csat_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ csat_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}
    {% if meta_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Meta accounts connected successfully.
        {% if meta_pages %}{{ meta_pages }} Facebook Page(s){% endif %}
        {% if meta_instagram %}, {{ meta_instagram }} Instagram account(s){% endif %}
    </div>
    {% endif %}
    {% if meta_disconnected %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 dark:border-amber-500/30 dark:bg-amber-500/10 dark:text-amber-300">
        Meta integration disconnected.
    </div>
    {% endif %}
    {% if meta_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Meta connection failed.
        {% if meta_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ meta_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}

    <section class="rounded-2xl border border-slate-200/70 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Reply Notifications</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Alert assigned agents when a customer replies and set reminder timing.
                </p>
            </div>
        </div>
        <form method="POST" action="/admin/crm/inbox/notification-settings" class="mt-5 grid gap-4 md:grid-cols-2">
            {% include "components/forms/csrf_input.html" %}
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Reminder delay (seconds)</label>
                <input type="number"
                       name="reminder_delay_seconds"
                       min="30"
                       max="86400"
                       value="{{ reminder_delay_seconds or 300 }}"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Time before a reminder is sent after a customer reply.</p>
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Notification auto-dismiss (seconds)</label>
                <input type="number"
                       name="notification_auto_dismiss_seconds"
                       min="3"
                       max="120"
                       value="{{ notification_auto_dismiss_seconds or 12 }}"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">How long the notification card stays visible.</p>
            </div>
            <div class="md:col-span-2">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                    <input type="checkbox"
                           name="reminder_repeat_enabled"
                           value="1"
                           {% if reminder_repeat_enabled %}checked{% endif %}
                           class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800">
                    Repeat reminders until the agent replies
                </label>
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Repeat interval (seconds)</label>
                <input type="number"
                       name="reminder_repeat_interval_seconds"
                       min="30"
                       max="86400"
                       value="{{ reminder_repeat_interval_seconds or 300 }}"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Only used when repeat reminders are enabled.</p>
            </div>
            <div class="flex items-end justify-end md:col-span-2">
                {{ submit_button("Save notification settings", color="amber") }}
            </div>
        </form>
    </section>

    <section class="rounded-2xl border border-slate-200/70 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Auto-Resolve</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Automatically resolve conversations that have been idle for a set number of days.
                </p>
            </div>
        </div>
        <form method="POST" action="/admin/crm/inbox/notification-settings" class="mt-5 grid gap-4 md:grid-cols-2">
            {% include "components/forms/csrf_input.html" %}
            <div class="md:col-span-2">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                    <input type="checkbox"
                           name="auto_resolve_enabled"
                           value="1"
                           {% if auto_resolve_enabled %}checked{% endif %}
                           class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800">
                    Enable auto-resolve for idle conversations
                </label>
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Idle days before resolve</label>
                <input type="number"
                       name="auto_resolve_days"
                       min="1"
                       max="90"
                       value="{{ auto_resolve_days or 7 }}"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Conversations idle for this many days will be auto-resolved (1–90).</p>
            </div>
            <div class="flex items-end justify-end md:col-span-2">
                {{ submit_button("Save auto-resolve settings", color="amber") }}
            </div>
        </form>
    </section>

    <section class="rounded-2xl border border-slate-200/70 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Conversation CSAT</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Enable or disable post-resolution CSAT invites per inbox. Disabled by default.
                </p>
            </div>
        </div>
        <div class="mt-5 space-y-3">
            {% set all_inboxes = (email_inboxes or []) + (whatsapp_inboxes or []) + (facebook_inboxes or []) + (instagram_inboxes or []) %}
            {% if all_inboxes and all_inboxes|length > 0 %}
                {% for inbox in all_inboxes %}
                <form method="POST" action="/admin/crm/inbox/csat-toggle" class="flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-200 bg-slate-50/60 px-4 py-3 dark:border-slate-700 dark:bg-slate-800/40">
                    {% include "components/forms/csrf_input.html" %}
                    <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                    <div>
                        <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ inbox.name or inbox.target_id }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ (inbox.channel or "inbox")|replace("_"," ")|title }}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input type="checkbox"
                                   name="enabled"
                                   value="1"
                                   {% if inbox.csat_enabled %}checked{% endif %}
                                   {% if not can_manage_settings %}disabled{% endif %}
                                   class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800">
                            Enable CSAT
                        </label>
                        <button type="submit"
                                {% if not can_manage_settings %}disabled{% endif %}
                                class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                            Save
                        </button>
                    </div>
                </form>
                {% endfor %}
            {% endif %}
            <form method="POST" action="/admin/crm/inbox/csat-toggle" class="flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-200 bg-slate-50/60 px-4 py-3 dark:border-slate-700 dark:bg-slate-800/40">
                {% include "components/forms/csrf_input.html" %}
                <input type="hidden" name="target_id" value="channel:chat_widget">
                <div>
                    <p class="text-sm font-semibold text-slate-900 dark:text-white">Website Chat</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Chat Widget</p>
                </div>
                <div class="flex items-center gap-3">
                    <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                        <input type="checkbox"
                               name="enabled"
                               value="1"
                               {% if chat_widget_csat_enabled %}checked{% endif %}
                               {% if not can_manage_settings %}disabled{% endif %}
                               class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800">
                        Enable CSAT
                    </label>
                    <button type="submit"
                            {% if not can_manage_settings %}disabled{% endif %}
                            class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </section>

    <section class="rounded-2xl border border-slate-200/70 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Message Templates</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Create reusable templates for faster replies. Use {{ "{{key}}" }} placeholders for personalization.
                </p>
            </div>
        </div>
        <form method="POST" action="/admin/crm/inbox/templates" class="mt-5 grid gap-4 md:grid-cols-2">
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Name</label>
                <input type="text"
                       name="name"
                       required
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Channel</label>
                <select name="channel_type"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    <option value="email">Email</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="facebook_messenger">Facebook Messenger</option>
                    <option value="instagram_dm">Instagram DM</option>
                    <option value="chat_widget">Chat Widget</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Subject (email only)</label>
                <input type="text"
                       name="subject"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
            </div>
            <div class="md:col-span-2">
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Body</label>
                <textarea name="body"
                          rows="3"
                          required
                          class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                    <input type="checkbox"
                           name="is_active"
                           value="1"
                           checked
                           class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800">
                    Active
                </label>
            </div>
            <div class="flex items-end justify-end md:col-span-2">
                {{ submit_button("Create template") }}
            </div>
        </form>

        {% if message_templates and message_templates|length > 0 %}
        <div class="mt-6 space-y-4">
            {% for tmpl in message_templates %}
            <details class="group rounded-xl border border-slate-200 bg-slate-50/60 p-4 open:bg-white dark:border-slate-700 dark:bg-slate-800/60 dark:open:bg-slate-900">
                <summary class="flex cursor-pointer list-none items-center justify-between gap-3">
                    <div>
                        <div class="text-sm font-semibold text-slate-900 dark:text-white">{{ tmpl.name }}</div>
                        <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                            {{ tmpl.channel_type.value if tmpl.channel_type }} · {{ "Active" if tmpl.is_active else "Inactive" }}
                        </div>
                    </div>
                </summary>
                <form method="POST" action="/admin/crm/inbox/templates/{{ tmpl.id }}" class="mt-4 grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Name</label>
                        <input type="text"
                               name="name"
                               value="{{ tmpl.name }}"
                               required
                               class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Channel</label>
                        <select name="channel_type"
                                class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                            {% for ch in ["email","whatsapp","facebook_messenger","instagram_dm","chat_widget"] %}
                            <option value="{{ ch }}" {% if tmpl.channel_type and tmpl.channel_type.value == ch %}selected{% endif %}>{{ ch }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Subject</label>
                        <input type="text"
                               name="subject"
                               value="{{ tmpl.subject or '' }}"
                               class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Body</label>
                        <textarea name="body"
                                  rows="3"
                                  required
                                  class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">{{ tmpl.body }}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input type="checkbox"
                                   name="is_active"
                                   value="1"
                                   {% if tmpl.is_active %}checked{% endif %}
                                   class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800">
                            Active
                        </label>
                    </div>
                    <div class="flex items-center justify-between md:col-span-2">
                        {{ submit_button("Update template") }}
                        <button type="submit"
                                formaction="/admin/crm/inbox/templates/{{ tmpl.id }}/delete"
                                class="inline-flex items-center justify-center gap-2 rounded-lg border border-rose-200 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 dark:border-rose-500/30 dark:bg-rose-500/10 dark:text-rose-200 dark:hover:bg-rose-500/20">
                            Delete
                        </button>
                    </div>
                </form>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">No templates yet.</p>
        {% endif %}
    </section>

    <section class="rounded-2xl border border-slate-200/70 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Routing Rules</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Automatically assign inbound conversations based on channel, inbox target, and keywords.
                </p>
            </div>
        </div>
        <form method="POST" action="/admin/crm/inbox/routing-rules" class="mt-5 grid gap-4 md:grid-cols-2">
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Team</label>
                <select name="team_id"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    {% for team in teams or [] %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Channel</label>
                <select name="channel_type"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    <option value="email">Email</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="facebook_messenger">Facebook Messenger</option>
                    <option value="instagram_dm">Instagram DM</option>
                    <option value="chat_widget">Chat Widget</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Inbox target (optional)</label>
                <input type="text"
                       name="target_id"
                       placeholder="Integration target UUID"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Strategy</label>
                <select name="strategy"
                        class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    <option value="round_robin">Round robin</option>
                    <option value="least_loaded">Least loaded</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Keywords (comma-separated)</label>
                <input type="text"
                       name="keywords"
                       placeholder="billing, refund, support"
                       class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
            </div>
            <div class="md:col-span-2">
                <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                    <input type="checkbox"
                           name="is_active"
                           value="1"
                           checked
                           class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800">
                    Active
                </label>
            </div>
            <div class="flex items-end justify-end md:col-span-2">
                {{ submit_button("Create rule") }}
            </div>
        </form>

        {% if routing_rules and routing_rules|length > 0 %}
        <div class="mt-6 space-y-4">
            {% for rule in routing_rules %}
            <details class="group rounded-xl border border-slate-200 bg-slate-50/60 p-4 open:bg-white dark:border-slate-700 dark:bg-slate-800/60 dark:open:bg-slate-900">
                <summary class="flex cursor-pointer list-none items-center justify-between gap-3">
                    <div>
                        <div class="text-sm font-semibold text-slate-900 dark:text-white">
                            {{ teams_by_id[rule.team_id | string].name if teams_by_id and (rule.team_id | string) in teams_by_id else 'Team' }}
                        </div>
                        <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                            {{ rule.channel_type.value if rule.channel_type }} · {{ "Active" if rule.is_active else "Inactive" }}
                        </div>
                    </div>
                </summary>
                <form method="POST" action="/admin/crm/inbox/routing-rules/{{ rule.id }}" class="mt-4 grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Team</label>
                        <select name="team_id"
                                class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                            {% for team in teams or [] %}
                            <option value="{{ team.id }}" {% if rule.team_id == team.id %}selected{% endif %}>{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Channel</label>
                        <select name="channel_type"
                                class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                            {% for ch in ["email","whatsapp","facebook_messenger","instagram_dm","chat_widget"] %}
                            <option value="{{ ch }}" {% if rule.channel_type and rule.channel_type.value == ch %}selected{% endif %}>{{ ch }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Inbox target</label>
                        <input type="text"
                               name="target_id"
                               value="{{ rule.rule_config.get('target_id') if rule.rule_config }}"
                               class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Strategy</label>
                        <select name="strategy"
                                class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                            {% set strat = rule.rule_config.get('strategy') if rule.rule_config else '' %}
                            <option value="round_robin" {% if strat == 'round_robin' or not strat %}selected{% endif %}>Round robin</option>
                            <option value="least_loaded" {% if strat == 'least_loaded' %}selected{% endif %}>Least loaded</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300">Keywords</label>
                        <input type="text"
                               name="keywords"
                               value="{{ (rule.rule_config.get('keywords') or [])|join(', ') if rule.rule_config else '' }}"
                               class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-700 dark:bg-slate-900 dark:text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input type="checkbox"
                                   name="is_active"
                                   value="1"
                                   {% if rule.is_active %}checked{% endif %}
                                   class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-800">
                            Active
                        </label>
                    </div>
                    <div class="flex items-center justify-between md:col-span-2">
                        {{ submit_button("Update rule") }}
                        <button type="submit"
                                formaction="/admin/crm/inbox/routing-rules/{{ rule.id }}/delete"
                                class="inline-flex items-center justify-center gap-2 rounded-lg border border-rose-200 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 dark:border-rose-500/30 dark:bg-rose-500/10 dark:text-rose-200 dark:hover:bg-rose-500/20">
                            Delete
                        </button>
                    </div>
                </form>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">No routing rules yet.</p>
        {% endif %}
    </section>

    <!-- ── Macros ──────────────────────────────────────────────── -->
    {% if macro_setup is defined and macro_setup %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-500/10 dark:text-emerald-300">
        Macro saved successfully.
    </div>
    {% endif %}
    {% if macro_error is defined and macro_error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/30 dark:bg-red-500/10 dark:text-red-300">
        Failed to save macro.
        {% if macro_error_detail is defined and macro_error_detail %}
        <div class="mt-1 text-xs text-red-600 dark:text-red-300">{{ macro_error_detail }}</div>
        {% endif %}
    </div>
    {% endif %}

    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900 animate-fade-in-up">
        <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Conversation Macros</h2>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Saved action sequences that agents can execute on conversations with one click.
                </p>
            </div>
        </div>

        <!-- Create macro form -->
        {% if can_manage_settings %}
        <details class="mt-5 group">
            <summary class="cursor-pointer text-sm font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300">
                + Add macro
            </summary>
            <form method="POST" action="/admin/crm/inbox/macros"
                  x-data='{
                      actions: [],
                      addAction() { this.actions.push({action_type: "set_status", params: {}}); },
                      removeAction(idx) { this.actions.splice(idx, 1); },
                      serializeActions() { return JSON.stringify(this.actions); }
                  }'
                  @submit="$refs.actionsInput.value = serializeActions()"
                  class="mt-4 space-y-4">
                {% include "components/forms/csrf_input.html" %}
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Name</label>
                        <input type="text" name="name" required maxlength="200" placeholder="e.g. Resolve + tag VIP"
                               class="w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Visibility</label>
                        <select name="visibility"
                                class="w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none dark:border-slate-600 dark:bg-slate-700/50 dark:text-white">
                            <option value="personal">Personal (only me)</option>
                            <option value="shared">Shared (all agents)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Description (optional)</label>
                    <input type="text" name="description" maxlength="500" placeholder="Brief description of what this macro does"
                           class="w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:placeholder-slate-500">
                </div>

                <!-- Dynamic action builder -->
                <div>
                    <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-2">Actions</label>
                    <template x-for="(action, idx) in actions" :key="idx">
                        <div class="flex items-start gap-2 mb-3 p-3 rounded-lg border border-slate-200 bg-slate-50/50 dark:border-slate-600 dark:bg-slate-700/30">
                            <div class="flex-1 grid gap-2 md:grid-cols-2">
                                <select x-model="action.action_type" @change="action.params = {}"
                                        class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                                    <option value="assign_conversation">Assign to agent/team</option>
                                    <option value="set_status">Change status</option>
                                    <option value="add_tag">Add tag</option>
                                    <option value="send_template">Send canned response</option>
                                </select>
                                <!-- Params per type -->
                                <template x-if="action.action_type === 'set_status'">
                                    <select x-model="action.params.status"
                                            class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                                        <option value="">Select status...</option>
                                        <option value="open">Open</option>
                                        <option value="pending">Pending</option>
                                        <option value="snoozed">Snoozed</option>
                                        <option value="resolved">Resolved</option>
                                    </select>
                                </template>
                                <template x-if="action.action_type === 'add_tag'">
                                    <input type="text" x-model="action.params.tag" placeholder="Tag name"
                                           class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-500">
                                </template>
                                <template x-if="action.action_type === 'assign_conversation'">
                                    <div class="flex gap-2">
                                        <select x-model="action.params.agent_id"
                                                class="flex-1 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                                            <option value="">Agent (optional)</option>
                                            {% for agent in agents %}
                                            <option value="{{ agent.id }}">{{ people_by_id.get(agent.person_id|string, agent).display_name|default(people_by_id.get(agent.person_id|string, agent).first_name|default('Agent'), true) }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </template>
                                <template x-if="action.action_type === 'send_template'">
                                    <select x-model="action.params.template_id"
                                            class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                                        <option value="">Select template...</option>
                                        {% for tpl in message_templates %}
                                        <option value="{{ tpl.id }}">{{ tpl.name }}</option>
                                        {% endfor %}
                                    </select>
                                </template>
                            </div>
                            <button type="button" @click="removeAction(idx)"
                                    class="p-1.5 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10"
                                    aria-label="Remove action">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </template>
                    <button type="button" @click="addAction()"
                            class="inline-flex items-center gap-1.5 rounded-lg border border-dashed border-slate-300 px-3 py-2 text-xs font-medium text-slate-500 hover:border-primary-400 hover:text-primary-600 dark:border-slate-600 dark:text-slate-400 dark:hover:border-primary-500 dark:hover:text-primary-400">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7H5"/>
                        </svg>
                        Add action
                    </button>
                </div>

                <input type="hidden" name="actions_json" x-ref="actionsInput" value="[]">
                <div class="flex gap-2">
                    {{ submit_button("Create Macro") }}
                </div>
            </form>
        </details>
        {% endif %}

        <!-- Existing macros list -->
        {% if macros is defined and macros|length > 0 %}
        <div class="mt-5 space-y-3">
            {% for macro in macros %}
            <details class="rounded-xl border border-slate-200 bg-slate-50/50 dark:border-slate-700 dark:bg-slate-800/50 group">
                <summary class="flex items-center justify-between cursor-pointer px-4 py-3">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-violet-500/10 text-violet-600 dark:bg-violet-500/20 dark:text-violet-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">{{ macro.name }}</span>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] px-1.5 py-0.5 rounded-md font-medium
                                    {% if macro.visibility.value == 'shared' %}bg-blue-500/10 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400
                                    {% else %}bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                    {{ macro.visibility.value | capitalize }}
                                </span>
                                <span class="text-[10px] text-slate-400 dark:text-slate-500">{{ macro.actions|length }} action{{ 's' if macro.actions|length != 1 else '' }}</span>
                                <span class="text-[10px] text-slate-400 dark:text-slate-500">{{ macro.execution_count }} run{{ 's' if macro.execution_count != 1 else '' }}</span>
                                {% if not macro.is_active %}
                                <span class="text-[10px] px-1.5 py-0.5 rounded-md font-medium bg-red-500/10 text-red-700 dark:bg-red-500/20 dark:text-red-400">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <svg class="w-4 h-4 text-slate-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </summary>
                <div class="px-4 pb-4 pt-2 border-t border-slate-200/60 dark:border-slate-700/60">
                    {% if macro.description %}
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">{{ macro.description }}</p>
                    {% endif %}
                    <div class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                        <span class="font-semibold">Actions:</span>
                        {% for action in macro.actions %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 ml-1 mb-1">
                            {{ action.action_type | replace('_', ' ') | title }}
                        </span>
                        {% endfor %}
                    </div>
                    {% if can_manage_settings %}
                    <div class="flex gap-2">
                        <form method="POST" action="/admin/crm/inbox/macros/{{ macro.id }}/delete">
                            {% include "components/forms/csrf_input.html" %}
                            <button type="submit"
                                    onclick="return confirm('Delete this macro?')"
                                    class="inline-flex items-center justify-center gap-2 rounded-lg border border-rose-200 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 dark:border-rose-500/30 dark:bg-rose-500/10 dark:text-rose-200 dark:hover:bg-rose-500/20">
                                Delete
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">No macros yet. Create one to speed up repetitive actions.</p>
        {% endif %}
    </section>

    <div class="grid gap-6 lg:grid-cols-2">
        <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
            <div class="flex flex-wrap items-start justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Email inboxes</h2>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                        Manage multiple SMTP/IMAP/POP3 inboxes. Each inbox creates its own connector and target. Routing is configured in
                        <a href="/admin/integrations/channels" class="text-primary-600 hover:underline">Channels</a>.
                        If no routing is set, the newest inbox is used by default.
                    </p>
                </div>
                <a href="#add-email-inbox" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                    Add email inbox
                </a>
            </div>

            <div class="mt-5 space-y-4">
                {% if email_inboxes and email_inboxes|length > 0 %}
                    {% for inbox in email_inboxes %}
                    <details class="group rounded-xl border border-slate-200 bg-slate-50/60 p-4 open:bg-white dark:border-slate-700 dark:bg-slate-800/60 dark:open:bg-slate-900">
                        <summary class="flex cursor-pointer list-none items-center justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold text-slate-900 dark:text-white">{{ inbox.name or 'Email inbox' }}</div>
                                <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                                    Target {{ inbox.target_id }} · Connector {{ inbox.connector_id }}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                {% if inbox.is_active %}
                                <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-semibold text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Active</span>
                                {% else %}
                                <span class="rounded-full bg-amber-100 px-2 py-0.5 text-[11px] font-semibold text-amber-700 dark:bg-amber-500/20 dark:text-amber-200">Inactive</span>
                                {% endif %}
                                {% if inbox.polling_active %}
                                <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-semibold text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Polling on</span>
                                {% else %}
                                <span class="rounded-full bg-slate-200 px-2 py-0.5 text-[11px] font-semibold text-slate-700 dark:bg-slate-700 dark:text-slate-200">Polling off</span>
                                {% endif %}
                                {% if inbox.smtp %}
                                <span class="rounded-full bg-blue-100 px-2 py-0.5 text-[11px] font-semibold text-blue-700 dark:bg-blue-500/20 dark:text-blue-200">SMTP</span>
                                {% endif %}
                                <span class="text-xs text-slate-400 group-open:rotate-180 transition">▾</span>
                            </div>
                        </summary>

                        <div class="mt-4 border-t border-slate-200 pt-4 dark:border-slate-700">
                            <form method="POST" action="/admin/crm/inbox/email-connector?next=/admin/crm/inbox/settings" class="space-y-4">
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <input type="hidden" name="connector_id" value="{{ inbox.connector_id }}">
                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Name</label>
                                        <input name="name"
                                               value="{{ inbox.name or 'CRM Email' }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Polling interval (seconds)</label>
                                        <input name="poll_interval_seconds"
                                               type="number"
                                               min="1"
                                               value="{{ inbox.poll_interval_seconds if inbox.poll_interval_seconds is not none else '' }}"
                                               placeholder="300"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        <label class="mt-2 inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                            <input type="hidden" name="polling_enabled" value="0">
                                            <input type="checkbox" name="polling_enabled" value="1" {% if inbox.polling_active %}checked{% endif %}>
                                            Enable polling
                                        </label>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Rate limit per minute</label>
                                        <input name="rate_limit_per_minute"
                                               type="number"
                                               min="0"
                                               value="{{ inbox.rate_limit_per_minute if inbox.rate_limit_per_minute is not none else '' }}"
                                               placeholder="0"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                </div>
                                {% if not inbox.is_active %}
                                <div class="rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700 dark:border-amber-500/30 dark:bg-amber-500/10 dark:text-amber-200">
                                    This inbox is inactive. Activate it to enable routing and sending.
                                </div>
                                {% endif %}

                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">SMTP host</label>
                                        <input name="smtp_host"
                                               value="{{ inbox.smtp.host if inbox.smtp }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        <label class="mt-2 inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                            <input type="checkbox" name="smtp_enabled" {% if inbox.smtp %}checked{% endif %}>
                                            Enable SMTP
                                        </label>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">SMTP port</label>
                                            <input name="smtp_port"
                                                   value="{{ inbox.smtp.port if inbox.smtp }}"
                                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        </div>
                                        <div class="flex flex-col justify-end gap-2">
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="smtp_use_tls" {% if inbox.smtp and inbox.smtp.use_tls %}checked{% endif %}>
                                                TLS
                                            </label>
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="smtp_use_ssl" {% if inbox.smtp and inbox.smtp.use_ssl %}checked{% endif %}>
                                                SSL
                                            </label>
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="skip_smtp_test">
                                                Skip SMTP test
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">IMAP host</label>
                                        <input name="imap_host"
                                               value="{{ inbox.imap.host if inbox.imap }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">IMAP port</label>
                                            <input name="imap_port"
                                                   value="{{ inbox.imap.port if inbox.imap }}"
                                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        </div>
                                        <div class="flex flex-col justify-end gap-2">
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="imap_use_ssl" {% if inbox.imap and inbox.imap.use_ssl %}checked{% endif %}>
                                                SSL
                                            </label>
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="imap_search_all" {% if inbox.imap and inbox.imap.search_all %}checked{% endif %}>
                                                Fetch all (ignore unread)
                                            </label>
                                            <input name="imap_mailbox"
                                                   placeholder="Mailbox"
                                                   value="{{ inbox.imap.mailbox if inbox.imap }}"
                                                   class="w-full rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        </div>
                                    </div>
                                </div>

                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">POP3 host (optional)</label>
                                        <input name="pop3_host"
                                               value="{{ inbox.pop3.host if inbox.pop3 }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">POP3 port</label>
                                            <input name="pop3_port"
                                                   value="{{ inbox.pop3.port if inbox.pop3 }}"
                                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                        </div>
                                        <div class="flex items-end">
                                            <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" name="pop3_use_ssl" {% if inbox.pop3 and inbox.pop3.use_ssl %}checked{% endif %}>
                                                SSL
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Username</label>
                                        <input name="username"
                                               value="{{ inbox.auth_config.username if inbox.auth_config }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Password</label>
                                        <input name="password"
                                               type="password"
                                               autocomplete="new-password"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                </div>

                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">From email</label>
                                        <input name="from_email"
                                               value="{{ inbox.auth_config.from_email if inbox.auth_config }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">From name</label>
                                        <input name="from_name"
                                               value="{{ inbox.auth_config.from_name if inbox.auth_config }}"
                                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                    </div>
                                </div>

                                <div class="flex items-center justify-end gap-2 pt-2">
                                    {{ submit_button("Save inbox") }}
                                </div>
                            </form>
                            <form method="POST" action="/admin/crm/inbox/email-polling/reset?next=/admin/crm/inbox/settings" class="mt-2">
                                {% include "components/forms/csrf_input.html" %}
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <button type="submit"
                                        class="text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                                    Reset stuck polling run
                                </button>
                            </form>
                            <form method="POST"
                                  action="/admin/crm/inbox/email-check"
                                  hx-post="/admin/crm/inbox/email-check"
                                  hx-target="#email-check-{{ inbox.target_id }}"
                                  hx-swap="innerHTML"
                                  class="mt-2 flex flex-wrap items-center gap-2">
                                {% include "components/forms/csrf_input.html" %}
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <button type="submit"
                                        class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                                    Check inbox now
                                </button>
                                <button type="button"
                                        hx-post="/admin/crm/inbox/email-reset-cursor"
                                        hx-target="#email-check-{{ inbox.target_id }}"
                                        hx-swap="innerHTML"
                                        class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                                    Reset IMAP cursor
                                </button>
                                <span id="email-check-{{ inbox.target_id }}" class="text-xs text-slate-500"></span>
                            </form>
                            {% if not inbox.is_active %}
                            <form method="POST" action="/admin/crm/inbox/email-activate?next=/admin/crm/inbox/settings" class="mt-2">
                                {% include "components/forms/csrf_input.html" %}
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <input type="hidden" name="connector_id" value="{{ inbox.connector_id }}">
                                <button type="submit"
                                        class="text-xs font-semibold text-emerald-600 hover:text-emerald-700 dark:text-emerald-300 dark:hover:text-emerald-200">
                                    Activate inbox
                                </button>
                            </form>
                            {% endif %}
                            <form method="POST" action="/admin/crm/inbox/email-delete?next=/admin/crm/inbox/settings" class="mt-2">
                                {% include "components/forms/csrf_input.html" %}
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <input type="hidden" name="connector_id" value="{{ inbox.connector_id }}">
                                <button type="submit"
                                        class="text-xs font-semibold text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                                    Deactivate inbox
                                </button>
                            </form>
                        </div>
                    </details>
                    {% endfor %}
                {% else %}
                    <div class="rounded-lg border border-dashed border-slate-300 px-4 py-6 text-center text-sm text-slate-500 dark:border-slate-700 dark:text-slate-400">
                        No email inboxes configured yet.
                    </div>
                {% endif %}
            </div>

            <details id="add-email-inbox" class="mt-6 rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-900">
                <summary class="cursor-pointer text-sm font-semibold text-slate-900 dark:text-white">Add new email inbox</summary>
                <form method="POST" action="/admin/crm/inbox/email-connector?next=/admin/crm/inbox/settings" class="mt-4 space-y-4">
                    <input type="hidden" name="create_new" value="1">
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Name</label>
                            <input name="name"
                                   value="CRM Email"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Polling interval (seconds)</label>
                            <input name="poll_interval_seconds"
                                   type="number"
                                   min="1"
                                   placeholder="300"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            <label class="mt-2 inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                <input type="hidden" name="polling_enabled" value="0">
                                <input type="checkbox" name="polling_enabled" value="1">
                                Enable polling
                            </label>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Rate limit per minute</label>
                            <input name="rate_limit_per_minute"
                                   type="number"
                                   min="0"
                                   placeholder="0"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">SMTP host</label>
                            <input name="smtp_host"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            <label class="mt-2 inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                <input type="checkbox" name="smtp_enabled">
                                Enable SMTP
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-slate-600 dark:text-slate-300">SMTP port</label>
                                <input name="smtp_port"
                                       class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            </div>
                            <div class="flex flex-col justify-end gap-2">
                                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" name="smtp_use_tls">
                                    TLS
                                </label>
                                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" name="smtp_use_ssl">
                                    SSL
                                </label>
                                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" name="skip_smtp_test">
                                    Skip SMTP test
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">IMAP host</label>
                            <input name="imap_host"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-slate-600 dark:text-slate-300">IMAP port</label>
                                <input name="imap_port"
                                       class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            </div>
                            <div class="flex flex-col justify-end gap-2">
                                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" name="imap_use_ssl">
                                    SSL
                                </label>
                                <input name="imap_mailbox"
                                       placeholder="Mailbox"
                                       class="w-full rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            </div>
                        </div>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">POP3 host (optional)</label>
                            <input name="pop3_host"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-slate-600 dark:text-slate-300">POP3 port</label>
                                <input name="pop3_port"
                                       class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            </div>
                            <div class="flex items-end">
                                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" name="pop3_use_ssl">
                                    SSL
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Username</label>
                            <input name="username"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Password</label>
                            <input name="password"
                                   type="password"
                                   autocomplete="new-password"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">From email</label>
                            <input name="from_email"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 dark:text-slate-300">From name</label>
                            <input name="from_name"
                                   class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-2 pt-2">
                        {{ submit_button("Create inbox", loading_label="Creating...") }}
                    </div>
                </form>
            </details>
        </section>

        <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
            <div class="flex flex-wrap items-start justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">WhatsApp inboxes</h2>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                        Manage multiple WhatsApp phone numbers and tokens. Routing is configured in
                        <a href="/admin/integrations/channels" class="text-primary-600 hover:underline">Channels</a>.
                        If no routing is set, the newest inbox is used by default.
                    </p>
                </div>
                <a href="#add-whatsapp-inbox" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                    Add WhatsApp inbox
                </a>
            </div>

            <div class="mt-5 space-y-4">
                {% if whatsapp_inboxes and whatsapp_inboxes|length > 0 %}
                    {% for inbox in whatsapp_inboxes %}
                    <details class="group rounded-xl border border-slate-200 bg-slate-50/60 p-4 open:bg-white dark:border-slate-700 dark:bg-slate-800/60 dark:open:bg-slate-900">
                        <summary class="flex cursor-pointer list-none items-center justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold text-slate-900 dark:text-white">{{ inbox.name or 'WhatsApp inbox' }}</div>
                                <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                                    Target {{ inbox.target_id }} · Connector {{ inbox.connector_id }}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-semibold text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Active</span>
                                <span class="text-xs text-slate-400 group-open:rotate-180 transition">▾</span>
                            </div>
                        </summary>
                        <div class="mt-4 border-t border-slate-200 pt-4 dark:border-slate-700">
                            <form method="POST" action="/admin/crm/inbox/whatsapp-connector?next=/admin/crm/inbox/settings" class="space-y-4">
                                <input type="hidden" name="target_id" value="{{ inbox.target_id }}">
                                <input type="hidden" name="connector_id" value="{{ inbox.connector_id }}">
                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Name</label>
                                    <input name="name"
                                           value="{{ inbox.name or 'CRM WhatsApp' }}"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Phone number ID</label>
                                    <input name="phone_number_id"
                                           value="{{ inbox.phone_number_id if inbox.phone_number_id }}"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Business account ID</label>
                                    <input name="business_account_id"
                                           value="{{ inbox.business_account_id if inbox.business_account_id }}"
                                           placeholder="WhatsApp Business Account ID (WABA)"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Access token</label>
                                    <input name="access_token"
                                           type="password"
                                           autocomplete="new-password"
                                           placeholder="Enter a new token to update"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Base URL (optional)</label>
                                    <input name="base_url"
                                           value="{{ inbox.base_url if inbox.base_url }}"
                                           placeholder="https://graph.facebook.com/v19.0"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Rate limit per minute</label>
                                    <input name="rate_limit_per_minute"
                                           type="number"
                                           min="0"
                                           value="{{ inbox.rate_limit_per_minute if inbox.rate_limit_per_minute is not none else '' }}"
                                           placeholder="0"
                                           class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                </div>

                                <div class="flex items-center justify-end gap-2 pt-2">
                                    {{ submit_button("Save inbox") }}
                                </div>
                            </form>
                        </div>
                    </details>
                    {% endfor %}
                {% else %}
                    <div class="rounded-lg border border-dashed border-slate-300 px-4 py-6 text-center text-sm text-slate-500 dark:border-slate-700 dark:text-slate-400">
                        No WhatsApp inboxes configured yet.
                    </div>
                {% endif %}
            </div>

            <details id="add-whatsapp-inbox" class="mt-6 rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-900">
                <summary class="cursor-pointer text-sm font-semibold text-slate-900 dark:text-white">Add new WhatsApp inbox</summary>
                <form method="POST" action="/admin/crm/inbox/whatsapp-connector?next=/admin/crm/inbox/settings" class="mt-4 space-y-4">
                    <input type="hidden" name="create_new" value="1">
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Name</label>
                        <input name="name"
                               value="CRM WhatsApp"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>

                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Phone number ID</label>
                        <input name="phone_number_id"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Business account ID</label>
                        <input name="business_account_id"
                               placeholder="WhatsApp Business Account ID (WABA)"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>

                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Access token</label>
                        <input name="access_token"
                               type="password"
                               autocomplete="new-password"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>

                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Base URL (optional)</label>
                        <input name="base_url"
                               placeholder="https://graph.facebook.com/v19.0"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Rate limit per minute</label>
                        <input name="rate_limit_per_minute"
                               type="number"
                               min="0"
                               placeholder="0"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>

                    <div class="flex items-center justify-end gap-2 pt-2">
                        {{ submit_button("Create inbox", loading_label="Creating...") }}
                    </div>
                </form>
            </details>
        </section>
    </div>

    <!-- Meta (Facebook/Instagram) Connector -->
    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
        <div class="flex items-start justify-between gap-4">
            <div>
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Facebook & Instagram</h2>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Connect Facebook Pages and Instagram Business accounts for Messenger and DM support.</p>
                <div class="mt-2">
                    {% if meta_status and meta_status.connected %}
                    <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">
                        Connected
                    </span>
                    {% else %}
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-300">
                        Not connected
                    </span>
                    {% endif %}
                    <span class="ml-2 text-xs text-slate-500 dark:text-slate-400">
                        Pages: {{ meta_status.pages | length if meta_status else 0 }} · Instagram: {{ meta_status.instagram_accounts | length if meta_status else 0 }}
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Facebook icon -->
                <svg class="h-6 w-6 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                <!-- Instagram icon -->
                <svg class="h-6 w-6 text-[#E4405F]" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.757-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
                </svg>
            </div>
        </div>

        {% if meta_status and meta_status.connected %}
        <!-- Connected state: Show connected accounts -->
        <div class="mt-5 space-y-4">
            {% if meta_status.pages %}
            <div>
                <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">Connected Facebook Pages</h3>
                <div class="mt-2 space-y-2">
                    {% for page in meta_status.pages %}
                    <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 dark:border-slate-700 dark:bg-slate-800">
                        <div class="flex items-center gap-3">
                            {% if page.picture %}
                            <img src="{{ page.picture }}" alt="{{ page.name }}" class="h-10 w-10 rounded-full">
                            {% else %}
                            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-[#1877F2] text-white">
                                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                </svg>
                            </div>
                            {% endif %}
                            <div>
                                <div class="font-medium text-slate-900 dark:text-white">{{ page.name }}</div>
                                {% if page.category %}
                                <div class="text-xs text-slate-500 dark:text-slate-400">{{ page.category }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if page.has_error %}
                            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400">
                                Token Error
                            </span>
                            {% elif page.needs_refresh %}
                            <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">
                                Expires Soon
                            </span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                Connected
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if meta_status.instagram_accounts %}
            <div>
                <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">Connected Instagram Accounts</h3>
                <div class="mt-2 space-y-2">
                    {% for account in meta_status.instagram_accounts %}
                    <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 dark:border-slate-700 dark:bg-slate-800">
                        <div class="flex items-center gap-3">
                            {% if account.profile_picture_url %}
                            <img src="{{ account.profile_picture_url }}" alt="{{ account.username }}" class="h-10 w-10 rounded-full">
                            {% else %}
                            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-[#833AB4] via-[#E4405F] to-[#FCAF45] text-white">
                                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.757-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
                                </svg>
                            </div>
                            {% endif %}
                            <div>
                                <div class="font-medium text-slate-900 dark:text-white">@{{ account.username }}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Instagram Business</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if account.has_error %}
                            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400">
                                Token Error
                            </span>
                            {% elif account.needs_refresh %}
                            <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">
                                Expires Soon
                            </span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                Connected
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="flex items-center justify-between pt-2">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                    Tokens auto-refresh before expiry. Re-connect if you see errors.
                </p>
                <div class="flex items-center gap-2">
                    <a href="/admin/crm/meta/connect"
                       class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
                        Re-connect
                    </a>
                    {{ warning_button("Disconnect", "Confirm Disconnect", "Disconnect Meta integration? This will disable Facebook Messenger and Instagram DM support.", "/admin/crm/meta/disconnect", size="sm") }}
                </div>
            </div>
        </div>
        {% else %}
        <!-- Not connected state: Show connect button -->
        <div class="mt-5">
            <div class="rounded-lg border border-slate-200 bg-slate-50 p-6 text-center dark:border-slate-700 dark:bg-slate-800">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                    <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                </div>
                <h3 class="mt-4 text-sm font-medium text-slate-900 dark:text-white">Connect Meta accounts</h3>
                <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                    Link your Facebook Pages and Instagram Business accounts to receive and reply to messages directly from the inbox.
                </p>
                <a href="/admin/crm/meta/connect"
                   class="mt-4 inline-flex items-center gap-2 rounded-lg bg-[#1877F2] px-4 py-2 text-sm font-semibold text-white hover:bg-[#166FE5]">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Connect with Facebook
                </a>
            </div>
            <p class="mt-3 text-center text-xs text-slate-500 dark:text-slate-400">
                Requires a Facebook Developer App with Messenger and Instagram permissions.
            </p>
        </div>
        {% endif %}
    </section>

    <div class="mt-10 space-y-6" id="chat-widgets">
        <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
                <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Chat widgets</h2>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Manage website chat widgets, embed codes, and allowed domains.</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/admin/crm/widget"
                   class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                    View all
                </a>
                <a href="/admin/crm/widget/new"
                   class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-700">
                    New widget
                </a>
            </div>
        </div>

        {% set pad = 'px-6 py-3' %}
        {% call table_shell(table_id="inbox-widgets-table", color="blue", count=widgets | length) %}
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead>
                    <tr class="border-b border-slate-100 dark:border-slate-700/50">
                        <th scope="col" class="{{ pad }} text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Name</th>
                        <th scope="col" class="{{ pad }} text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Domains</th>
                        <th scope="col" class="{{ pad }} text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                        <th scope="col" class="{{ pad }} text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Embed</th>
                        <th scope="col" class="{{ pad }} text-right text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% if widgets %}
                    {% for widget in widgets %}
                    {% call table_row(color="blue") %}
                        <td class="whitespace-nowrap {{ pad }}">
                            <div class="flex items-center gap-3">
                                <div class="h-8 w-8 rounded-lg" style="background-color: {{ widget.primary_color }}"></div>
                                <div>
                                    <a href="/admin/crm/widget/{{ widget.id }}" class="font-medium text-slate-900 hover:text-blue-600 dark:text-white dark:hover:text-blue-400">
                                        {{ widget.name }}
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td class="whitespace-nowrap {{ pad }} text-sm text-slate-500 dark:text-slate-400">
                            {% if widget.allowed_domains %}
                                {{ widget.allowed_domains | join(', ') | truncate(40) }}
                            {% else %}
                                <span class="text-slate-400 italic">All domains</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap {{ pad }}">
                            {% if widget.is_active %}
                            <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-800 dark:bg-emerald-500/20 dark:text-emerald-300">
                                Active
                            </span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-500/20 dark:text-slate-400">
                                Inactive
                            </span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap {{ pad }} text-sm">
                            <button type="button"
                                    data-embed-code="{{ widget.embed_code | e }}"
                                    onclick="copyWidgetEmbed(this)"
                                    class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                                Copy
                            </button>
                        </td>
                        <td class="whitespace-nowrap {{ pad }} text-right text-sm">
                            <div class="flex items-center justify-end gap-2">
                                <a href="/admin/crm/widget/{{ widget.id }}"
                                   class="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:hover:bg-slate-800 dark:hover:text-slate-200"
                                   title="View & Edit">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </a>
                                {{ danger_button("Delete", "Confirm Delete", "Are you sure you want to delete this widget?", "/admin/crm/widget/" ~ widget.id ~ "/delete", size="sm") }}
                            </div>
                        </td>
                    {% endcall %}
                    {% endfor %}
                    {% else %}
                    {{ empty_state("No chat widgets", "Create a widget to embed on your website.", action_label="Create widget", action_href="/admin/crm/widget/new", colspan=5) }}
                    {% endif %}
                </tbody>
            </table>
        {% endcall %}
    </div>

    <div class="mt-10 space-y-6" id="crm-agents">
        <div>
            <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Teams and agents</h2>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Create teams and agents, then link agents to teams for routing.</p>
        </div>

        <div class="grid gap-6 lg:grid-cols-3">
            <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">New team</h3>
                <form method="POST" action="/admin/crm/inbox/teams" class="mt-5 space-y-4">
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Team name</label>
                        <input name="name"
                               required
                               placeholder="Support"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Notes</label>
                        <input name="notes"
                               placeholder="Handles inbound chat and email"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>
                    {{ submit_button("Create team", full_width=True, loading_label="Creating...") }}
                </form>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">New agent</h3>
                <form method="POST" action="/admin/crm/inbox/agents" class="mt-5 space-y-4">
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Person</label>
                        <div class="mt-1">
                        {{ typeahead_input("person_id", "/api/v1/search/people", placeholder="Search people...", required=true) }}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Title (optional)</label>
                        <input name="title"
                               placeholder="Support Agent"
                               class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                    </div>
                    {{ submit_button("Create agent", full_width=True, loading_label="Creating...") }}
                </form>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900">
                <h3 class="text-base font-semibold text-slate-900 dark:text-white">Assign agent to team</h3>
                <form method="POST" action="/admin/crm/inbox/agent-teams" class="mt-5 space-y-4">
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Team</label>
                        <select name="team_id" required
                                class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            <option value="">Select a team...</option>
                            {% for team in teams %}
                                <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300">Agent</label>
                        <select name="agent_id" required
                                class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                            <option value="">Select an agent...</option>
                            {% for agent in agents %}
                                {% set person = people_by_id.get(agent.person_id|string) %}
                                {% if person %}
                                    {% set label = person.first_name ~ ' ' ~ person.last_name ~ ((' (' ~ person.email ~ ')') if person.email else '') %}
                                {% else %}
                                    {% set label = agent.person_id|string %}
                                {% endif %}
                                <option value="{{ agent.id }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {{ submit_button("Assign agent", full_width=True) }}
                </form>
            </section>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
            {% set pad = 'px-6 py-3' %}
            {% call table_shell(table_id="inbox-teams-table", title="Teams", count=teams | length) %}
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                    <thead>
                        <tr class="border-b border-slate-100 dark:border-slate-700/50">
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Team</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Notes</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Agents</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                        {% if teams %}
                            {% for team in teams %}
                            {% set team_links = agent_teams | selectattr('team_id', 'equalto', team.id) | list %}
                            {% call table_row() %}
                                <td class="{{ pad }} text-sm font-medium text-slate-900 dark:text-white">{{ team.name }}</td>
                                <td class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ team.notes or '—' }}</td>
                                <td class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ team_links | length }}</td>
                                <td class="{{ pad }}">
                                    {% if team.is_active %}
                                    {{ status_badge("Active", "active", size="sm") }}
                                    {% else %}
                                    {{ status_badge("Inactive", "inactive", size="sm") }}
                                    {% endif %}
                                </td>
                            {% endcall %}
                            {% endfor %}
                        {% else %}
                            {{ empty_state("No teams yet", "Create a team to start routing inbox conversations.", colspan=4) }}
                        {% endif %}
                    </tbody>
                </table>
            {% endcall %}

	            {% call table_shell(table_id="inbox-agents-table", title="Agents", count=agents | length, search_name="agent_list_search", search_placeholder="Search agents...") %}
	                {% if can_manage_settings %}
	                <form id="bulk-agent-action-form" method="POST" action="/admin/crm/inbox/agents/bulk" class="mb-3 flex flex-wrap items-center gap-2">
	                    <select name="action"
	                            class="w-48 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
	                        <option value="deactivate">Deactivate selected</option>
	                    </select>
	                    {# Single control to toggle selection across the table. #}
	                    {% if (agents | length) > 1 %}
	                    <button type="button"
	                            data-agent-toggle-all
	                            class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
	                        Select all
	                    </button>
	                    {% endif %}
	                    <button type="submit"
	                            data-bulk-agent-submit
	                            disabled
	                            onclick="return confirm('Deactivate selected agents?')"
	                            class="rounded-md border border-red-200 bg-red-50 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-100 disabled:cursor-not-allowed disabled:opacity-50 dark:border-red-800/40 dark:bg-red-900/20 dark:text-red-300">
	                        Apply
	                    </button>
	                </form>
	                {% endif %}
	                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
	                    <thead>
	                        <tr class="border-b border-slate-100 dark:border-slate-700/50">
	                            <th class="{{ pad }} w-10 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
	                                {# Checkbox column header. #}
	                            </th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Agent</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Title</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Teams</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Presence</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Last Seen</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                            <th class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700" data-agent-table-body>
                        {% if agents %}
                            {% for agent in agents %}
                            {% set agent_links = agent_teams | selectattr('agent_id', 'equalto', agent.id) | list %}
                            {% set person = people_by_id.get(agent.person_id|string) %}
                            {% call table_row() %}
                                <td class="{{ pad }}">
                                    {% if can_manage_settings %}
                                    <input type="checkbox"
                                           name="agent_ids"
                                           value="{{ agent.id }}"
                                           form="bulk-agent-action-form"
                                           data-agent-select-item
                                           class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-900">
                                    {% endif %}
                                </td>
                                <td class="{{ pad }}">
                                    <div class="text-sm font-medium text-slate-900 dark:text-white">
                                        {% if person %}
                                            {{ person.first_name }} {{ person.last_name }}
                                        {% else %}
                                            {{ agent.person_id }}
                                        {% endif %}
                                    </div>
                                    {% if person and person.email %}
                                    <div class="text-xs text-slate-500 dark:text-slate-400">{{ person.email }}</div>
                                    {% endif %}
                                </td>
                                <td class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ agent.title or '—' }}</td>
                                <td class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">
                                    {% if agent_links %}
                                        <div class="flex flex-wrap gap-1">
                                            {% for link in agent_links %}
                                                {% set team = teams_by_id.get(link.team_id|string) %}
                                                {% if team %}
                                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                                                    {{ team.name }}
                                                    {% if can_manage_settings %}
                                                    <form method="POST" action="/admin/crm/inbox/agent-teams/{{ link.id }}/remove">
                                                        <button type="submit" class="ml-1 rounded-full px-1 text-xs text-slate-500 hover:text-red-600 dark:text-slate-400">x</button>
                                                    </form>
                                                    {% endif %}
                                                </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td class="{{ pad }}" data-agent-id="{{ agent.id }}">
                                    <div class="flex items-center gap-2 text-xs font-semibold text-slate-500 dark:text-slate-400">
                                        <span class="h-2 w-2 rounded-full bg-slate-400" data-agent-presence-dot></span>
                                        <span data-agent-presence-label>Offline</span>
                                    </div>
                                </td>
                                <td class="{{ pad }} text-xs text-slate-500 dark:text-slate-400" data-agent-last-seen>—</td>
                                <td class="{{ pad }}">
                                    {% if agent.is_active %}
                                    {{ status_badge("Active", "active", size="sm") }}
                                    {% else %}
                                    {{ status_badge("Inactive", "inactive", size="sm") }}
                                    {% endif %}
                                </td>
                                <td class="{{ pad }}">
                                    {% if can_manage_settings %}
                                        <div class="flex flex-col gap-2">
                                            <form method="POST" action="/admin/crm/inbox/agent-teams" class="flex items-center gap-2">
                                                <input type="hidden" name="agent_id" value="{{ agent.id }}">
                                                <select name="team_id"
                                                        class="w-36 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-800 shadow-sm focus:border-primary-500 focus:outline-none dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                                                    <option value="">Add team...</option>
                                                    {% for team in teams %}
                                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="submit" class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300">
                                                    Add
                                                </button>
                                            </form>
                                            <div class="flex items-center gap-2">
                                                {% if agent.is_active %}
                                                <form method="POST" action="/admin/crm/inbox/agents/{{ agent.id }}/deactivate">
                                                    <button type="submit" class="rounded-md border border-red-200 bg-red-50 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-100 dark:border-red-800/40 dark:bg-red-900/20 dark:text-red-300">
                                                        Deactivate
                                                    </button>
                                                </form>
                                                {% else %}
                                                <form method="POST" action="/admin/crm/inbox/agents/{{ agent.id }}/activate">
                                                    <button type="submit" class="rounded-md border border-emerald-200 bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700 hover:bg-emerald-100 dark:border-emerald-800/40 dark:bg-emerald-900/20 dark:text-emerald-300">
                                                        Activate
                                                    </button>
                                                </form>
                                                {% endif %}
                                                <form method="POST"
                                                      action="/admin/crm/inbox/agents/{{ agent.id }}/delete"
                                                      onsubmit="return confirm('Delete this agent permanently? This cannot be undone.')">
                                                    <button type="submit" class="rounded-md border border-red-300 bg-red-100 px-2 py-1 text-xs font-medium text-red-800 hover:bg-red-200 dark:border-red-700/60 dark:bg-red-900/30 dark:text-red-200">
                                                        Delete
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-xs text-slate-500 dark:text-slate-400">Read only</span>
                                    {% endif %}
                                </td>
                            {% endcall %}
                            {% endfor %}
                        {% else %}
                            {{ empty_state("No agents yet", "Create an agent to start routing inbox conversations.", colspan=8) }}
                        {% endif %}
                    </tbody>
                </table>
            {% endcall %}
        </div>
    </div>
</div>
<script>
function copyWidgetEmbed(button) {
    const code = button.getAttribute('data-embed-code');
    if (!code) return;
    navigator.clipboard.writeText(code).then(() => {
        const original = button.textContent;
        button.textContent = 'Copied';
        setTimeout(() => {
            button.textContent = original;
        }, 1500);
    });
}

function _presenceDotClass(status) {
    if (status === 'online') return 'bg-emerald-500';
    if (status === 'away') return 'bg-amber-500';
    if (status === 'on_break') return 'bg-slate-400';
    return 'bg-rose-500';
}

function _presenceLabel(status) {
    if (status === 'online') return 'Online';
    if (status === 'away') return 'Away';
    if (status === 'on_break') return 'On break';
    return 'Offline';
}

function _formatLastSeen(value) {
    if (!value) return '—';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '—';
    const diffMs = Date.now() - date.getTime();
    if (diffMs < 0) return 'just now';
    const seconds = Math.floor(diffMs / 1000);
    if (seconds < 45) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

function updateAgentPresence() {
    fetch('/crm/agents/presence?limit=200&stale_after_minutes=5', {
        headers: { 'Accept': 'application/json' }
    })
    .then((response) => response.ok ? response.json() : null)
    .then((data) => {
        if (!data || !Array.isArray(data.items)) return;
        const byId = {};
        const lastSeenById = {};
        for (const item of data.items) {
            if (!item || !item.agent_id) continue;
            byId[String(item.agent_id)] = item.effective_status || item.status || 'offline';
            lastSeenById[String(item.agent_id)] = item.last_seen_at || null;
        }
        document.querySelectorAll('td[data-agent-id]').forEach((cell) => {
            const agentId = cell.getAttribute('data-agent-id');
            const status = byId[String(agentId)] || 'offline';
            const dot = cell.querySelector('[data-agent-presence-dot]');
            const label = cell.querySelector('[data-agent-presence-label]');
            const lastSeen = cell.parentElement?.querySelector('[data-agent-last-seen]');
            if (dot) {
                dot.classList.remove('bg-emerald-500', 'bg-amber-500', 'bg-slate-400', 'bg-rose-500');
                dot.classList.add(_presenceDotClass(status));
            }
            if (label) {
                label.textContent = _presenceLabel(status);
            }
            if (lastSeen) {
                const lastSeenValue = lastSeenById[String(agentId)];
                lastSeen.textContent = _formatLastSeen(lastSeenValue);
                if (lastSeenValue) {
                    lastSeen.setAttribute('title', new Date(lastSeenValue).toLocaleString());
                } else {
                    lastSeen.removeAttribute('title');
                }
            }
        });
    })
    .catch(() => {});
}

function initAgentListSearch() {
    const searchInput = document.querySelector('input[name="agent_list_search"]');
    const tableBody = document.querySelector('[data-agent-table-body]');
    if (!searchInput || !tableBody) return;

    const agentRows = Array.from(tableBody.querySelectorAll('tr'))
        .filter((row) => row.querySelector('td[data-agent-id]'));

    const filterRows = () => {
        const query = String(searchInput.value || '').trim().toLowerCase();
        agentRows.forEach((row) => {
            const text = (row.textContent || '').toLowerCase();
            row.style.display = !query || text.includes(query) ? '' : 'none';
        });
    };

    searchInput.addEventListener('input', filterRows);
    filterRows();
}

function initBulkAgentActions() {
    const toggleAll = document.querySelector('[data-agent-toggle-all]');
    const submitButton = document.querySelector('[data-bulk-agent-submit]');
    const itemSelector = 'input[data-agent-select-item]';

    if (!submitButton) return;

    const getItems = () => Array.from(document.querySelectorAll(itemSelector));

    const syncState = () => {
        const items = getItems();
        const checkedItems = items.filter((item) => item.checked);
        submitButton.disabled = checkedItems.length === 0;
        if (toggleAll) {
            toggleAll.textContent =
                checkedItems.length > 0 && checkedItems.length === items.length ? 'Clear all' : 'Select all';
        }
    };

    // Delegate change handling so it still works if the table content is re-rendered.
    document.addEventListener('change', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.matches(itemSelector)) return;
        syncState();
    });

    if (toggleAll) {
        toggleAll.addEventListener('click', () => {
            const items = getItems();
            const checkedItems = items.filter((item) => item.checked);
            const shouldClear = checkedItems.length > 0 && checkedItems.length === items.length;
            items.forEach((item) => {
                item.checked = !shouldClear;
            });
            syncState();
        });
    }

    syncState();
}

document.addEventListener('DOMContentLoaded', () => {
    initAgentListSearch();
    initBulkAgentActions();
    updateAgentPresence();
    setInterval(updateAgentPresence, 60000);
});
</script>
{% endblock %}

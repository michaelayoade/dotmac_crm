<!-- Contact Header -->
<div class="border-b border-slate-800/60" x-data="{ open: true }">
    <div class="px-4 py-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Contact</h3>
            <div class="flex items-center gap-2">
                <button type="button"
                        @click="open = !open"
                        class="inline-flex h-6 w-6 items-center justify-center rounded-lg border border-slate-700/50 bg-slate-900/40 text-[13px] font-semibold text-slate-300 hover:text-white hover:bg-slate-800/60 transition-colors"
                        aria-label="Toggle contact details">
                    <span x-text="open ? '–' : '+'"></span>
                </button>
                {% if show_close is not defined or show_close %}
                <button @click="showContactPanel = false" class="lg:hidden p-1.5 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800/60 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        <div class="mb-3" x-show="open" x-collapse>
            <a href="/admin/crm/contacts/{{ contact.id }}/edit"
               class="inline-flex items-center gap-2 rounded-lg border border-slate-700/50 bg-slate-900/40 px-3 py-1.5 text-[11px] font-semibold text-slate-200 hover:bg-slate-800/60 transition-colors">
                <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Complete Contact
            </a>
        </div>
    </div>
    <div class="px-4 pb-4" x-show="open" x-collapse>
        <!-- Contact card -->
        <div class="contact-glow rounded-2xl bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700/50 p-3">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-primary-500/20 to-violet-500/20 border border-primary-500/30 flex items-center justify-center text-lg font-bold text-white">
                    {{ contact.avatar_initials }}
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-base font-semibold text-white truncate">{{ contact.name }}</h4>
                    <p class="text-xs text-slate-400 truncate">{{ contact.company }}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-[11px] text-slate-300">
                <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Email</p>
                    <p class="truncate">{{ contact.email or '—' }}</p>
                </div>
                <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Phone</p>
                    <p class="truncate">{{ contact.phone or '—' }}</p>
                </div>
                <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Linked</p>
                    <p class="truncate">{{ contact.company or contact.name or '—' }}</p>
                </div>
                <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Status</p>
                    <p class="truncate">{{ 'Active' if contact.is_active else 'Inactive' }}</p>
                </div>
            </div>

            <!-- Contact channels -->
            <div class="space-y-1.5">
                {% for channel in contact.channels %}
                <div class="flex items-center gap-3 px-2.5 py-1.5 rounded-lg bg-slate-800/40 border border-slate-700/30">
                    <div class="w-7 h-7 rounded-lg channel-{{ channel.type }} flex items-center justify-center" style="background: rgba(var(--channel-color), 0.15);">
                        {% if channel.type == 'email' %}
                        <svg class="w-3.5 h-3.5" style="color: rgb(var(--channel-color));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        {% elif channel.type == 'whatsapp' %}
                        <svg class="w-3.5 h-3.5" style="color: rgb(var(--channel-color));" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01A9.816 9.816 0 0012.04 2z"/>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-white truncate font-mono-tight">{{ channel.address }}</p>
                        <p class="text-[10px] text-slate-500 capitalize">{{ channel.type }}</p>
                    </div>
                    {% if channel.verified %}
                    <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% if conversation_id %}
<div class="px-4 py-3 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Resolve Conversation</h3>
    <form method="post"
          action="/admin/crm/inbox/conversation/{{ conversation_id }}/resolve"
          hx-post="/admin/crm/inbox/conversation/{{ conversation_id }}/resolve"
          hx-target="#contact-details"
          hx-swap="innerHTML"
          hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'}); htmx.ajax('GET', '/admin/crm/inbox/conversation/{{ conversation_id }}', {target:'#message-thread', swap:'innerHTML'})"
          class="space-y-2.5 rounded-xl bg-slate-800/30 border border-slate-700/30 p-2.5">
        <div class="relative" data-typeahead-url="/api/v1/search/people" data-typeahead-min="2" data-typeahead-limit="8">
            <label class="block text-[10px] text-slate-500 mb-1">Person</label>
            <input type="text"
                   name="person_search"
                   data-typeahead-input
                   autocomplete="off"
                   placeholder="Search name, email, phone"
                   class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200" />
            <input type="hidden" name="person_id" data-typeahead-hidden required>
            <div data-typeahead-results></div>
        </div>
        <div class="relative" data-typeahead-url="/api/v1/search/subscribers" data-typeahead-min="2" data-typeahead-limit="8">
            <label class="block text-[10px] text-slate-500 mb-1">Subscriber (optional)</label>
            <input type="text"
                   name="subscriber_search"
                   data-typeahead-input
                   autocomplete="off"
                   placeholder="Search subscriber number or name"
                   class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200" />
            <input type="hidden" name="subscriber_id" data-typeahead-hidden>
            <div data-typeahead-results></div>
        </div>
        <div class="grid grid-cols-2 gap-1.5">
            <div>
                <label class="block text-[10px] text-slate-500 mb-1">Channel Type</label>
                <select name="channel_type"
                        class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200">
                    <option value="">Auto (latest inbound)</option>
                    <option value="email">Email</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="facebook_messenger">Facebook</option>
                    <option value="instagram_dm">Instagram</option>
                </select>
            </div>
            <div>
                <label class="block text-[10px] text-slate-500 mb-1">Channel Address</label>
                <input name="channel_address"
                       placeholder="address or handle"
                       class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200" />
            </div>
        </div>
        <p class="text-[10px] text-slate-500">Leave channel fields blank to reuse the latest inbound channel.</p>
        <div class="flex justify-end pt-0.5">
            <button type="submit" class="text-[10px] font-semibold text-primary-400 hover:text-primary-300">Link contact</button>
        </div>
    </form>
</div>
{% endif %}

<!-- Tags -->
{% if contact.tags %}
<div class="px-4 py-3 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Tags</h3>
    <div class="flex flex-wrap gap-2">
        {% for tag in contact.tags %}
        <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
            {% if tag == 'VIP' %}bg-amber-500/10 text-amber-400 border border-amber-500/20
            {% elif tag == 'Enterprise' %}bg-violet-500/10 text-violet-400 border border-violet-500/20
            {% else %}bg-slate-700/50 text-slate-300 border border-slate-600/30{% endif %}">
            {{ tag }}
        </span>
        {% endfor %}
        <button class="inline-flex items-center justify-center w-6 h-6 rounded-lg bg-slate-800/40 border border-slate-700/30 text-slate-500 hover:text-white hover:bg-slate-700/60 transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
        </button>
    </div>
</div>
{% endif %}

<!-- Subscriber Info -->
{% if contact.subscriber %}
<div class="px-4 py-3 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Subscription</h3>
    <a href="/admin/subscribers/{{ contact.subscriber.id }}"
       class="block rounded-xl bg-slate-800/30 border border-slate-700/30 p-2.5 hover:bg-slate-800/50 hover:border-slate-600/50 transition-all group">
        <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-mono-tight text-slate-400">{{ contact.subscriber.account_number }}</span>
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-medium
                {% if contact.subscriber.status == 'active' %}bg-green-500/10 text-green-400 border border-green-500/20
                {% else %}bg-slate-500/10 text-slate-400 border border-slate-500/20{% endif %}">
                <span class="w-1 h-1 rounded-full {% if contact.subscriber.status == 'active' %}bg-green-500{% else %}bg-slate-500{% endif %}"></span>
                {{ contact.subscriber.status | capitalize }}
            </span>
        </div>
        <p class="text-sm font-medium text-white mb-0.5">{{ contact.subscriber.plan }}</p>
        <p class="text-[10px] text-slate-500">Customer since {{ contact.subscriber.since }}</p>
        <div class="mt-1.5 flex items-center gap-1 text-xs text-primary-400 opacity-0 group-hover:opacity-100 transition-opacity">
            View profile
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </div>
    </a>
</div>
{% endif %}

<!-- Stats -->
<div class="px-4 py-3 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Activity</h3>
    <div class="grid grid-cols-2 gap-2">
        <div class="rounded-xl bg-slate-800/30 border border-slate-700/30 p-2.5 text-center">
            <p class="text-2xl font-bold text-white font-display">{{ contact.total_conversations }}</p>
            <p class="text-[10px] text-slate-500 mt-0.5">Conversations</p>
        </div>
        <div class="rounded-xl bg-slate-800/30 border border-slate-700/30 p-2.5 text-center">
            <p class="text-2xl font-bold text-white font-display">{{ contact.avg_response_time }}</p>
            <p class="text-[10px] text-slate-500 mt-0.5">Avg Response</p>
        </div>
    </div>
</div>

<div class="px-4 py-3 border-b border-slate-800/60" x-data="{ tab: 'recent', open: true }">
    <div class="flex items-center justify-between mb-2">
        <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Conversations</h3>
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1 rounded-lg border border-slate-700/40 bg-slate-900/50 p-1" x-show="open" x-collapse>
                <button type="button"
                        @click="tab = 'recent'"
                        :class="tab === 'recent' ? 'bg-slate-700/60 text-white' : 'text-slate-400'"
                        class="px-2 py-1 text-[10px] font-semibold rounded-md transition-colors">
                    Recent
                </button>
                <button type="button"
                        @click="tab = 'resolved'"
                        :class="tab === 'resolved' ? 'bg-slate-700/60 text-white' : 'text-slate-400'"
                        class="px-2 py-1 text-[10px] font-semibold rounded-md transition-colors">
                    Resolved
                </button>
            </div>
            <button type="button"
                    @click="open = !open"
                    class="inline-flex h-6 w-6 items-center justify-center rounded-lg border border-slate-700/50 bg-slate-900/40 text-[13px] font-semibold text-slate-300 hover:text-white hover:bg-slate-800/60 transition-colors"
                    aria-label="Toggle conversations">
                <span x-text="open ? '–' : '+'"></span>
            </button>
        </div>
    </div>

    <div x-show="open" x-collapse>
        <div x-show="tab === 'recent'" class="space-y-2">
        {% if contact.recent_conversations %}
        {% for conv in contact.recent_conversations %}
        <a href="{{ conv.href }}"
           class="block rounded-xl bg-slate-800/30 border border-slate-700/30 p-3 hover:bg-slate-800/50 hover:border-slate-600/50 transition-all">
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-2 min-w-0">
                    <p class="text-xs font-semibold text-white truncate">{{ conv.subject }}</p>
                    {% if conv.channel == 'comments' and conv.platform_label %}
                    <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full border border-slate-700/60 text-slate-400 bg-slate-900/60">
                        {{ conv.platform_label }}
                    </span>
                    {% endif %}
                    {% if conv.channel == 'comments' and conv.comment_count and conv.comment_count > 1 %}
                    <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full border border-slate-700/60 text-slate-400 bg-slate-900/60">
                        {{ conv.comment_count }} comments
                    </span>
                    {% endif %}
                </div>
                <span class="text-[10px] text-slate-500">{{ conv.updated_at }}</span>
            </div>
            <p class="text-[10px] text-slate-400 mt-1 line-clamp-2">{{ conv.preview }}</p>
            <p class="text-[10px] text-slate-500 mt-1">{{ conv.status | replace('_', ' ') | title }}</p>
            {% if conv.channel == 'comments' and conv.older_comments %}
            <div class="mt-2 flex flex-wrap gap-2 text-[10px] text-slate-500">
                <span class="uppercase tracking-wide text-slate-500">Older</span>
                {% for older in conv.older_comments %}
                <a class="rounded-full border border-slate-700/60 px-2 py-0.5 text-slate-400 hover:text-white"
                   href="{{ older.href }}">
                    {{ older.label }}
                </a>
                {% endfor %}
                {% if conv.older_more and conv.older_more > 0 %}
                <span class="text-slate-500">+{{ conv.older_more }} more</span>
                {% endif %}
            </div>
            {% endif %}
        </a>
        {% endfor %}
        {% else %}
        <p class="text-[10px] text-slate-500">No conversations yet.</p>
        {% endif %}
        </div>

        <div x-show="tab === 'resolved'" x-cloak class="space-y-2">
        {% if contact.resolved_conversations %}
        {% for conv in contact.resolved_conversations %}
        <a href="{{ conv.href }}"
           class="block rounded-xl bg-slate-800/30 border border-slate-700/30 p-3 hover:bg-slate-800/50 hover:border-slate-600/50 transition-all">
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-2 min-w-0">
                    <p class="text-xs font-semibold text-white truncate">{{ conv.subject }}</p>
                    {% if conv.channel == 'comments' and conv.platform_label %}
                    <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full border border-slate-700/60 text-slate-400 bg-slate-900/60">
                        {{ conv.platform_label }}
                    </span>
                    {% endif %}
                    {% if conv.channel == 'comments' and conv.comment_count and conv.comment_count > 1 %}
                    <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full border border-slate-700/60 text-slate-400 bg-slate-900/60">
                        {{ conv.comment_count }} comments
                    </span>
                    {% endif %}
                </div>
                <span class="text-[10px] text-slate-500">{{ conv.updated_at }}</span>
            </div>
            <p class="text-[10px] text-slate-400 mt-1 line-clamp-2">{{ conv.preview }}</p>
            <p class="text-[10px] text-slate-500 mt-1">{{ conv.status | replace('_', ' ') | title }}</p>
        </a>
        {% endfor %}
        {% else %}
        <p class="text-[10px] text-slate-500">No resolved conversations.</p>
        {% endif %}
        </div>
    </div>
</div>

<!-- Conversation Assignments -->
{% if contact.conversations %}
<div class="px-5 py-4 border-b border-slate-800/60" x-data="{ open: false }">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Conversation Assignments</h3>
        <button type="button"
                @click="open = !open"
                class="inline-flex h-6 w-6 items-center justify-center rounded-lg border border-slate-700/50 bg-slate-900/40 text-[13px] font-semibold text-slate-300 hover:text-white hover:bg-slate-800/60 transition-colors"
                aria-label="Toggle conversation assignments">
            <span x-text="open ? '–' : '+'"></span>
        </button>
    </div>
    <div class="space-y-3" x-show="open" x-collapse>
        {% for conv in contact.conversations %}
        <form method="post"
              action="/admin/crm/inbox/conversation/{{ conv.id }}/assignment"
              hx-post="/admin/crm/inbox/conversation/{{ conv.id }}/assignment"
              hx-target="#contact-details"
              hx-swap="innerHTML"
              class="rounded-xl bg-slate-800/30 border border-slate-700/30 p-3 space-y-2">
            <div class="flex items-center justify-between gap-2">
                <div class="min-w-0">
                    <p class="text-xs font-semibold text-white truncate">{{ conv.subject }}</p>
                    <p class="text-[10px] text-slate-500">{{ conv.status | replace('_', ' ') | title }}</p>
                </div>
                <button type="submit" class="text-[10px] font-semibold text-primary-400 hover:text-primary-300">Save</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1">Agent</label>
                    <select name="agent_id"
                            class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200">
                        <option value="">Unassigned</option>
                        {% for agent in agents or [] %}
                        {% set label = agent_labels.get(agent.id|string, 'Agent ' ~ (agent.id|string|truncate(8, True, ''))) %}
                        <option value="{{ agent.id }}" {% if conv.agent_id == agent.id|string %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 mb-1">Team</label>
                    <select name="team_id"
                            class="w-full rounded-lg border border-slate-700/50 bg-slate-900/60 px-2 py-1.5 text-[11px] text-slate-200">
                        <option value="">Unassigned</option>
                        {% for team in teams or [] %}
                        <option value="{{ team.id }}" {% if conv.team_id == team.id|string %}selected{% endif %}>{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent Tickets -->
{% if contact.recent_tickets %}
<div class="px-5 py-4 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Recent Tickets</h3>
    <div class="space-y-2">
        {% for ticket in contact.recent_tickets %}
        <a href="{{ ticket.href }}"
           class="flex items-center justify-between px-3 py-2 rounded-lg bg-slate-800/30 border border-slate-700/30 hover:bg-slate-800/50 transition-colors group">
            <div class="flex-1 min-w-0">
                <p class="text-xs font-mono-tight text-slate-400">{{ ticket.label }}</p>
                <p class="text-xs text-white truncate">{{ ticket.subject }}</p>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium
                {% if ticket.status == 'resolved' %}bg-green-500/10 text-green-400
                {% elif ticket.status == 'closed' %}bg-slate-500/10 text-slate-400
                {% else %}bg-yellow-500/10 text-yellow-400{% endif %}">
                {{ ticket.status | capitalize }}
            </span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent Projects -->
{% if contact.recent_projects %}
<div class="px-5 py-4 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Active Projects</h3>
    <div class="space-y-2">
        {% for project in contact.recent_projects %}
        <a href="{{ project.href }}"
           class="flex items-center justify-between px-3 py-2 rounded-lg bg-slate-800/30 border border-slate-700/30 hover:bg-slate-800/50 transition-colors group">
            <div class="flex-1 min-w-0">
                <p class="text-xs font-mono-tight text-slate-400">{{ project.id }}</p>
                <p class="text-xs text-white truncate">{{ project.name }}</p>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium
                {% if project.status == 'active' %}bg-emerald-500/10 text-emerald-400
                {% elif project.status == 'on_hold' %}bg-amber-500/10 text-amber-400
                {% elif project.status == 'planned' %}bg-sky-500/10 text-sky-400
                {% elif project.status == 'canceled' %}bg-slate-500/10 text-slate-400
                {% else %}bg-slate-500/10 text-slate-400{% endif %}">
                {{ project.status | replace('_', ' ') | title }}
            </span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent Tasks -->
{% if contact.recent_tasks %}
<div class="px-5 py-4 border-b border-slate-800/60">
    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Recent Tasks</h3>
    <div class="space-y-2">
        {% for task in contact.recent_tasks %}
        <a href="{{ task.href }}"
           class="flex items-center justify-between px-3 py-2 rounded-lg bg-slate-800/30 border border-slate-700/30 hover:bg-slate-800/50 transition-colors group">
            <div class="flex-1 min-w-0">
                <p class="text-xs font-mono-tight text-slate-400">{{ task.label }}</p>
                <p class="text-xs text-white truncate">{{ task.title }}</p>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium
                {% if task.status == 'done' %}bg-emerald-500/10 text-emerald-400
                {% elif task.status == 'in_progress' %}bg-sky-500/10 text-sky-400
                {% elif task.status == 'blocked' %}bg-amber-500/10 text-amber-400
                {% elif task.status == 'todo' %}bg-slate-500/10 text-slate-400
                {% else %}bg-slate-500/10 text-slate-400{% endif %}">
                {{ task.status | replace('_', ' ') | title }}
            </span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Notes -->
<div class="px-5 py-4" x-data="{ open: false }">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Notes</h3>
        <div class="flex items-center gap-2">
            <button type="button"
                    @click="open = !open"
                    class="inline-flex h-6 w-6 items-center justify-center rounded-lg border border-slate-700/50 bg-slate-900/40 text-[13px] font-semibold text-slate-300 hover:text-white hover:bg-slate-800/60 transition-colors"
                    aria-label="Toggle notes">
                <span x-text="open ? '–' : '+'"></span>
            </button>
            <button class="p-1 rounded-lg text-slate-500 hover:text-white hover:bg-slate-800/60 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
            </button>
        </div>
    </div>
    <div x-show="open" x-collapse>
        {% if contact.notes %}
        <p class="text-xs text-slate-400 leading-relaxed">{{ contact.notes }}</p>
        {% else %}
        <p class="text-xs text-slate-500 italic">No notes added yet</p>
        {% endif %}
    </div>
</div>


<!-- Actions -->
<div class="px-5 py-4 border-t border-slate-800/60 mt-auto">
    <div class="grid {% if (show_full_link is defined and not show_full_link) and contact.person_id and not contact.subscriber %}grid-cols-2{% elif show_full_link is not defined or show_full_link %}grid-cols-2{% else %}grid-cols-1{% endif %} gap-2">
        {% if show_full_link is not defined or show_full_link %}
        <a href="/admin/crm/contacts/{{ contact.id }}"
           class="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl bg-slate-800/50 border border-slate-700/50 text-xs font-medium text-slate-300 hover:bg-slate-700/60 hover:text-white transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            View Full
        </a>
        {% endif %}
        {% if (show_full_link is defined and not show_full_link) and contact.person_id and not contact.subscriber %}
        <button type="button"
                @click="openConvert('{{ contact.person_id }}', {{ (contact.name or 'Contact') | tojson }})"
                class="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl bg-emerald-500/10 border border-emerald-500/30 text-xs font-medium text-emerald-400 hover:bg-emerald-500/20 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Convert
        </button>
        {% endif %}
        <a href="/admin/crm/leads/new?contact_id={{ contact.id }}"
           class="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl bg-primary-500/10 border border-primary-500/30 text-xs font-medium text-primary-400 hover:bg-primary-500/20 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Lead
        </a>
    </div>
</div>

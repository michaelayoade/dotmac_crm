{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import sortable_table_head, table_shell, table_row, empty_state, column_picker %}

{% block title %}Campaigns - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/crm/inbox" class="hover:text-primary-600">CRM</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">Campaigns</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Campaigns</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Manage email and WhatsApp campaigns and nurture sequences.</p>
        </div>
        <a href="/admin/crm/campaigns/new" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            New Campaign
        </a>
    </div>

    <!-- Status Tabs -->
    <div class="flex flex-wrap gap-2">
        <a href="/admin/crm/campaigns"
           class="rounded-lg px-3 py-1.5 text-sm font-medium transition-colors {{ 'bg-primary-100 text-primary-700 dark:bg-primary-600/20 dark:text-primary-400' if not filter_status else 'text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800' }}">
            All <span class="ml-1 text-xs">({{ status_counts.total }})</span>
        </a>
        {% for st in ['draft', 'scheduled', 'sending', 'sent', 'completed', 'cancelled'] %}
        <a href="/admin/crm/campaigns?status={{ st }}"
           class="rounded-lg px-3 py-1.5 text-sm font-medium transition-colors {{ 'bg-primary-100 text-primary-700 dark:bg-primary-600/20 dark:text-primary-400' if filter_status == st else 'text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800' }}">
            {{ st|capitalize }} <span class="ml-1 text-xs">({{ status_counts.get(st, 0) }})</span>
        </a>
        {% endfor %}
    </div>

    <!-- Search -->
    <form method="get" class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="flex flex-col gap-4">
            <div class="flex gap-4">
                <div class="flex-1">
                    <input type="text" name="search" value="{{ search }}" placeholder="Search campaigns..."
                           class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                {% if filter_status %}
                <input type="hidden" name="status" value="{{ filter_status }}">
                {% endif %}
                <button type="submit" class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">Search</button>
                <a href="/admin/crm/campaigns" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200">Reset</a>
            </div>
            <div class="flex justify-end">
                {{ column_picker("campaign", [
                    {"key": "name", "label": "Campaign", "default_visible": true, "required": true},
                    {"key": "type", "label": "Type", "default_visible": true},
                    {"key": "status", "label": "Status", "default_visible": true},
                    {"key": "recipients", "label": "Recipients", "default_visible": true},
                    {"key": "sent", "label": "Sent", "default_visible": true},
                    {"key": "created", "label": "Created", "default_visible": true},
                    {"key": "channel", "label": "Channel", "default_visible": false},
                    {"key": "subject", "label": "Subject", "default_visible": false},
                    {"key": "delivered", "label": "Delivered", "default_visible": false},
                    {"key": "failed", "label": "Failed", "default_visible": false},
                    {"key": "opened", "label": "Opened", "default_visible": false},
                    {"key": "clicked", "label": "Clicked", "default_visible": false},
                    {"key": "scheduled", "label": "Scheduled", "default_visible": false},
                    {"key": "completed", "label": "Completed", "default_visible": false}
                ], "primary") }}
            </div>
        </div>
    </form>

    <!-- Campaign Table -->
    {% set pad = 'px-6 py-3' %}
    {% set _sort_params = [] %}
    {% if filter_status %}{% set _ = _sort_params.append('status=' ~ filter_status|urlencode) %}{% endif %}
    {% if search %}{% set _ = _sort_params.append('search=' ~ search|urlencode) %}{% endif %}
    {% set sort_extra = _sort_params | join('&') %}

    {% call table_shell(table_id="campaigns-table", title="Campaigns", count=campaigns | length) %}
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            {{ sortable_table_head(
                columns=[
                    {'label': 'Campaign', 'key': 'name', 'attrs': {'data-campaign-column': 'name'}},
                    {'label': 'Type', 'sortable': false, 'attrs': {'data-campaign-column': 'type'}},
                    {'label': 'Status', 'sortable': false, 'attrs': {'data-campaign-column': 'status'}},
                    {'label': 'Recipients', 'sortable': false, 'attrs': {'data-campaign-column': 'recipients'}},
                    {'label': 'Sent', 'sortable': false, 'attrs': {'data-campaign-column': 'sent'}},
                    {'label': 'Created', 'key': 'created_at', 'attrs': {'data-campaign-column': 'created'}},
                    {'label': 'Channel', 'sortable': false, 'attrs': {'data-campaign-column': 'channel'}},
                    {'label': 'Subject', 'sortable': false, 'attrs': {'data-campaign-column': 'subject'}},
                    {'label': 'Delivered', 'sortable': false, 'attrs': {'data-campaign-column': 'delivered'}},
                    {'label': 'Failed', 'sortable': false, 'attrs': {'data-campaign-column': 'failed'}},
                    {'label': 'Opened', 'sortable': false, 'attrs': {'data-campaign-column': 'opened'}},
                    {'label': 'Clicked', 'sortable': false, 'attrs': {'data-campaign-column': 'clicked'}},
                    {'label': 'Scheduled', 'sortable': false, 'attrs': {'data-campaign-column': 'scheduled'}},
                    {'label': 'Completed', 'sortable': false, 'attrs': {'data-campaign-column': 'completed'}},
                    {'label': 'Actions', 'sortable': false, 'align': 'right'}
                ],
                sort_by=order_by|default('created_at'),
                sort_dir=order_dir|default('desc'),
                sort_url="/admin/crm/campaigns",
                sort_target="",
                extra_params=sort_extra
            ) }}
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                {% if campaigns %}
                {% for c in campaigns %}
                {% call table_row() %}
                    <td data-campaign-column="name" class="{{ pad }}">
                        <a href="/admin/crm/campaigns/{{ c.id }}" class="font-medium text-primary-600 hover:text-primary-800 dark:text-primary-400">{{ c.name }}</a>
                        {% if c.subject %}
                        <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{{ c.subject|truncate(60) }}</div>
                        {% endif %}
                    </td>
                    <td data-campaign-column="type" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold {{ 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400' if c.campaign_type.value == 'one_time' else 'bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-400' }}">
                            {{ c.campaign_type.value|replace('_', ' ')|title }}
                        </span>
                    </td>
                    <td data-campaign-column="status" class="{{ pad }}">
                        {% set status_colors = {
                            'draft': 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300',
                            'scheduled': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-500/20 dark:text-yellow-400',
                            'sending': 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400',
                            'sent': 'bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400',
                            'completed': 'bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400',
                            'cancelled': 'bg-red-100 text-red-700 dark:bg-red-500/20 dark:text-red-400',
                        } %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold {{ status_colors.get(c.status.value, 'bg-slate-100 text-slate-600') }}">
                            {{ c.status.value|capitalize }}
                        </span>
                    </td>
                    <td data-campaign-column="recipients" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.total_recipients }}</td>
                    <td data-campaign-column="sent" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.sent_count }}</td>
                    <td data-campaign-column="created" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ c.created_at.strftime('%Y-%m-%d') }}</td>
                    <td data-campaign-column="channel" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.channel.value|replace('_', ' ')|title if c.channel else '—' }}</td>
                    <td data-campaign-column="subject" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.subject|truncate(40) if c.subject else '—' }}</td>
                    <td data-campaign-column="delivered" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.delivered_count|default(0) }}</td>
                    <td data-campaign-column="failed" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.failed_count|default(0) }}</td>
                    <td data-campaign-column="opened" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.opened_count|default(0) }}</td>
                    <td data-campaign-column="clicked" class="{{ pad }} text-sm text-slate-600 dark:text-slate-300">{{ c.clicked_count|default(0) }}</td>
                    <td data-campaign-column="scheduled" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ c.scheduled_at.strftime('%Y-%m-%d %H:%M') if c.scheduled_at else '—' }}</td>
                    <td data-campaign-column="completed" class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ c.completed_at.strftime('%Y-%m-%d %H:%M') if c.completed_at else '—' }}</td>
                    <td class="{{ pad }} text-right">
                        <a href="/admin/crm/campaigns/{{ c.id }}" class="text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400">View</a>
                    </td>
                {% endcall %}
                {% endfor %}
                {% else %}
                {{ empty_state("No campaigns found", "Create your first campaign to get started.", action_label="New Campaign", action_href="/admin/crm/campaigns/new", colspan=15) }}
                {% endif %}
            </tbody>
        </table>
    {% endcall %}
</div>

<script src="/static/js/ui-filter-state.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (!window.DotmacUiFilterState || !window.DotmacUiFilterState.init) return;
    const columnDefinitions = [
        { key: "name", defaultVisible: true },
        { key: "type", defaultVisible: true },
        { key: "status", defaultVisible: true },
        { key: "recipients", defaultVisible: true },
        { key: "sent", defaultVisible: true },
        { key: "created", defaultVisible: true },
        { key: "channel", defaultVisible: false },
        { key: "subject", defaultVisible: false },
        { key: "delivered", defaultVisible: false },
        { key: "failed", defaultVisible: false },
        { key: "opened", defaultVisible: false },
        { key: "clicked", defaultVisible: false },
        { key: "scheduled", defaultVisible: false },
        { key: "completed", defaultVisible: false }
    ];
    window.DotmacUiFilterState.init({
        formId: "",
        fields: [],
        columns: {
            optionSelector: "[data-campaign-column-option]",
            storageKey: "admin:campaigns:columns",
            cellAttr: "data-campaign-column",
            validKeys: columnDefinitions.map(c => c.key),
            defaultVisible: columnDefinitions.filter(c => c.defaultVisible).map(c => c.key),
            requiredKeys: ["name"],
            containerId: "campaign-column-picker",
            toggleButtonId: "campaign-column-picker-toggle",
            panelId: "campaign-column-picker-panel",
        },
    });
});
</script>
{% endblock %}

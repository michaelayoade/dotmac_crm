<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ quote_name if quote_name else ('Quote ' ~ (quote.id|string|truncate(8, True, ''))) }}</title>
  <style>
    :root {
      --brand-color: {{ branding.brand_color if branding and branding.brand_color else '#1F7A3A' }};
      --brand-light-1: #F2FBF4;
      --brand-light-2: #E8F6EC;
      --accent-red: #C62828;
    }
    @page { size: A4; margin: 12mm 12mm; }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #333333;
      font-size: 12.5px;
      line-height: 1.45;
      background: #ffffff;
    }
    .page {
      position: relative;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: none;
      padding: 16px;
      width: 100%;
      min-height: auto;
    }
    .logo {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .logo img {
      max-width: 120px;
      height: auto;
    }
    .header-title {
      text-align: center;
      margin-bottom: 10px;
    }
    .header-title h1 {
      color: var(--brand-color);
      font-size: 20px;
      margin: 0;
    }
    .header-table {
      width: 100%;
      border-bottom: 1px solid #e2e2e2;
      margin-bottom: 10px;
      border-collapse: collapse;
    }
    .header-table td {
      vertical-align: top;
      padding-bottom: 6px;
    }
    .header-right {
      text-align: right;
      width: 40%;
    }
    .brand-logo {
      max-width: 160px;
      max-height: 48px;
    }
    .brand-name {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
    }
    .title {
      font-size: 16px;
      font-weight: 700;
      color: var(--brand-color);
      margin: 0 0 6px 0;
    }
    .muted { color: #64748b; }
    .meta-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 10px 0;
      margin-bottom: 12px;
    }
    .card {
      border: 2px solid #e2e2e2;
      padding: 10px;
      background: #ffffff;
      border-radius: 6px;
    }
    .card h4 {
      margin: 0 0 6px 0;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    th, td {
      border-bottom: 1px solid #e2e2e2;
      padding: 6px 6px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    th {
      font-size: 9.5px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #333333;
      background: var(--brand-light-1);
    }
    tbody tr:nth-child(even) td {
      background: var(--brand-light-2);
    }
    /* Fixed column widths for line items table */
    th.col-desc, td.col-desc { width: 50%; }
    th.col-qty, td.col-qty { width: 12%; }
    th.col-price, td.col-price { width: 19%; }
    th.col-amount, td.col-amount { width: 19%; }
    td.num, th.num { text-align: right; }
    .totals {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }
    .totals table {
      width: 260px;
      table-layout: auto;
    }
    .totals td {
      padding: 4px 0;
      border: none;
    }
    .totals .label { color: #64748b; }
    .totals .label-red { color: var(--accent-red); font-weight: 600; }
    .totals .grand { font-weight: 700; font-size: 13px; color: var(--brand-color); }
    .notes {
      margin-top: 12px;
      border: 2px solid #e2e2e2;
      padding: 10px;
      page-break-inside: avoid;
      border-radius: 6px;
    }
    .notes h4 {
      margin: 0 0 6px 0;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
    }
    .notes-content {
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    .notes-content.compact {
      white-space: normal;
      font-size: 11px;
      line-height: 1.3;
    }
    .notes-content.compact div {
      margin-bottom: 2px;
    }
    .notes-content.compact div:last-child {
      margin-bottom: 0;
    }
    .notes-content.compact strong {
      font-weight: 600;
    }
    .footer {
      margin-top: 18px;
      border-top: 1px solid #e2e2e2;
      padding-top: 8px;
      font-size: 12px;
      color: #555555;
      margin-bottom: 6px;
    }
    .signature-row {
      margin-top: 14px;
      display: flex;
      gap: 18px;
    }
    .signature {
      flex: 1 1 50%;
      border-top: 1px solid #bdbdbd;
      padding-top: 4px;
      font-size: 12px;
      color: #555555;
    }
    @media print {
      .header-banner { border-radius: 0; }
      .card, .notes { border-radius: 0; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="logo">
      {% if branding and (branding.logo_src or branding.logo_url) %}
      <img src="{{ branding.logo_src or branding.logo_url }}" alt="Brand logo">
      {% endif %}
    </div>

    <div class="header-title">
      <h1>Quotation</h1>
    </div>

    <table class="header-table">
      <tr>
        <td>
          <div class="title">{{ quote_name if quote_name else ('Quote ' ~ (quote.id|string|truncate(8, True, ''))) }}</div>
          <div class="muted">Quote ID: {{ quote.id }}</div>
        </td>
        <td class="muted header-right">
          {% if branding and branding.company_name %}
          <div class="brand-name">{{ branding.company_name }}</div>
          {% endif %}
          <div>Status: {{ quote.status.value if quote.status else 'draft' }}</div>
          <div>Created: {{ quote.created_at.strftime('%b %d, %Y') if quote.created_at else '—' }}</div>
          <div>Expires: {{ quote.expires_at.strftime('%b %d, %Y') if quote.expires_at else '—' }}</div>
        </td>
      </tr>
    </table>

  <table class="meta-table">
    <tr>
      <td class="card">
        <h4>Contact</h4>
        <div title="{{ contact.display_name if contact and contact.display_name else (contact.email if contact else '') }}">{{ (contact.display_name if contact and contact.display_name else (contact.email if contact else '—'))|truncate(40, True) }}</div>
        {% if contact and contact.email %}
        <div class="muted" title="{{ contact.email }}">{{ contact.email|truncate(35, True) }}</div>
        {% endif %}
        {% if contact and contact.phone %}
        <div class="muted">{{ contact.phone }}</div>
        {% endif %}
      </td>
    </tr>
  </table>

  {# Currency symbol mapping #}
  {% set currency_symbols = {'NGN': '₦', 'USD': '$', 'EUR': '€', 'GBP': '£', 'KES': 'KSh', 'GHS': 'GH₵', 'ZAR': 'R'} %}
  {% set currency_symbol = currency_symbols.get(quote.currency, quote.currency ~ ' ') %}

  <table>
    <thead>
      <tr>
        <th class="col-desc">Description</th>
        <th class="col-qty num">Qty</th>
        <th class="col-price num">Unit Price</th>
        <th class="col-amount num">Amount</th>
      </tr>
    </thead>
    <tbody>
      {% if items %}
      {% for item in items %}
      <tr>
        <td class="col-desc">{{ item.description }}</td>
        <td class="col-qty num">{{ "{:,.3g}".format(item.quantity or 0) }}</td>
        <td class="col-price num">{{ currency_symbol }}{{ "{:,.2f}".format(item.unit_price or 0) }}</td>
        <td class="col-amount num">{{ currency_symbol }}{{ "{:,.2f}".format(item.amount or 0) }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
        <td colspan="4" class="muted">No line items found.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="totals">
    <table>
      <tr>
        <td class="label">Subtotal</td>
        <td class="num">{{ currency_symbol }}{{ "{:,.2f}".format(quote.subtotal or 0) }}</td>
      </tr>
      <tr>
        <td class="label">Tax</td>
        <td class="num">{{ currency_symbol }}{{ "{:,.2f}".format(quote.tax_total or 0) }}</td>
      </tr>
      <tr>
        <td class="label grand label-red">Total</td>
        <td class="num grand" style="color: var(--accent-red);">{{ currency_symbol }}{{ "{:,.2f}".format(quote.total or 0) }}</td>
      </tr>
    </table>
  </div>

  {% set banking_details = branding.quote_banking_details if branding and branding.quote_banking_details else None %}
  {% if banking_details %}
  <div class="notes">
    <h4>Banking Details</h4>
    <div class="notes-content compact">
      {% if banking_details is string %}
        {{ banking_details }}
      {% elif banking_details is mapping %}
        {% for key, value in banking_details.items() %}
        <div><strong>{{ key|replace('_', ' ')|title }}:</strong> {{ value }}</div>
        {% endfor %}
      {% elif banking_details is sequence %}
        {% for item in banking_details %}
        <div>{{ item }}</div>
        {% endfor %}
      {% else %}
        {{ banking_details }}
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if quote.notes %}
  <div class="notes">
    <h4>Notes</h4>
    <div class="notes-content">{{ quote.notes }}</div>
  </div>
  {% endif %}

  <div class="footer">
    <div>Whatsapp - 08121179536</div>
    <div>Email - sales@dotmac.ng</div>
    <div>Address - 8 Ikot Ekpene Close, Off Emeka Anyaoku Street</div>
    <div>Area 11 Garki</div>
    <div>Abuja, Nigeria</div>
  </div>
  </div>
</body>
</html>

{% from "components/ui/macros.html" import submit_button %}
<!-- Conversation Header -->
<div class="relative z-30 flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-slate-50/80 backdrop-blur-sm dark:border-slate-800/60 dark:bg-slate-900/30">
    <div class="flex items-center gap-4">
        <!-- Back button (mobile) -->
        <a href="/admin/crm/inbox"
           class="lg:hidden p-2 -ml-2 rounded-lg text-primary-600 bg-primary-500/10 hover:text-primary-700 hover:bg-primary-500/20 transition-colors dark:text-primary-400 dark:bg-primary-500/15 dark:hover:bg-primary-500/25"
           aria-label="Back to inbox list">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>

        <!-- Contact info -->
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-sm font-semibold text-slate-800 border border-slate-200 dark:bg-gradient-to-br dark:from-slate-700 dark:to-slate-800 dark:text-white dark:border-slate-600/30">
                    {{ conversation.contact.avatar_initials }}
                </div>
                <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full channel-indicator channel-{{ conversation.channel }}"></div>
            </div>
            <div>
                <div class="flex flex-wrap items-center gap-2">
                    <h2 class="text-sm font-semibold text-primary-700 dark:text-primary-300">{{ conversation.contact.name }}</h2>
                    {% if conversation.inbox and conversation.inbox.label %}
                    <span class="inline-flex items-center rounded-full border border-slate-200/70 bg-white/70 px-2 py-0.5 text-[10px] font-semibold text-slate-600 shadow-sm dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-300">
                        {{ conversation.inbox.label }}
                    </span>
                    {% endif %}
                </div>
                {% if conversation.channel == 'whatsapp' %}
                <p class="text-xs text-slate-500 font-mono-tight dark:text-slate-500">
                    {{ (conversation.contact.phone or conversation.contact.name or '—')|replace('+', '') }}
                </p>
                {% else %}
                <p class="text-xs text-slate-500 font-mono-tight dark:text-slate-500">{{ conversation.contact.email }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center gap-2">
        {% if current_agent_id %}
        <button type="button"
                hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/assignment"
                hx-vals='{"agent_id":"{{ current_agent_id }}"}'
                hx-target="#contact-details"
                hx-swap="innerHTML"
                hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'}); htmx.ajax('GET', '/admin/crm/inbox/conversation/{{ conversation.id }}', {target:'#message-thread', swap:'innerHTML'});"
                {% if conversation.assigned_agent_id and conversation.assigned_agent_id != current_agent_id %}
                hx-confirm="This conversation is already assigned to {{ conversation.assigned_agent_name|default('another agent') }}. Assign to you anyway?"
                {% endif %}
                {% if conversation.assigned_agent_id and conversation.assigned_agent_id == current_agent_id %}
                disabled
                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-400 shadow-sm cursor-not-allowed dark:border-slate-700/70 dark:bg-slate-900/50 dark:text-slate-500"
                {% else %}
                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 shadow-sm hover:bg-slate-50 hover:text-slate-900 dark:border-slate-700/70 dark:bg-slate-900/50 dark:text-slate-300 dark:hover:bg-slate-800/70 dark:hover:text-white"
                {% endif %}
                >
            {% if conversation.assigned_agent_id and conversation.assigned_agent_id == current_agent_id %}
                Assigned
            {% else %}
                Assign to me
            {% endif %}
        </button>
        {% endif %}
        <!-- Status dropdown -->
        <div x-data="{ open: false }" class="relative">
            <button @click="open = !open"
                    :aria-expanded="open"
                    aria-haspopup="true"
                    aria-label="Change conversation status"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors
                        {% if conversation.status == 'open' %}bg-green-500/10 text-green-400 border border-green-500/20 hover:bg-green-500/20
                        {% elif conversation.status == 'pending' %}bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500/20
                        {% elif conversation.status == 'snoozed' %}bg-orange-500/10 text-orange-400 border border-orange-500/20 hover:bg-orange-500/20
                        {% else %}bg-slate-500/10 text-slate-400 border border-slate-500/20 hover:bg-slate-500/20{% endif %}">
                {% if conversation.status == 'open' %}
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 status-dot"></span>
                {% endif %}
                {{ conversation.status | capitalize }}
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <div x-show="open"
                 @click.outside="open = false"
                 x-transition
                 role="menu"
                 class="absolute right-0 mt-2 w-40 py-1 bg-slate-50 border border-slate-200 rounded-xl shadow-xl z-50 dark:bg-slate-800 dark:border-slate-700">
                <button hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/status?new_status=open"
                        hx-target="#message-thread"
                        hx-swap="innerHTML"
                        hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'})"
                        @click="open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    Open
                </button>
                <button hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/status?new_status=pending"
                        hx-target="#message-thread"
                        hx-swap="innerHTML"
                        hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'})"
                        @click="open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                    Pending
                </button>
                <button hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/status?new_status=snoozed"
                        hx-target="#message-thread"
                        hx-swap="innerHTML"
                        hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'})"
                        @click="open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                    Snoozed
                </button>
                <button hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/status?new_status=resolved"
                        hx-target="#message-thread"
                        hx-swap="innerHTML"
                        hx-on::after-request="htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML'})"
                        @click="open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                    Resolved
                </button>
            </div>
        </div>

        <!-- More actions -->
        <button type="button"
                hx-get="/admin/support/tickets/create?conversation_id={{ conversation.id }}&modal=1"
                hx-target="#ticket-create-panel-body"
                hx-swap="innerHTML"
                @click="openTicketPanel()"
                class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-primary-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7H5"/>
            </svg>
            Create ticket
        </button>

        <button @click="toggleContactPanel()"
                :class="showContactPanel ? 'bg-primary-500/20 text-primary-600 dark:text-primary-400' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-800/60'"
                class="p-2 rounded-lg transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
        </button>

        <div x-data="{ open: false }" class="relative">
            <button type="button"
                    @click="open = !open"
                    class="p-2 rounded-lg text-slate-500 hover:text-slate-900 hover:bg-slate-100 transition-colors dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-800/60">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
            </button>
            <div x-show="open"
                 @click.outside="open = false"
                 x-transition
                 class="absolute right-0 mt-2 w-44 rounded-xl border border-slate-200 bg-slate-50 py-1 shadow-xl z-50 dark:border-slate-700 dark:bg-slate-800">
                <button type="button"
                        @click="$dispatch('show-contact-panel'); open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    View contact
                </button>
                <button type="button"
                        @click="htmx.ajax('GET', '/admin/crm/inbox/conversation/{{ conversation.id }}', {target:'#message-thread', swap:'innerHTML'}); open = false"
                        class="w-full flex items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700/60">
                    Refresh thread
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Subject bar (if email) -->
{% if conversation.subject %}
<div class="px-6 py-3 border-b border-slate-200 bg-slate-100/70 dark:border-slate-800/40 dark:bg-slate-900/20">
    <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">{{ conversation.subject }}</h3>
</div>
{% endif %}

<!-- Messages Container -->
<div id="messages-container" class="relative z-0 flex-1 min-h-0 overflow-y-auto inbox-scroll px-6 py-6">
<div id="message-list" class="max-w-6xl mx-auto space-y-4">
        {% for msg in messages %}
        {% if msg.is_private_note %}
        {% include "admin/crm/_private_note_item.html" %}
        {% else %}
        <div class="msg-slide-up {% if msg.direction == 'outbound' %}flex justify-end{% endif %}" style="animation-delay: {{ loop.index0 * 50 }}ms;">
            <div class="w-full {% if msg.direction == 'outbound' %}pl-[18%]{% else %}pr-[18%]{% endif %}">
                {% if msg.direction == 'inbound' %}
                <!-- Inbound message -->
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-xs font-semibold text-slate-800 border border-slate-200 dark:bg-gradient-to-br dark:from-slate-700 dark:to-slate-800 dark:text-white dark:border-slate-600/30">
                        {{ msg.sender.initials }}
                    </div>
                    <div class="min-w-0">
                        <div class="{% if msg.html_body %}w-full max-w-full{% else %}message-inbound inline-flex w-fit max-w-[60%] flex-col gap-2 rounded-2xl rounded-tl-md px-3 py-1.5 bg-slate-100 border border-slate-200 dark:bg-transparent dark:border-slate-700/40{% endif %}">
                            {% if msg.reply_to %}
                            <div class="mb-2 rounded-lg border border-slate-200 bg-white/70 px-3 py-2 text-[11px] text-slate-600 dark:border-slate-700/60 dark:bg-slate-900/50 dark:text-slate-300">
                                <div class="text-[10px] uppercase tracking-wide text-slate-400">Replying to {{ msg.reply_to.author or 'Unknown' }}</div>
                                <div class="mt-1 text-[11px] text-slate-500 line-clamp-2 dark:text-slate-400">
                                    {{ msg.reply_to.excerpt or 'Attachment' }}
                                </div>
                            </div>
                            {% endif %}
                            <div class="text-sm text-slate-800 whitespace-pre-wrap break-words max-w-full leading-tight dark:text-slate-200">{% if msg.html_body %}<iframe class="email-html-frame"
                                        srcdoc="<style>html,body{margin:0;padding:0;overflow:hidden}img,table,td,th{max-width:100% !important;}table{width:100% !important;}body{box-sizing:border-box}</style>{{ msg.html_body | e }}"
                                        sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"
                                        scrolling="no"
                                        style="display: block; width: 100%; border: none; min-height: 140px; overflow: hidden;"></iframe>{% else %}{{- msg.content_html | safe if msg.content_html else msg.content | trim -}}{% endif %}</div>
                            {% if msg.attachments %}
                            <div class="mt-3 space-y-2">
                                {% for attachment in msg.attachments %}
                                {% if attachment.is_image and attachment.url %}
                                <a href="{{ attachment.url }}"
                                   target="_blank"
                                   rel="noopener"
                                   class="block overflow-hidden rounded-lg border border-slate-200 bg-white/70 dark:border-slate-700/40 dark:bg-slate-900/40">
                                    <img src="{{ attachment.url }}"
                                         alt="{{ attachment.file_name }}"
                                         class="block max-h-64 w-auto object-contain">
                                </a>
                                {% else %}
                                {% if attachment.url %}
                                <a href="{{ attachment.url }}"
                                   target="_blank"
                                   rel="noopener"
                                   download="{{ attachment.file_name }}"
                                   class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white/70 px-3 py-2 text-xs text-slate-700 hover:bg-white dark:border-slate-700/40 dark:bg-slate-900/40 dark:text-slate-300">
                                    <span class="font-medium">{{ attachment.file_name }}</span>
                                    {% if attachment.mime_type %}
                                    <span class="text-[10px] text-slate-500">{{ attachment.mime_type }}</span>
                                    {% endif %}
                                </a>
                                {% else %}
                                <div class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white/70 px-3 py-2 text-xs text-slate-500 dark:border-slate-700/40 dark:bg-slate-900/40">
                                    <span class="font-medium">{{ attachment.file_name }}</span>
                                </div>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 mt-1.5 px-1">
                            <span class="text-[10px] text-slate-500 font-mono-tight dark:text-slate-500">{{ msg.timestamp.strftime('%b %d, %Y %H:%M') }}</span>
                            <button type="button"
                                    data-quote-button
                                    data-quote-id="{{ msg.id }}"
                                    data-quote-author="{{ msg.sender.name }}"
                                    data-quote-content="{{ msg.content }}"
                                    data-quote-sent-at="{{ msg.timestamp.isoformat() if msg.timestamp else '' }}"
                                    class="text-[10px] font-semibold text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                Quote
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Outbound message -->
                <div class="flex items-start gap-3 flex-row-reverse">
                    <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-gradient-to-br from-primary-600 to-primary-700 flex items-center justify-center text-xs font-semibold text-white">
                        {{ msg.sender.initials }}
                    </div>
                    <div class="min-w-0">
                        <div class="{% if msg.html_body %}w-full max-w-full{% else %}message-outbound inline-flex w-fit max-w-[55%] flex-col gap-2 rounded-2xl rounded-tr-md px-3 py-1.5 bg-primary-500/10 border border-primary-500/20 dark:bg-transparent dark:border-primary-500/20{% endif %}">
                            {% if msg.reply_to %}
                            <div class="mb-2 rounded-lg border border-primary-200/60 bg-white/70 px-3 py-2 text-[11px] text-slate-600 dark:border-primary-500/30 dark:bg-slate-900/50 dark:text-slate-300">
                                <div class="text-[10px] uppercase tracking-wide text-slate-400">Replying to {{ msg.reply_to.author or 'Unknown' }}</div>
                                <div class="mt-1 text-[11px] text-slate-500 line-clamp-2 dark:text-slate-400">
                                    {{ msg.reply_to.excerpt or 'Attachment' }}
                                </div>
                            </div>
                            {% endif %}
                            <div class="text-sm text-slate-800 whitespace-pre-wrap break-words max-w-full leading-tight dark:text-slate-200">{% if msg.html_body %}<iframe class="email-html-frame"
                                        srcdoc="<style>html,body{margin:0;padding:0;overflow:hidden}img,table,td,th{max-width:100% !important;}table{width:100% !important;}body{box-sizing:border-box}</style>{{ msg.html_body | e }}"
                                        sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"
                                        scrolling="no"
                                        style="display: block; width: 100%; border: none; min-height: 140px; overflow: hidden;"></iframe>{% else %}{{- msg.content_html | safe if msg.content_html else msg.content | trim -}}{% endif %}</div>
                            {% if msg.attachments %}
                            <div class="mt-3 space-y-2">
                                {% for attachment in msg.attachments %}
                                {% if attachment.is_image and attachment.url %}
                                <a href="{{ attachment.url }}"
                                   target="_blank"
                                   rel="noopener"
                                   class="block overflow-hidden rounded-lg border border-primary-200/60 bg-white/70 dark:border-primary-500/30 dark:bg-slate-900/40">
                                    <img src="{{ attachment.url }}"
                                         alt="{{ attachment.file_name }}"
                                         class="block max-h-64 w-auto object-contain">
                                </a>
                                {% else %}
                                {% if attachment.url %}
                                <a href="{{ attachment.url }}"
                                   target="_blank"
                                   rel="noopener"
                                   download="{{ attachment.file_name }}"
                                   class="inline-flex items-center gap-2 rounded-lg border border-primary-200/60 bg-white/70 px-3 py-2 text-xs text-slate-700 hover:bg-white dark:border-primary-500/30 dark:bg-slate-900/40 dark:text-slate-300">
                                    <span class="font-medium">{{ attachment.file_name }}</span>
                                    {% if attachment.mime_type %}
                                    <span class="text-[10px] text-slate-500">{{ attachment.mime_type }}</span>
                                    {% endif %}
                                </a>
                                {% else %}
                                <div class="inline-flex items-center gap-2 rounded-lg border border-primary-200/60 bg-white/70 px-3 py-2 text-xs text-slate-500 dark:border-primary-500/30 dark:bg-slate-900/40">
                                    <span class="font-medium">{{ attachment.file_name }}</span>
                                </div>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 mt-1.5 px-1 justify-end">
                            <span class="text-[10px] text-slate-500 font-mono-tight dark:text-slate-500">{{ msg.timestamp.strftime('%b %d, %Y %H:%M') }}</span>
                            <button type="button"
                                    data-quote-button
                                    data-quote-id="{{ msg.id }}"
                                    data-quote-author="{{ msg.sender.name }}"
                                    data-quote-content="{{ msg.content }}"
                                    data-quote-sent-at="{{ msg.timestamp.isoformat() if msg.timestamp else '' }}"
                                    class="text-[10px] font-semibold text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                Quote
                            </button>
                            {% if msg.status in ['sent', 'delivered'] %}
                            <svg class="w-4 h-4 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13l4 4L17 7"/>
                            </svg>
                            {% elif msg.status in ['failed', 'queued'] %}
                            <span class="w-2 h-2 rounded-full bg-red-500" title="Message not sent"></span>
                            {% endif %}
                            {% if msg.read_at %}
                            <span class="text-[10px] text-emerald-600 dark:text-emerald-400">Read</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- Typing indicator (example, controlled by Alpine) -->
        <div x-show="isTyping" x-transition class="flex items-start gap-3" style="display: none;">
            <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-xs font-semibold text-slate-800 border border-slate-200 dark:bg-gradient-to-br dark:from-slate-700 dark:to-slate-800 dark:text-white dark:border-slate-600/30">
                {{ conversation.contact.avatar_initials }}
            </div>
            <div class="message-inbound rounded-2xl rounded-tl-md px-3 py-1.5 bg-slate-100 border border-slate-200 dark:bg-transparent dark:border-slate-700/40">
                <div class="flex gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-slate-500 typing-dot"></span>
                    <span class="w-2 h-2 rounded-full bg-slate-500 typing-dot"></span>
                    <span class="w-2 h-2 rounded-full bg-slate-500 typing-dot"></span>
                </div>
            </div>
        </div>
    </div>
</div>

	<!-- Compose Area -->
	<div class="border-t border-slate-200 bg-slate-50/90 backdrop-blur-sm px-6 py-4 dark:border-slate-800/60 dark:bg-slate-900/50"
	     data-mention-agents="{{ (mention_agents or [])|tojson|forceescape }}"
	     x-data="{
	         showPrivateNote: sessionStorage.getItem('privateNoteOpen:{{ conversation.id }}') === '1',
	         privateNoteDraft: sessionStorage.getItem('privateNoteDraft:{{ conversation.id }}') || '',
	         mentionAgents: [],
	         mentionOpen: false,
	         mentionTarget: null,
	         mentionMatches: [],
	         mentionIndex: 0,
         privateMentionDraft: [],
         messageMentionDraft: [],

         _findMentionQuery(textarea) {
             if (!textarea) return null;
             const value = textarea.value || '';
             const pos = textarea.selectionStart || 0;
             // Find last '@' before caret; only treat it as a trigger if there's no whitespace between.
             const at = value.lastIndexOf('@', pos - 1);
             if (at < 0) return null;
             const between = value.slice(at + 1, pos);
             if (/\s/.test(between)) return null;
             const prev = at > 0 ? value[at - 1] : '';
             if (prev && /[A-Za-z0-9_]/.test(prev)) return null;
             return { start: at, query: between };
         },

         _updateMatches(textarea) {
             const found = this._findMentionQuery(textarea);
             if (!found) {
                 this.mentionOpen = false;
                 this.mentionMatches = [];
                 this.mentionIndex = 0;
                 return;
             }
             const q = (found.query || '').toLowerCase();
             const agents = Array.isArray(this.mentionAgents) ? this.mentionAgents : [];
             let matches = agents;
             if (q) {
                 matches = agents.filter((a) => (a.label || '').toLowerCase().includes(q));
             }
             this.mentionMatches = matches.slice(0, 8);
             this.mentionOpen = this.mentionMatches.length > 0;
             this.mentionIndex = 0;
         },

         _insertMention(kind, textarea, agent) {
             if (!textarea || !agent) return;
             const found = this._findMentionQuery(textarea);
             if (!found) return;
             const before = textarea.value.slice(0, found.start);
             const after = textarea.value.slice(textarea.selectionStart || 0);
             const label = agent.label || 'Agent';
             const insert = `@${label} `;
             textarea.value = before + insert + after;
             const newPos = (before + insert).length;
             textarea.setSelectionRange(newPos, newPos);
             textarea.dispatchEvent(new Event('input'));

             // Track mentions so we can send stable IDs to the backend.
             const existing = kind === 'message'
                 ? (Array.isArray(this.messageMentionDraft) ? this.messageMentionDraft : [])
                 : (Array.isArray(this.privateMentionDraft) ? this.privateMentionDraft : []);
             const next = existing.filter((m) => m && m.id && m.label && (m.id !== agent.id));
             next.push({ id: agent.id, label });
             if (kind === 'message') {
                 this.messageMentionDraft = next;
             } else {
                 this.privateMentionDraft = next;
             }
             this._syncMentions(kind, textarea);

             this.mentionOpen = false;
             this.mentionMatches = [];
             this.mentionIndex = 0;
         },

         _syncMentions(kind, textarea) {
             const value = (textarea && textarea.value) ? textarea.value : '';
             const mentions = kind === 'message'
                 ? (Array.isArray(this.messageMentionDraft) ? this.messageMentionDraft : [])
                 : (Array.isArray(this.privateMentionDraft) ? this.privateMentionDraft : []);
             const stillPresent = mentions.filter((m) => m && m.label && value.includes(`@${m.label}`));
             if (kind === 'message') {
                 this.messageMentionDraft = stillPresent;
             } else {
                 this.privateMentionDraft = stillPresent;
             }
             const ids = stillPresent.map((m) => m.id).filter(Boolean);
             const privateField = this.$refs.privateNoteMentions;
             const msgField = this.$refs.messageMentions;
             if (kind === 'private' && privateField) privateField.value = JSON.stringify(ids);
             if (kind === 'message' && msgField) msgField.value = JSON.stringify(ids);
         },

         onMentionInput(kind, event) {
             const textarea = event.target;
             this.mentionTarget = textarea;
             this._updateMatches(textarea);
             this._syncMentions(kind, textarea);
         },

	         onMentionKeydown(kind, event) {
	             if (!this.mentionOpen) return;
	             const textarea = event.target;
	             // This component has two mention-enabled textareas (private note + message).
	             // Only intercept keys if the open menu belongs to the textarea receiving this event.
	             if (!textarea || this.mentionTarget !== textarea) return;
	             if (!Array.isArray(this.mentionMatches) || this.mentionMatches.length === 0) return;
	             if (event.key === 'ArrowDown') {
	                 event.preventDefault();
	                 this.mentionIndex = Math.min(this.mentionIndex + 1, this.mentionMatches.length - 1);
	             } else if (event.key === 'ArrowUp') {
	                 event.preventDefault();
	                 this.mentionIndex = Math.max(this.mentionIndex - 1, 0);
	             } else if (event.key === 'Enter' || event.key === 'Tab') {
	                 event.preventDefault();
	                 const agent = this.mentionMatches[this.mentionIndex];
	                 this._insertMention(kind, this.mentionTarget, agent);
	             } else if (event.key === 'Escape') {
	                 event.preventDefault();
	                 this.mentionOpen = false;
	             }
	         }
	     }"
	     x-init="
	         // Keep JSON out of the x-data attribute to avoid breaking HTML quoting.
	         // (tojson contains double quotes which can terminate a double-quoted attribute)
	         try { mentionAgents = JSON.parse($el.dataset.mentionAgents || '[]'); } catch (e) { mentionAgents = []; }
	         if (privateNoteDraft && !showPrivateNote) { showPrivateNote = true; }
	     ">
    {# reply_error is shown via the toast in inbox.html — no duplicate inline banner #}
    <div class="max-w-3xl mx-auto mb-3">
        <button type="button"
                @click="showPrivateNote = !showPrivateNote;
                        sessionStorage.setItem('privateNoteOpen:{{ conversation.id }}', showPrivateNote ? '1' : '0');
                        if (showPrivateNote) { $nextTick(() => $refs.privateNoteInput?.focus()); }"
                class="inline-flex items-center gap-2 rounded-lg border border-amber-400/30 bg-amber-500/10 px-3 py-1.5 text-xs font-semibold text-amber-700 hover:bg-amber-500/20 dark:text-amber-200">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Private note
        </button>
    </div>
    <form x-show="showPrivateNote"
          x-collapse
          hx-boost="false"
          action="/admin/crm/inbox/{{ conversation.id }}/private_note"
          class="max-w-3xl mx-auto mb-4 space-y-2"
          data-conversation-id="{{ conversation.id }}"
          x-on:submit.prevent="submitPrivateNote($event)">
        <textarea x-ref="privateNoteInput"
                  name="body"
                  x-model="privateNoteDraft"
                  rows="2"
                  placeholder="Add a private note..."
                  @input="
                      sessionStorage.setItem('privateNoteDraft:{{ conversation.id }}', privateNoteDraft);
                      if (!privateNoteDraft.trim()) {
                          sessionStorage.removeItem('privateNoteDraft:{{ conversation.id }}');
                      }
                      onMentionInput('private', $event);
                   "
                  @keydown="onMentionKeydown('private', $event)"
                  class="w-full rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2 text-xs text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-amber-400/60 dark:border-slate-700/50 dark:bg-slate-900/40 dark:text-slate-200 dark:placeholder-slate-500"></textarea>
        <input type="hidden" name="mentions" x-ref="privateNoteMentions" value="[]">
        <div x-show="mentionOpen && mentionTarget === $refs.privateNoteInput"
             x-transition
             class="relative">
            <div class="absolute z-50 mt-1 w-full max-w-md rounded-xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-900">
                <template x-for="(agent, idx) in mentionMatches" :key="agent.id">
                    <button type="button"
                            @click="_insertMention('private', $refs.privateNoteInput, agent)"
                            class="flex w-full items-center justify-between px-3 py-2 text-left text-xs hover:bg-slate-100 dark:hover:bg-slate-800"
                            :class="idx === mentionIndex ? 'bg-slate-100 dark:bg-slate-800' : ''">
                        <span class="text-slate-800 dark:text-slate-200" x-text="agent.label"></span>
                        <span class="text-[10px] text-slate-400">mention</span>
                    </button>
                </template>
            </div>
        </div>
        <div class="flex items-center justify-end">
            {{ submit_button("Add note", color="amber", size="sm", loading_label="Adding...") }}
        </div>
        <p class="text-[11px] text-red-400" data-private-note-error></p>
    </form>
    <div id="reply-preview" class="max-w-3xl mx-auto mb-3 hidden">
        <div class="rounded-xl border border-slate-200 bg-white/80 px-4 py-3 text-xs text-slate-600 shadow-sm dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-300">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                    <div class="text-[10px] uppercase tracking-wide text-slate-400">Replying to</div>
                    <div id="reply-preview-author" class="mt-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200">Unknown</div>
                    <div id="reply-preview-content" class="mt-1 text-[11px] text-slate-500 line-clamp-2 dark:text-slate-400">Attachment</div>
                </div>
                <button type="button"
                        data-clear-quote
                        class="inline-flex h-7 w-7 items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:text-slate-500 dark:hover:bg-slate-800 dark:hover:text-slate-200"
                        aria-label="Clear quote">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <form method="POST"
          action="/admin/crm/inbox/conversation/{{ conversation.id }}/message"
          hx-post="/admin/crm/inbox/conversation/{{ conversation.id }}/message"
          hx-target="#message-thread"
          hx-swap="innerHTML transition:false"
          hx-on::after-request="
              if (!event.detail.successful) {
                  this.dataset.submitting = '';
                  var btn = this.querySelector('button[type=submit]');
                  if (btn) { btn.disabled = false; btn.classList.remove('opacity-60', 'pointer-events-none'); }
                  var errEl = this.querySelector('[x-ref=messageError]');
                  if (errEl) { errEl.textContent = 'Failed to send. Please try again.'; }
              }
              htmx.ajax('GET', '/admin/crm/inbox/conversations', {target:'#conversation-list', swap:'innerHTML transition:false'});
          "
          class="max-w-3xl mx-auto"
          x-on:submit="
              if ($el.dataset.submitting === '1') {
                  $event.preventDefault();
                  return;
              }
              const text = ($refs.messageInput?.value || '').trim();
              const hasAttachments = pendingMessageAttachments && pendingMessageAttachments.length > 0;
              if (!text && !hasAttachments) {
                  $event.preventDefault();
                  if ($refs.messageError) {
                      $refs.messageError.textContent = 'Enter a message or attach a file.';
                  }
                  return;
              }
              if ($refs.messageError) {
                  $refs.messageError.textContent = '';
              }
              if ($root && $root.clearDraft) {
                  $root.clearDraft('{{ conversation.id }}');
              }
              $el.dataset.submitting = '1';
              const submitBtn = $el.querySelector('button[type=submit]');
              if (submitBtn) {
                  submitBtn.disabled = true;
                  submitBtn.classList.add('opacity-60', 'pointer-events-none');
              }
          ">
        <div class="flex items-end gap-3">
            <!-- Attachment button -->
        <button type="button"
                @click="$refs.attachmentInput.click()"
                aria-label="Attach files"
                class="flex-shrink-0 p-2.5 rounded-xl text-slate-500 hover:text-slate-900 hover:bg-slate-100 transition-colors dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-800/60">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
            </button>
            <input x-ref="attachmentInput"
                   type="file"
                   multiple
                   class="hidden"
                   @change="uploadAttachments($event, 'message')">

            <!-- Template + schedule -->
            <div class="flex flex-col gap-2">
                <select name="template_id"
                        class="min-w-[180px] rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700 focus:outline-none focus:ring-1 focus:ring-primary-500/40 dark:border-slate-700/50 dark:bg-slate-900/40 dark:text-slate-200"
                        @change="
                            const opt = $event.target.selectedOptions[0];
                            const body = opt ? opt.dataset.body : '';
                            if (body && $refs.messageInput) {
                                $refs.messageInput.value = body;
                                $refs.messageInput.dispatchEvent(new Event('input'));
                            }
                        ">
                    <option value="">Template</option>
                    {% for tmpl in message_templates or [] %}
                    <option value="{{ tmpl.id }}"
                            data-body="{{ tmpl.body | e }}">
                        {% if tmpl.channel_type %}{{ tmpl.channel_type.value }} · {% endif %}{{ tmpl.name }}
                    </option>
                    {% endfor %}
                </select>
                <input type="datetime-local"
                       name="scheduled_at"
                       class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700 focus:outline-none focus:ring-1 focus:ring-primary-500/40 dark:border-slate-700/50 dark:bg-slate-900/40 dark:text-slate-200"
                       placeholder="Schedule send">
            </div>

            <!-- Message input -->
            <div class="flex-1 relative">
                <textarea x-ref="messageInput"
                          name="message"
                          rows="1"
                          placeholder="Type your message..."
                          class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm text-slate-900 placeholder-slate-400 resize-none focus:outline-none focus:border-primary-500/50 focus:ring-1 focus:ring-primary-500/30 transition-all dark:bg-slate-800/50 dark:border-slate-700/50 dark:text-white dark:placeholder-slate-500"
                          @keydown.enter="
                              if (!$event.ctrlKey && !$event.metaKey) { return; }
                              $event.preventDefault();
                              const form = $el.closest('form');
                              if (!form || form.dataset.submitting === '1') { return; }
                              form.requestSubmit();
                          "
                          @keydown="onMentionKeydown('message', $event)"
                          @blur="if ($root && $root.flushPendingThreadRefresh) { $root.flushPendingThreadRefresh(); }"
                          @input="
                              $el.style.height = 'auto';
                              $el.style.height = Math.min($el.scrollHeight, 150) + 'px';
                              if ($refs.messageError) { $refs.messageError.textContent = ''; }
                              if ($root && $root.storeDraft) { $root.storeDraft('{{ conversation.id }}', $el.value); }
                              if ($root && $root.sendTypingIndicator) { $root.sendTypingIndicator('{{ conversation.id }}'); }
                              onMentionInput('message', $event);
                          "></textarea>
                <input type="hidden" name="mentions" x-ref="messageMentions" value="[]">
                <div x-show="mentionOpen && mentionTarget === $refs.messageInput"
                     x-transition
                     class="relative">
                    <div class="absolute z-50 mt-1 w-full max-w-md rounded-xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-900">
                        <template x-for="(agent, idx) in mentionMatches" :key="agent.id">
                            <button type="button"
                                    @click="_insertMention('message', $refs.messageInput, agent)"
                                    class="flex w-full items-center justify-between px-3 py-2 text-left text-xs hover:bg-slate-100 dark:hover:bg-slate-800"
                                    :class="idx === mentionIndex ? 'bg-slate-100 dark:bg-slate-800' : ''">
                                <span class="text-slate-800 dark:text-slate-200" x-text="agent.label"></span>
                                <span class="text-[10px] text-slate-400">mention</span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Send button -->
            <button type="submit"
                    aria-label="Send message"
                    class="flex-shrink-0 p-3 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white hover:from-primary-400 hover:to-primary-500 transition-all shadow-lg shadow-primary-500/20 hover:shadow-primary-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
            </button>
        </div>

        <input type="hidden" name="reply_to_message_id" :value="$root.replyTo ? $root.replyTo.id : ''">
        <input type="hidden"
               name="idempotency_key"
               x-ref="idempotencyKey"
               x-init="
                   if (!$el.value) {
                       if (window.crypto && typeof window.crypto.randomUUID === 'function') {
                           $el.value = window.crypto.randomUUID();
                       } else {
                           $el.value = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
                       }
                   }
               ">
        <input type="hidden" name="attachments" x-ref="messageAttachments">
        <p x-ref="messageError" class="mt-2 text-[11px] text-red-500 dark:text-red-400"></p>

        <div x-show="pendingMessageAttachments.length" class="mt-2 flex flex-wrap gap-2">
            <template x-for="(att, idx) in pendingMessageAttachments" :key="att.stored_name || idx">
                <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-[11px] text-slate-600 dark:border-slate-700/40 dark:bg-slate-900/40 dark:text-slate-300">
                    <span x-text="att.file_name"></span>
                    <button type="button" class="text-slate-400 hover:text-slate-600" @click="removeAttachment(idx, 'message')">×</button>
                </span>
            </template>
        </div>

        <!-- Quick responses -->
        <div class="flex items-center gap-2 mt-3">
            <span class="text-[10px] text-slate-500 uppercase tracking-wider dark:text-slate-500">Quick:</span>
            <button type="button"
                    @click="$refs.messageInput.value = 'Thank you for reaching out! Let me look into this for you.'; $refs.messageInput.dispatchEvent(new Event('input'))"
                    class="px-2.5 py-1 rounded-lg bg-slate-100 border border-slate-200 text-[11px] text-slate-600 hover:text-slate-900 hover:bg-slate-200 transition-colors dark:bg-slate-800/40 dark:border-slate-700/40 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/60">
                Thanks for reaching out
            </button>
            <button type="button"
                    @click="$refs.messageInput.value = 'I\'ll need a moment to check on that. I\'ll get back to you shortly.'; $refs.messageInput.dispatchEvent(new Event('input'))"
                    class="px-2.5 py-1 rounded-lg bg-slate-100 border border-slate-200 text-[11px] text-slate-600 hover:text-slate-900 hover:bg-slate-200 transition-colors dark:bg-slate-800/40 dark:border-slate-700/40 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/60">
                Checking on it
            </button>
            <button type="button"
                    @click="$refs.messageInput.value = 'Is there anything else I can help you with today?'; $refs.messageInput.dispatchEvent(new Event('input'))"
                    class="px-2.5 py-1 rounded-lg bg-slate-100 border border-slate-200 text-[11px] text-slate-600 hover:text-slate-900 hover:bg-slate-200 transition-colors dark:bg-slate-800/40 dark:border-slate-700/40 dark:text-slate-400 dark:hover:text-white dark:hover:bg-slate-700/60">
                Anything else?
            </button>
        </div>
    </form>
</div>

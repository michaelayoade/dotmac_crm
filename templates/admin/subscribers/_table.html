{% from "components/ui/macros.html" import status_badge, type_badge, avatar, row_action, empty_state, pagination, icon_view, icon_edit, icon_delete, sortable_table_head, table_shell, table_row %}
{% set pad = 'px-6 py-3' %}
{% set ns = namespace(parts=[]) %}
{% if search %}
    {% set ns.parts = ns.parts + ['search=' ~ search|urlencode] %}
{% endif %}
{% if external_system %}
    {% set ns.parts = ns.parts + ['external_system=' ~ external_system|urlencode] %}
{% endif %}
{% if status %}
    {% set ns.parts = ns.parts + ['status=' ~ status|urlencode] %}
{% endif %}
{% if per_page %}
    {% set ns.parts = ns.parts + ['per_page=' ~ per_page] %}
{% endif %}
{% if order_by is defined and order_by and order_by != 'created_at' %}
    {% set ns.parts = ns.parts + ['order_by=' ~ order_by|urlencode] %}
{% endif %}
{% if order_dir is defined and order_dir and order_dir != 'desc' %}
    {% set ns.parts = ns.parts + ['order_dir=' ~ order_dir|urlencode] %}
{% endif %}
{% set page_base_url = '/admin/subscribers' ~ ('?' ~ ns.parts|join('&') if ns.parts else '') %}

{# Build sort link params (without sort fields themselves) #}
{% set _sort_params = [] %}
{% if search %}{% set _ = _sort_params.append('search=' ~ search|urlencode) %}{% endif %}
{% if external_system %}{% set _ = _sort_params.append('external_system=' ~ external_system|urlencode) %}{% endif %}
{% if status %}{% set _ = _sort_params.append('status=' ~ status|urlencode) %}{% endif %}
{% if per_page %}{% set _ = _sort_params.append('per_page=' ~ per_page) %}{% endif %}
{% set sort_extra = _sort_params | join('&') %}

{% call table_shell(table_id="subscribers-table", color="amber", bulk_selectable=False) %}
    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            {{ sortable_table_head(
                columns=[
                    {'label': 'Subscriber', 'key': 'subscriber_number'},
                    {'label': 'Source', 'sortable': false},
                    {'label': 'Status', 'key': 'status'},
                    {'label': 'Created', 'key': 'created_at'},
                    {'label': 'Actions', 'sortable': false, 'align': 'right'}
                ],
                sort_by=order_by|default('created_at'),
                sort_dir=order_dir|default('desc'),
                sort_url="/admin/subscribers",
                sort_target="#subscribers-table",
                selectable=True,
                extra_params=sort_extra
            ) }}
            <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                {% if subscribers %}
                {% for subscriber in subscribers %}
                {% set sub_type = 'person' if subscriber.person else ('organization' if subscriber.organization else 'unknown') %}
                {% set name = subscriber.display_name %}
                {% set email = subscriber.person.email if subscriber.person else (subscriber.organization.domain if subscriber.organization else (subscriber.service_plan or '')) %}

                {% call table_row(color="amber") %}
                    <td class="w-12 {{ pad }}">
                        <input type="checkbox"
                               data-subscriber-select
                               data-subscriber-id="{{ subscriber.id }}"
                               data-subscriber-type="{{ sub_type }}"
                               class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 focus:ring-offset-0 dark:border-slate-600 dark:bg-slate-700 dark:checked:bg-amber-500 cursor-pointer">
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        <div class="flex items-center gap-4">
                            {{ avatar(name, sub_type) }}
                            <div class="min-w-0">
                                <a href="/admin/subscribers/{{ subscriber.id }}" class="group/link flex items-center gap-1.5">
                                    <span class="text-sm font-semibold text-slate-900 group-hover/link:text-amber-600 dark:text-white dark:group-hover/link:text-amber-400 transition-colors">
                                        {{ name }}
                                    </span>
                                    <svg class="h-3.5 w-3.5 text-slate-400 opacity-0 transition-all group-hover/link:opacity-100 group-hover/link:translate-x-0.5 group-hover/link:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </a>
                                {% if email %}
                                <p class="mt-0.5 truncate text-sm text-slate-500 dark:text-slate-400">{{ email }}</p>
                                {% elif subscriber.person %}
                                <p class="mt-0.5 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:bg-amber-900/30 dark:text-amber-300">
                                    Email missing
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        {% if subscriber.external_system %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-300">
                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                            {{ subscriber.external_system|title }}
                        </span>
                        {% else %}
                        <span class="text-sm text-slate-400 dark:text-slate-500">Manual</span>
                        {% endif %}
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        {% set status_colors = {'active': 'emerald', 'suspended': 'amber', 'terminated': 'red', 'pending': 'blue'} %}
                        {{ status_badge(subscriber.status.value|title, status_colors.get(subscriber.status.value, 'slate')) }}
                    </td>
                    <td class="whitespace-nowrap {{ pad }}">
                        <div class="text-sm font-medium text-slate-900 dark:text-white">
                            {{ subscriber.created_at.strftime('%b %d, %Y') if subscriber.created_at else 'N/A' }}
                        </div>
                    </td>
                    <td class="whitespace-nowrap {{ pad }} text-right">
                        <div class="flex items-center justify-end gap-1 opacity-0 transition-opacity group-hover:opacity-100">
                            {{ row_action("/admin/subscribers/" ~ subscriber.id, icon_view(), "View details", "amber") }}
                            {{ row_action("/admin/subscribers/" ~ subscriber.id ~ "/edit", icon_edit(), "Edit subscriber", "slate") }}
                            {% if subscriber.is_active %}
                            <button hx-post="/admin/subscribers/{{ subscriber.id }}/deactivate"
                                    hx-confirm="Deactivate this subscriber?"
                                    class="inline-flex items-center justify-center rounded-lg p-2 text-slate-400 transition-all hover:bg-orange-100 hover:text-orange-600 dark:hover:bg-orange-900/30 dark:hover:text-orange-400"
                                    title="Deactivate">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                </svg>
                            </button>
                            {% else %}
                            <button hx-delete="/admin/subscribers/{{ subscriber.id }}"
                                    hx-confirm="Delete this deactivated subscriber? This action cannot be undone."
                                    hx-target="closest tr"
                                    hx-swap="outerHTML swap:1s"
                                    class="inline-flex items-center justify-center rounded-lg p-2 text-slate-400 transition-all hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/30 dark:hover:text-red-400"
                                    title="Delete">
                                {{ icon_delete() }}
                            </button>
                            {% endif %}
                        </div>
                    </td>
                {% endcall %}
                {% endfor %}
                {% else %}
                {{ empty_state(
                    title="No subscribers found",
                    message="Get started by adding a new subscriber.",
                    icon='<svg class="h-8 w-8 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
                    color="amber",
                    color2="orange",
                    action_label="Add Subscriber",
                    action_href="/admin/subscribers/new",
                    colspan=6
                ) }}
                {% endif %}
            </tbody>
    </table>

    {{ pagination(page|default(1), total_pages|default(1), total|default(0), per_page|default(20), page_base_url, "#subscribers-table", "amber") }}
{% endcall %}

<script>
(function() {
    // Select-all checkbox functionality
    const selectAll = document.querySelector('[data-bulk-select-all]');
    const checkboxes = document.querySelectorAll('[data-subscriber-select]');

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            document.dispatchEvent(new CustomEvent('subscribers-select-all', {
                detail: { checked: this.checked, ids: Array.from(checkboxes).map(cb => cb.dataset.subscriberId) }
            }));
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            // Update select-all state
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            const anyChecked = Array.from(checkboxes).some(c => c.checked);
            if (selectAll) {
                selectAll.checked = allChecked;
                selectAll.indeterminate = anyChecked && !allChecked;
            }

            // Dispatch selection change event
            const selectedIds = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.subscriberId);
            document.dispatchEvent(new CustomEvent('subscribers-selection-change', {
                detail: { selectedIds }
            }));
        });
    });
})();
</script>

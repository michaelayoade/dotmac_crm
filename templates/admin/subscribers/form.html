{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, submit_button %}

{% block title %}{{ 'Edit' if is_edit else 'New' }} Subscriber - Admin{% endblock %}

{% block content %}
{{ ambient_background("amber", "orange") }}

<div class="mx-auto max-w-2xl space-y-6">
    <div>
        <nav class="mb-2 flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
            <a href="/admin/subscribers" class="hover:text-amber-600">Subscribers</a>
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            <span class="text-slate-900 dark:text-white">{{ 'Edit' if is_edit else 'New' }}</span>
        </nav>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ 'Edit Subscriber' if is_edit else 'New Subscriber' }}</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
            {% if is_edit %}
            Update subscriber details. Note: Most fields are synced from external systems (Splynx, UCRM, etc.).
            {% else %}
            Create a new subscriber record manually. For automated sync, use the API endpoints.
            {% endif %}
        </p>
    </div>

    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 p-4 dark:border-red-800 dark:bg-red-900/30">
        <div class="flex">
            <svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p class="ml-3 text-sm text-red-700 dark:text-red-200">{{ error }}</p>
        </div>
    </div>
    {% endif %}

    <form method="POST" action="{{ '/admin/subscribers/' ~ subscriber.id if is_edit else '/admin/subscribers' }}"
          class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        {% include "components/forms/csrf_input.html" %}

        {# Account Information #}
        <div class="border-b border-slate-200 p-6 dark:border-slate-700">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Account Information</h2>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
                <div>
                    <label for="subscriber_number" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Subscriber Number</label>
                    <input type="text" name="subscriber_number" id="subscriber_number"
                        value="{{ subscriber.subscriber_number if subscriber else '' }}"
                        placeholder="Auto-generated if blank"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="account_number" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Account Number</label>
                    <input type="text" name="account_number" id="account_number"
                        value="{{ subscriber.account_number if subscriber else '' }}"
                        placeholder="Optional"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="external_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">External ID</label>
                    <input type="text" name="external_id" id="external_id"
                        value="{{ subscriber.external_id if subscriber else '' }}"
                        placeholder="ID from external system"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="external_system" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">External System</label>
                    <select name="external_system" id="external_system"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="">None</option>
                        <option value="splynx" {% if subscriber and subscriber.external_system == 'splynx' %}selected{% endif %}>Splynx</option>
                        <option value="ucrm" {% if subscriber and subscriber.external_system == 'ucrm' %}selected{% endif %}>UCRM/UNMS</option>
                        <option value="whmcs" {% if subscriber and subscriber.external_system == 'whmcs' %}selected{% endif %}>WHMCS</option>
                        <option value="other" {% if subscriber and subscriber.external_system == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Status</label>
                    <select name="status" id="status" required
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        {% for s in statuses %}
                        <option value="{{ s }}" {% if subscriber and subscriber.status.value == s %}selected{% elif not subscriber and s == 'active' %}selected{% endif %}>{{ s|title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        {# Service Information #}
        <div class="border-b border-slate-200 p-6 dark:border-slate-700">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Service Information</h2>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
                <div>
                    <label for="service_name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Service Name</label>
                    <input type="text" name="service_name" id="service_name"
                        value="{{ subscriber.service_name if subscriber else '' }}"
                        placeholder="e.g., Fiber Internet"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="service_plan" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Service Plan</label>
                    <input type="text" name="service_plan" id="service_plan"
                        value="{{ subscriber.service_plan if subscriber else '' }}"
                        placeholder="e.g., Business 100"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div class="sm:col-span-2">
                    <label for="service_speed" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Service Speed</label>
                    <input type="text" name="service_speed" id="service_speed"
                        value="{{ subscriber.service_speed if subscriber else '' }}"
                        placeholder="e.g., 100/20 Mbps"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
            </div>
        </div>

        {# Service Address #}
        <div class="border-b border-slate-200 p-6 dark:border-slate-700">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Service Address</h2>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
                <div class="sm:col-span-2">
                    <label for="service_address_line1" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Address Line 1</label>
                    <input type="text" name="service_address_line1" id="service_address_line1"
                        value="{{ subscriber.service_address_line1 if subscriber else '' }}"
                        placeholder="Street address"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="service_city" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">City</label>
                    <input type="text" name="service_city" id="service_city"
                        value="{{ subscriber.service_city if subscriber else '' }}"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="service_region" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">State/Region</label>
                    <input type="text" name="service_region" id="service_region"
                        value="{{ subscriber.service_region if subscriber else '' }}"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="service_postal_code" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Postal Code</label>
                    <input type="text" name="service_postal_code" id="service_postal_code"
                        value="{{ subscriber.service_postal_code if subscriber else '' }}"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
            </div>
        </div>

        {# Notes #}
        <div class="p-6">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Notes</h2>
            <div class="mt-4">
                <textarea name="notes" id="notes" rows="3"
                    placeholder="Internal notes (not synced to external system)"
                    class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">{{ subscriber.notes if subscriber else '' }}</textarea>
            </div>
        </div>

        {# Form Actions #}
        <div class="border-t border-slate-200 bg-slate-50 px-6 py-4 dark:border-slate-700 dark:bg-slate-800/50 flex items-center justify-end gap-3">
            <a href="{{ '/admin/subscribers/' ~ subscriber.id if is_edit else '/admin/subscribers' }}"
               class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
                Cancel
            </a>
            {{ submit_button(('Update' if is_edit else 'Create') ~ " Subscriber", color="amber", loading_label="Creating...") }}
        </div>
    </form>
</div>
{% endblock %}

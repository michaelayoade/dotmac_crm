{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import page_header, stats_card %}

{% block title %}Data Quality - Admin{% endblock %}

{% block breadcrumbs %}
<a href="/admin/dashboard" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 truncate">Dashboard</a>
<span class="text-slate-400">/</span>
<span class="text-slate-700 dark:text-slate-200 truncate">Data Quality</span>
{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl space-y-6 p-4 sm:p-6 lg:p-8">

    {{ page_header(
        title="Data Quality",
        subtitle="Field completeness and data readiness across all domains.",
        icon='<svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>',
        color="indigo",
        color2="violet"
    ) }}

    {# Summary Stats #}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 animate-fade-in-up">
        {{ stats_card(
            label="Overall Quality",
            value=(overall_avg_pct | string) + "%",
            color="indigo",
            color2="violet",
            icon='<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>'
        ) }}
        {{ stats_card(
            label="Entities Scanned",
            value=total_entities | string,
            color="cyan",
            color2="blue",
            icon='<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>'
        ) }}
        {{ stats_card(
            label="Domains",
            value=(reports | length) | string,
            color="teal",
            color2="emerald",
            icon='<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>'
        ) }}
        {% set needs_attention = reports | selectattr("avg_quality", "lt", 0.5) | list | length %}
        {{ stats_card(
            label="Needs Attention",
            value=needs_attention | string,
            color="amber" if needs_attention > 0 else "green",
            color2="orange" if needs_attention > 0 else "emerald",
            icon='<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>'
        ) }}
    </div>

    {# Domain Cards Grid #}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {% for report in reports %}
        {% set pct = report.avg_pct() %}
        {% set bar_color = "bg-emerald-500" if pct >= 70 else ("bg-amber-500" if pct >= 40 else "bg-rose-500") %}
        {% set text_color = "text-emerald-600 dark:text-emerald-400" if pct >= 70 else ("text-amber-600 dark:text-amber-400" if pct >= 40 else "text-rose-600 dark:text-rose-400") %}
        <a href="/admin/data-quality/{{ report.domain }}"
           class="group rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-slate-900 dark:text-white">{{ report.label }}</h3>
                <span class="text-2xl font-bold font-display {{ text_color }}">{{ pct }}%</span>
            </div>

            {# Progress bar #}
            <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-700">
                <div class="{{ bar_color }} h-full rounded-full transition-all duration-500" style="width: {{ pct }}%"></div>
            </div>

            <div class="mt-3 flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                <span>{{ report.entity_count }} entities</span>
                <span>{{ report.pct_high_quality }}% high quality</span>
            </div>

            {# Top missing fields #}
            {% if report.top_missing_fields %}
            <div class="mt-3 flex flex-wrap gap-1">
                {% for field_name, count in report.top_missing_fields[:3] %}
                <span class="inline-flex items-center gap-1 rounded-lg bg-slate-100 px-2 py-0.5 text-xs text-slate-600 dark:bg-slate-700 dark:text-slate-300">
                    <svg class="h-3 w-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                    {{ field_name }} ({{ count }})
                </span>
                {% endfor %}
            </div>
            {% endif %}

            <div class="mt-3 text-xs font-medium text-primary-600 opacity-0 transition-opacity group-hover:opacity-100 dark:text-primary-400">
                View details &rarr;
            </div>
        </a>
        {% endfor %}
    </div>

    {% if not reports %}
    <div class="rounded-2xl border border-slate-200/60 bg-white p-12 text-center shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>
        <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">No data found. Create some records first.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

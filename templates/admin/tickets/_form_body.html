{% from "components/ui/macros.html" import typeahead_input %}
{% set prefill = prefill or {} %}
{% include "components/forms/csrf_input.html" %}
<div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
    <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
        <h2 class="font-semibold text-slate-900 dark:text-white">Ticket Information</h2>
    </div>
    <div class="p-6 space-y-6">
        {% if error %}
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-400">
            {{ error }}
        </div>
        {% endif %}

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div class="sm:col-span-2">
                <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Title <span class="text-red-500">*</span></label>
                <input type="text" name="title" id="title" required maxlength="200"
                    value="{{ ticket.title if ticket else (prefill.title or '') }}"
                    placeholder="Brief description of the issue"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="description" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Description</label>
                <textarea name="description" id="description" rows="4"
                    placeholder="Detailed description of the issue..."
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">{{ ticket.description if ticket else (prefill.description or '') }}</textarea>
            </div>

            <div>
                <label for="customer_search" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Customer</label>
                {% if ticket and ticket.customer %}
                    {% set customer_label = ticket.customer.display_name or ticket.customer.email %}
                {% else %}
                    {% set customer_label = prefill.customer_label or '' %}
                {% endif %}
                {{ typeahead_input("customer_person_id", "/api/v1/search/people", value=(ticket.customer_person_id if ticket else (prefill.customer_person_id or '')), display_value=customer_label, placeholder="Search contacts...", min_chars=0, id="customer_search") }}
            </div>

            <div class="sm:col-span-2">
                <label for="attachments" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Attachments</label>
                <input type="file" name="attachments" id="attachments" multiple
                    accept="image/jpeg,image/png,image/gif,image/webp,application/pdf"
                    class="mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">PNG, JPG, GIF, WEBP, or PDF up to 5MB each.</p>
                <p id="ticket-attachment-selected" data-attachments-selected class="mt-2 text-xs text-slate-500 dark:text-slate-400"></p>
            </div>

            <div>
                <label for="subscriber_search" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subscriber</label>
                {% if ticket and ticket.subscriber %}
                    {% if ticket.subscriber.person %}
                        {% set subscriber_label = ticket.subscriber.person.first_name ~ ' ' ~ ticket.subscriber.person.last_name %}
                    {% elif ticket.subscriber.organization %}
                        {% set subscriber_label = ticket.subscriber.organization.name %}
                    {% else %}
                        {% set subscriber_label = 'Subscriber' %}
                    {% endif %}
                    {% if ticket.subscriber.subscriber_number %}
                        {% set subscriber_label = subscriber_label ~ ' (' ~ ticket.subscriber.subscriber_number ~ ')' %}
                    {% endif %}
                {% else %}
                    {% set subscriber_label = prefill.subscriber_label or '' %}
                {% endif %}
                {{ typeahead_input("subscriber_id", "/api/v1/search/subscribers", value=(ticket.subscriber_id if ticket else (prefill.subscriber_id or '')), display_value=subscriber_label, placeholder="Search subscribers...", min_chars=0, id="subscriber_search") }}
            </div>

            <div class="sm:col-span-2">
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 dark:border-slate-700 dark:bg-slate-800/60 dark:text-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Customer Details</h3>
                    </div>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                        If these details are incorrect, please update the customer information.
                    </p>
                    <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Name</p>
                            <p id="ticket-customer-name">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Email</p>
                            <p id="ticket-customer-email">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Phone</p>
                            <p id="ticket-customer-phone">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Organization</p>
                            <p id="ticket-customer-org">—</p>
                        </div>
                        <div class="sm:col-span-2">
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Address</p>
                            <p id="ticket-customer-address">—</p>
                        </div>
                    </div>

                    <div class="mt-4 border-t border-slate-200 pt-3 dark:border-slate-700">
                        <h4 class="text-sm font-semibold text-slate-900 dark:text-white">Subscriber Details</h4>
                        <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Subscriber #</p>
                                <p id="ticket-subscriber-number">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Account #</p>
                                <p id="ticket-subscriber-account">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Status</p>
                                <p id="ticket-subscriber-status">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Plan</p>
                                <p id="ticket-subscriber-plan">—</p>
                            </div>
                            <div class="sm:col-span-2">
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Service Address</p>
                                <p id="ticket-subscriber-address">—</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="region" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Region</label>
                <select name="region" id="region"
                    data-region-ticket-assignments='{{ region_ticket_assignments | tojson }}'
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">Select a region</option>
                    {% for region in region_options or [] %}
                    <option value="{{ region }}" {% if (ticket and ticket.region == region) or (not ticket and prefill.region == region) %}selected{% endif %}>
                        {{ region }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Technicians / User Group</label>
                {% set assigned_ids = [] %}
                {% if ticket %}
                    {% if ticket.assignees %}
                        {% set assigned_ids = ticket.assignees | map(attribute='person_id') | map('string') | list %}
                    {% elif ticket.assigned_to_person_id %}
                        {% set assigned_ids = [ticket.assigned_to_person_id|string] %}
                    {% endif %}
                {% else %}
                    {% set assigned_ids = prefill.assigned_to_person_ids or [] %}
                {% endif %}
                {% set selected_group_id = (ticket.service_team_id|string) if ticket and ticket.service_team_id else (prefill.service_team_id or '') %}
                {% set selected_group_label = (ticket.service_team.name) if ticket and ticket.service_team else '' %}
                {% if not selected_group_label and selected_group_id %}
                    {% for grp in assignment_groups or [] %}
                        {% if grp.id|string == selected_group_id|string %}
                            {% set selected_group_label = grp.label %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% set tech_ids = [] %}
                <div id="technician-typeahead"
                     data-assignment-groups="{{ (assignment_groups or []) | tojson | forceescape }}"
                     class="mt-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm dark:border-slate-600 dark:bg-slate-700">
                    <div class="flex flex-wrap gap-2" data-selected-wrap>
                        {% for tech in technicians %}
                            {% set tech_person = tech.person %}
                            {% if tech_person %}
                                {% set tech_label = tech_person.display_name or (tech_person.first_name ~ ' ' ~ tech_person.last_name) %}
                            {% else %}
                                {% set tech_label = 'Technician ' ~ tech.id|string|truncate(8, True, '') %}
                            {% endif %}
                            {% if tech.person_id|string in assigned_ids %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1 text-xs text-slate-700 dark:bg-slate-600 dark:text-slate-100" data-chip="{{ tech.person_id|string }}">
                                {{ tech_label }}
                                <button type="button" class="ml-1 text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-white" data-remove="{{ tech.person_id|string }}">x</button>
                            </span>
                            <input type="hidden" name="assigned_to_person_ids[]" value="{{ tech.person_id|string }}" data-hidden="{{ tech.person_id|string }}">
                            {% endif %}
                        {% endfor %}
                        {% if selected_group_id %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-2 py-1 text-xs text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300" data-chip="group:{{ selected_group_id }}">
                            {{ selected_group_label or 'User Group' }}
                            <button type="button" class="ml-1 text-indigo-500 hover:text-indigo-700 dark:text-indigo-300 dark:hover:text-indigo-100" data-remove="group:{{ selected_group_id }}">x</button>
                        </span>
                        {% endif %}
                    </div>
                    <input type="hidden" name="service_team_id" value="{{ selected_group_id }}" data-hidden-group>
                    <input type="text"
                           placeholder="Search technicians or groups..."
                           class="mt-2 block w-full rounded-md border border-slate-200 bg-white px-2 py-1.5 text-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-800 dark:text-white"
                           data-search-input>
                    <div class="mt-2" data-results></div>
                </div>
            </div>

            <div>
                <label for="ticket_manager_person_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Project Manager</label>
                <select name="ticket_manager_person_id" id="ticket_manager_person_id"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">-- Unassigned --</option>
                    {% for tech in technicians %}
                    {% set tech_person = tech.person %}
                    {% if tech_person %}
                        {% set tech_label = tech_person.display_name or (tech_person.first_name ~ ' ' ~ tech_person.last_name) %}
                    {% else %}
                        {% set tech_label = 'Technician ' ~ tech.id|string|truncate(8, True, '') %}
                    {% endif %}
                    <option value="{{ tech.person_id }}" {% if (ticket and ticket.ticket_manager_person_id == tech.person_id) or (not ticket and prefill.ticket_manager_person_id == tech.person_id|string) %}selected{% endif %}>
                        {{ tech_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="assistant_manager_person_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Site Project Coordinator</label>
                <select name="assistant_manager_person_id" id="assistant_manager_person_id"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">-- Unassigned --</option>
                    {% for tech in technicians %}
                    {% set tech_person = tech.person %}
                    {% if tech_person %}
                        {% set tech_label = tech_person.display_name or (tech_person.first_name ~ ' ' ~ tech_person.last_name) %}
                    {% else %}
                        {% set tech_label = 'Technician ' ~ tech.id|string|truncate(8, True, '') %}
                    {% endif %}
                    <option value="{{ tech.person_id }}" {% if (ticket and ticket.assistant_manager_person_id == tech.person_id) or (not ticket and prefill.assistant_manager_person_id == tech.person_id|string) %}selected{% endif %}>
                        {{ tech_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="ticket_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ticket Type</label>
                <select name="ticket_type" id="ticket_type"
                    data-priority-map='{{ ticket_type_priority_map | tojson }}'
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">Select a type</option>
                    {% for ttype in ticket_types or [] %}
                    <option value="{{ ttype.name }}" {% if (ticket and ticket.ticket_type == ttype.name) or (not ticket and prefill.ticket_type == ttype.name) %}selected{% endif %}>
                        {{ ttype.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="priority" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Priority</label>
                <select name="priority" id="priority"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    {% if ticket and ticket.priority.value == 'normal' %}
                    <option value="normal" selected>Normal</option>
                    {% elif not ticket and (prefill.priority or 'normal') == 'normal' %}
                    <option value="normal" selected>Normal</option>
                    {% endif %}
                    <option value="lower" {% if (ticket and ticket.priority.value == 'lower') or (not ticket and prefill.priority == 'lower') %}selected{% endif %}>Lower</option>
                    <option value="low" {% if (ticket and ticket.priority.value == 'low') or (not ticket and prefill.priority == 'low') %}selected{% endif %}>Low</option>
                    <option value="medium" {% if (ticket and ticket.priority.value == 'medium') or (not ticket and (prefill.priority or 'normal') == 'medium') %}selected{% endif %}>Medium</option>
                    <option value="high" {% if (ticket and ticket.priority.value == 'high') or (not ticket and prefill.priority == 'high') %}selected{% endif %}>High</option>
                    <option value="urgent" {% if (ticket and ticket.priority.value == 'urgent') or (not ticket and prefill.priority == 'urgent') %}selected{% endif %}>Urgent</option>
                </select>
            </div>

            <div>
                <label for="channel" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Channel</label>
                <select name="channel" id="channel"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="web" {% if (ticket and ticket.channel.value == 'web') or (not ticket and (prefill.channel or 'web') == 'web') %}selected{% endif %}>Web</option>
                    <option value="email" {% if (ticket and ticket.channel.value == 'email') or (not ticket and prefill.channel == 'email') %}selected{% endif %}>Email</option>
                    <option value="phone" {% if (ticket and ticket.channel.value == 'phone') or (not ticket and prefill.channel == 'phone') %}selected{% endif %}>Phone</option>
                    <option value="chat" {% if (ticket and ticket.channel.value == 'chat') or (not ticket and prefill.channel == 'chat') %}selected{% endif %}>Chat</option>
                    <option value="api" {% if (ticket and ticket.channel.value == 'api') or (not ticket and prefill.channel == 'api') %}selected{% endif %}>API</option>
                </select>
            </div>

            <div>
                <label for="status" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                <select name="status" id="status"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="new" {% if (ticket and ticket.status.value == 'new') or (not ticket and prefill.status == 'new') %}selected{% endif %}>New</option>
                    <option value="open" {% if (ticket and ticket.status.value == 'open') or (not ticket and (prefill.status or 'open') == 'open') %}selected{% endif %}>Open</option>
                    <option value="pending" {% if (ticket and ticket.status.value == 'pending') or (not ticket and prefill.status == 'pending') %}selected{% endif %}>Pending</option>
                    <option value="waiting_on_customer" {% if (ticket and ticket.status.value == 'waiting_on_customer') or (not ticket and prefill.status == 'waiting_on_customer') %}selected{% endif %}>Waiting on Customer</option>
                    <option value="lastmile_rerun" {% if (ticket and ticket.status.value == 'lastmile_rerun') or (not ticket and prefill.status == 'lastmile_rerun') %}selected{% endif %}>Lastmile Rerun</option>
                    <option value="site_under_construction" {% if (ticket and ticket.status.value == 'site_under_construction') or (not ticket and prefill.status == 'site_under_construction') %}selected{% endif %}>Site Under Construction</option>
                    <option value="on_hold" {% if (ticket and ticket.status.value == 'on_hold') or (not ticket and prefill.status == 'on_hold') %}selected{% endif %}>On Hold</option>
                    <option value="resolved" {% if (ticket and ticket.status.value == 'resolved') or (not ticket and prefill.status == 'resolved') %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if (ticket and ticket.status.value == 'closed') or (not ticket and prefill.status == 'closed') %}selected{% endif %}>Closed</option>
                </select>
            </div>

            <div>
                <label for="due_at" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Due Date</label>
                <input type="datetime-local" name="due_at" id="due_at"
                    value="{{ ticket.due_at.strftime('%Y-%m-%dT%H:%M') if ticket and ticket.due_at else (prefill.due_at or '') }}"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="tags" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tags</label>
                <input type="text" name="tags" id="tags"
                    value="{{ ticket.tags | join(', ') if ticket and ticket.tags else (prefill.tags or '') }}"
                    placeholder="Comma-separated tags (e.g., billing, technical, urgent)"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Separate multiple tags with commas</p>
            </div>
        </div>
    </div>
    {% if not ticket and prefill.conversation_id %}
    <input type="hidden" name="conversation_id" value="{{ prefill.conversation_id }}">
    {% endif %}
    {% if not ticket and prefill.lead_id %}
    <input type="hidden" name="lead_id" value="{{ prefill.lead_id }}">
    {% endif %}
</div>
<script>
    (function () {
        const typeSelect = document.getElementById("ticket_type");
        const prioritySelect = document.getElementById("priority");
        if (!typeSelect || !prioritySelect) {
            return;
        }
        let priorityMap = {};
        try {
            priorityMap = JSON.parse(typeSelect.dataset.priorityMap || "{}");
        } catch (err) {
            priorityMap = {};
        }
        typeSelect.addEventListener("change", function () {
            const selected = this.value;
            const mapped = priorityMap[selected];
            if (mapped) {
                prioritySelect.value = mapped;
            }
        });
    })();

    (function () {
        const customerHidden = document.querySelector('input[name="customer_person_id"][data-typeahead-hidden]');
        const subscriberHidden = document.querySelector('input[name="subscriber_id"][data-typeahead-hidden]');

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value || "—";
            }
        };

        async function loadDetails() {
            const customerId = customerHidden ? customerHidden.value.trim() : "";
            const subscriberId = subscriberHidden ? subscriberHidden.value.trim() : "";
            if (!customerId && !subscriberId) {
                setText("ticket-customer-name", "");
                setText("ticket-customer-email", "");
                setText("ticket-customer-phone", "");
                setText("ticket-customer-org", "");
                setText("ticket-customer-address", "");
                setText("ticket-subscriber-number", "");
                setText("ticket-subscriber-account", "");
                setText("ticket-subscriber-status", "");
                setText("ticket-subscriber-plan", "");
                setText("ticket-subscriber-address", "");
                return;
            }

            const params = new URLSearchParams();
            if (customerId) params.set("customer_person_id", customerId);
            if (subscriberId) params.set("subscriber_id", subscriberId);

            try {
                const response = await fetch(`/admin/support/tickets/lookup?${params.toString()}`, { credentials: "same-origin" });
                if (!response.ok) {
                    return;
                }
                const data = await response.json();
                const customer = data.customer || {};
                const subscriber = data.subscriber || {};

                setText("ticket-customer-name", customer.name);
                setText("ticket-customer-email", customer.email);
                setText("ticket-customer-phone", customer.phone);
                setText("ticket-customer-org", customer.organization);
                setText("ticket-customer-address", customer.address);

                setText("ticket-subscriber-number", subscriber.subscriber_number);
                setText("ticket-subscriber-account", subscriber.account_number);
                setText("ticket-subscriber-status", subscriber.status);
                const plan = [subscriber.service_plan, subscriber.service_speed].filter(Boolean).join(" · ");
                setText("ticket-subscriber-plan", plan);
                setText("ticket-subscriber-address", subscriber.service_address);

                const regionSelect = document.getElementById("region");
                if (regionSelect && !regionSelect.value) {
                    const preferredRegion = subscriber.service_region || customer.region;
                    if (preferredRegion) {
                        regionSelect.value = preferredRegion;
                        regionSelect.dispatchEvent(new Event("change", { bubbles: true }));
                    }
                }
            } catch (err) {
                // Ignore
            }
        }

        if (customerHidden) {
            customerHidden.addEventListener("input", loadDetails);
            customerHidden.addEventListener("change", loadDetails);
        }
        if (subscriberHidden) {
            subscriberHidden.addEventListener("input", loadDetails);
            subscriberHidden.addEventListener("change", loadDetails);
        }

        loadDetails();
    })();

    (function () {
        const regionSelect = document.getElementById("region");
        const managerSelect = document.getElementById("ticket_manager_person_id");
        const assistantSelect = document.getElementById("assistant_manager_person_id");
        if (!regionSelect || (!managerSelect && !assistantSelect)) {
            return;
        }
        let assignments = {};
        try {
            assignments = JSON.parse(regionSelect.dataset.regionTicketAssignments || "{}");
        } catch (err) {
            assignments = {};
        }

        const setSelectValue = (select, value) => {
            if (!select || !value) return;
            const hasOption = Array.from(select.options).some((opt) => opt.value === value);
            if (!hasOption) return;
            select.value = value;
            select.dataset.autofill = "true";
        };

        const markManual = (event) => {
            const target = event.target;
            if (target && target.dataset) {
                target.dataset.autofill = "false";
            }
        };

        const applyAssignments = () => {
            const region = regionSelect.value;
            const entry = assignments ? assignments[region] : null;
            if (!entry || typeof entry !== "object") {
                return;
            }
            if (managerSelect) {
                const canFillManager = !managerSelect.value || managerSelect.dataset.autofill === "true";
                if (canFillManager && entry.manager_person_id) {
                    setSelectValue(managerSelect, entry.manager_person_id);
                }
            }
            if (assistantSelect) {
                const canFillAssistant = !assistantSelect.value || assistantSelect.dataset.autofill === "true";
                if (canFillAssistant && entry.spc_person_id) {
                    setSelectValue(assistantSelect, entry.spc_person_id);
                }
            }
        };

        if (managerSelect) {
            if (managerSelect.value) {
                managerSelect.dataset.autofill = "false";
            }
            managerSelect.addEventListener("change", markManual);
        }
        if (assistantSelect) {
            if (assistantSelect.value) {
                assistantSelect.dataset.autofill = "false";
            }
            assistantSelect.addEventListener("change", markManual);
        }

        regionSelect.addEventListener("change", applyAssignments);
        applyAssignments();
    })();

    (function () {
        const input = document.getElementById("attachments");
        const output = document.getElementById("ticket-attachment-selected");
        if (!input || !output) return;
        const render = () => {
            const files = Array.from(input.files || []);
            if (!files.length) {
                output.textContent = "";
                return;
            }
            output.textContent = `Selected: ${files.map(f => f.name).join(", ")}`;
        };
        input.addEventListener("change", render);
        render();
    })();
    (function () {
        const root = document.getElementById("technician-typeahead");
        if (!root) return;
        const input = root.querySelector("[data-search-input]");
        const results = root.querySelector("[data-results]");
        const selectedWrap = root.querySelector("[data-selected-wrap]");
        const groupHidden = root.querySelector("input[type='hidden'][name='service_team_id'][data-hidden-group]");
        let assignmentGroups = [];
        try {
            assignmentGroups = JSON.parse(root.dataset.assignmentGroups || "[]");
        } catch (e) {
            assignmentGroups = [];
        }
        const selected = new Map();
        const hiddenById = new Map();
        let selectedGroup = null;

        const seedHidden = () => {
            const hiddenInputs = root.querySelectorAll("input[type='hidden'][name='assigned_to_person_ids[]']");
            hiddenInputs.forEach((el) => {
                selected.set(el.value, true);
                hiddenById.set(el.value, el);
            });
        };

        const seedGroup = () => {
            if (!groupHidden || !groupHidden.value) return;
            const id = String(groupHidden.value);
            const matched = assignmentGroups.find((item) => String(item.id) === id);
            selectedGroup = {
                id,
                label: (matched && matched.label) || "User Group",
            };
        };

        const bindRemoveButtons = () => {
            const buttons = selectedWrap.querySelectorAll("[data-remove]");
            buttons.forEach((btn) => {
                if (btn.dataset.bound === "true") return;
                btn.dataset.bound = "true";
                const id = btn.dataset.remove;
                btn.addEventListener("click", () => removeEntry(id));
            });
        };

        const createHidden = (id) => {
            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "assigned_to_person_ids[]";
            hidden.value = id;
            hidden.dataset.hidden = id;
            root.appendChild(hidden);
            hiddenById.set(id, hidden);
        };

        const removeHidden = (id) => {
            const hidden = hiddenById.get(id);
            if (hidden && hidden.parentNode) {
                hidden.parentNode.removeChild(hidden);
            }
            hiddenById.delete(id);
        };

        const createChip = (item) => {
            const chip = document.createElement("span");
            chip.className = "inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1 text-xs text-slate-700 dark:bg-slate-600 dark:text-slate-100";
            chip.dataset.chip = item.id;
            chip.textContent = item.label;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "ml-1 text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-white";
            btn.dataset.remove = item.id;
            btn.textContent = "x";
            btn.addEventListener("click", () => removeTech(item.id));

            chip.appendChild(btn);
            selectedWrap.appendChild(chip);
        };

        const removeChip = (id) => {
            const chip = selectedWrap.querySelector(`[data-chip=\"${id}\"]`);
            if (chip && chip.parentNode) {
                chip.parentNode.removeChild(chip);
            }
        };

        const addTech = (item) => {
            if (item.kind === "group") {
                setGroup(item);
                return;
            }
            if (selected.has(item.id)) return;
            selected.set(item.id, true);
            createChip(item);
            createHidden(item.id);
            input.value = "";
            renderResults();
        };

        const clearGroup = () => {
            if (!selectedGroup) return;
            removeChip(`group:${selectedGroup.id}`);
            if (groupHidden) groupHidden.value = "";
            selectedGroup = null;
        };

        const setGroup = (item) => {
            const normalizedId = String(item.id || "").replace(/^group:/, "");
            if (!normalizedId) return;
            if (selectedGroup && selectedGroup.id === normalizedId) {
                input.value = "";
                renderResults();
                return;
            }
            clearGroup();
            selectedGroup = { id: normalizedId, label: item.label || "User Group" };
            createChip({
                id: `group:${normalizedId}`,
                label: selectedGroup.label,
                kind: "group",
            });
            if (groupHidden) groupHidden.value = normalizedId;
            input.value = "";
            renderResults();
        };

        const removeTech = (id) => {
            selected.delete(id);
            removeChip(id);
            removeHidden(id);
            renderResults();
        };

        const removeEntry = (id) => {
            if (String(id || "").startsWith("group:")) {
                clearGroup();
                renderResults();
                return;
            }
            removeTech(id);
        };

        const renderResults = (items) => {
            results.innerHTML = "";
            if (!items || !items.length) {
                return;
            }
            const menu = document.createElement("div");
            menu.className = "relative mt-2 w-full rounded-lg border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-800";
            items.forEach((item) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-700";
                btn.textContent = item.label || item.name || "";
                btn.addEventListener("click", () => addTech({
                    id: item.id || item.ref,
                    label: item.label || item.name,
                    kind: item.kind || "technician",
                }));
                menu.appendChild(btn);
            });
            results.appendChild(menu);
        };

        const fetchResults = (query) => {
            const term = (query || "").trim().toLowerCase();
            const groupMatches = assignmentGroups
                .filter((item) => item && item.id && item.label)
                .filter((item) => {
                    const groupId = String(item.id);
                    if (selectedGroup && selectedGroup.id === groupId) return false;
                    if (!term) return true;
                    return String(item.label).toLowerCase().includes(term);
                })
                .map((item) => ({
                    id: `group:${item.id}`,
                    label: `${item.label} (Group)`,
                    kind: "group",
                }))
                .slice(0, 5);
            const url = `/api/v1/search/technicians?q=${encodeURIComponent(query)}&limit=10`;
            fetch(url)
                .then((response) => {
                    if (!response.ok) throw new Error("typeahead request failed");
                    return response.json();
                })
                .then((data) => {
                    const items = (data && data.items) || [];
                    const filtered = items.filter((item) => {
                        const id = String(item.id || item.ref || "");
                        return id && !selected.has(id);
                    });
                    renderResults([...groupMatches, ...filtered]);
                })
                .catch(() => {
                    renderResults(groupMatches);
                });
        };

        let timer = null;
        input.addEventListener("input", () => {
            const query = input.value.trim();
            if (timer) window.clearTimeout(timer);
            timer = window.setTimeout(() => {
                if (query.length < 1) {
                    results.innerHTML = "";
                    return;
                }
                fetchResults(query);
            }, 250);
        });

        input.addEventListener("focus", () => {
            const query = input.value.trim();
            fetchResults(query);
        });

        document.addEventListener("click", (event) => {
            if (!root.contains(event.target)) {
                results.innerHTML = "";
            }
        });

        seedHidden();
        seedGroup();
        bindRemoveButtons();
        results.innerHTML = "";
    })();
</script>

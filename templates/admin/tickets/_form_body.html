{% set prefill = prefill or {} %}
<div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
    <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
        <h2 class="font-semibold text-slate-900 dark:text-white">Ticket Information</h2>
    </div>
    <div class="p-6 space-y-6">
        {% if error %}
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-400">
            {{ error }}
        </div>
        {% endif %}

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div class="sm:col-span-2">
                <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Title <span class="text-red-500">*</span></label>
                <input type="text" name="title" id="title" required maxlength="200"
                    value="{{ ticket.title if ticket else (prefill.title or '') }}"
                    placeholder="Brief description of the issue"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="description" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Description</label>
                <textarea name="description" id="description" rows="4"
                    placeholder="Detailed description of the issue..."
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">{{ ticket.description if ticket else '' }}</textarea>
            </div>

            <div>
                <label for="customer_search" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Customer</label>
                {% if ticket and ticket.customer %}
                    {% set customer_label = ticket.customer.display_name or ticket.customer.email %}
                {% else %}
                    {% set customer_label = prefill.customer_label or '' %}
                {% endif %}
                <div class="relative" data-typeahead-url="/api/v1/search/people" data-typeahead-min="0" data-typeahead-limit="8">
                    <input type="text" name="customer_search" id="customer_search" data-typeahead-input
                           value="{{ customer_label }}"
                           placeholder="Search contacts..."
                           class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <input type="hidden" name="customer_person_id" data-typeahead-hidden value="{{ ticket.customer_person_id if ticket else (prefill.customer_person_id or '') }}">
                    <div data-typeahead-results></div>
                </div>
            </div>

            <div class="sm:col-span-2">
                <label for="attachments" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Attachments</label>
                <input type="file" name="attachments" id="attachments" multiple
                    accept="image/jpeg,image/png,image/gif,image/webp,application/pdf"
                    class="mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">PNG, JPG, GIF, WEBP, or PDF up to 5MB each.</p>
                <p id="ticket-attachment-selected" class="mt-2 text-xs text-slate-500 dark:text-slate-400"></p>
            </div>

            <div>
                <label for="subscriber_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subscriber</label>
                {% if ticket and ticket.subscriber %}
                    {% if ticket.subscriber.person %}
                        {% set subscriber_label = ticket.subscriber.person.first_name ~ ' ' ~ ticket.subscriber.person.last_name %}
                    {% elif ticket.subscriber.organization %}
                        {% set subscriber_label = ticket.subscriber.organization.name %}
                    {% else %}
                        {% set subscriber_label = 'Subscriber' %}
                    {% endif %}
                    {% if ticket.subscriber.subscriber_number %}
                        {% set subscriber_label = subscriber_label ~ ' (' ~ ticket.subscriber.subscriber_number ~ ')' %}
                    {% endif %}
                {% else %}
                    {% set subscriber_label = prefill.subscriber_label or '' %}
                {% endif %}
                <div class="relative" data-typeahead-url="/api/v1/search/subscribers" data-typeahead-min="0" data-typeahead-limit="8">
                    <input type="text" name="subscriber_search" data-typeahead-input
                           value="{{ subscriber_label }}"
                           placeholder="Search subscribers..."
                           class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <input type="hidden" name="subscriber_id" data-typeahead-hidden value="{{ ticket.subscriber_id if ticket else (prefill.subscriber_id or '') }}">
                    <div data-typeahead-results></div>
                </div>
            </div>

            <div class="sm:col-span-2">
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 dark:border-slate-700 dark:bg-slate-800/60 dark:text-slate-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Customer Details</h3>
                    </div>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                        If these details are incorrect, please update the customer information.
                    </p>
                    <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Name</p>
                            <p id="ticket-customer-name">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Email</p>
                            <p id="ticket-customer-email">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Phone</p>
                            <p id="ticket-customer-phone">—</p>
                        </div>
                        <div>
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Organization</p>
                            <p id="ticket-customer-org">—</p>
                        </div>
                        <div class="sm:col-span-2">
                            <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Address</p>
                            <p id="ticket-customer-address">—</p>
                        </div>
                    </div>

                    <div class="mt-4 border-t border-slate-200 pt-3 dark:border-slate-700">
                        <h4 class="text-sm font-semibold text-slate-900 dark:text-white">Subscriber Details</h4>
                        <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Subscriber #</p>
                                <p id="ticket-subscriber-number">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Account #</p>
                                <p id="ticket-subscriber-account">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Status</p>
                                <p id="ticket-subscriber-status">—</p>
                            </div>
                            <div>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Plan</p>
                                <p id="ticket-subscriber-plan">—</p>
                            </div>
                            <div class="sm:col-span-2">
                                <p class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Service Address</p>
                                <p id="ticket-subscriber-address">—</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="assigned_to_person_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Technician</label>
                <select name="assigned_to_person_id" id="assigned_to_person_id"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">-- Unassigned --</option>
                    {% for tech in technicians %}
                    {% set tech_person = tech.person %}
                    {% if tech_person %}
                        {% set tech_label = tech_person.display_name or (tech_person.first_name ~ ' ' ~ tech_person.last_name) %}
                    {% else %}
                        {% set tech_label = 'Technician ' ~ tech.id|string|truncate(8, True, '') %}
                    {% endif %}
                    <option value="{{ tech.person_id }}" {% if ticket and ticket.assigned_to_person_id == tech.person_id %}selected{% endif %}>
                        {{ tech_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="ticket_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ticket Type</label>
                <select name="ticket_type" id="ticket_type"
                    data-priority-map='{{ ticket_type_priority_map | tojson }}'
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">Select a type</option>
                    {% for ttype in ticket_types or [] %}
                    <option value="{{ ttype.name }}" {% if ticket and ticket.ticket_type == ttype.name %}selected{% endif %}>
                        {{ ttype.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="priority" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Priority</label>
                <select name="priority" id="priority"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    {% if ticket and ticket.priority.value == 'normal' %}
                    <option value="normal" selected>Normal</option>
                    {% endif %}
                    <option value="lower" {% if ticket and ticket.priority.value == 'lower' %}selected{% endif %}>Lower</option>
                    <option value="low" {% if ticket and ticket.priority.value == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if not ticket or ticket.priority.value == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if ticket and ticket.priority.value == 'high' %}selected{% endif %}>High</option>
                    <option value="urgent" {% if ticket and ticket.priority.value == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
            </div>

            <div>
                <label for="channel" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Channel</label>
                <select name="channel" id="channel"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="web" {% if (ticket and ticket.channel.value == 'web') or (not ticket and (prefill.channel or 'web') == 'web') %}selected{% endif %}>Web</option>
                    <option value="email" {% if (ticket and ticket.channel.value == 'email') or (not ticket and prefill.channel == 'email') %}selected{% endif %}>Email</option>
                    <option value="phone" {% if (ticket and ticket.channel.value == 'phone') or (not ticket and prefill.channel == 'phone') %}selected{% endif %}>Phone</option>
                    <option value="chat" {% if (ticket and ticket.channel.value == 'chat') or (not ticket and prefill.channel == 'chat') %}selected{% endif %}>Chat</option>
                    <option value="api" {% if (ticket and ticket.channel.value == 'api') or (not ticket and prefill.channel == 'api') %}selected{% endif %}>API</option>
                </select>
            </div>

            <div>
                <label for="status" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                <select name="status" id="status"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="new" {% if not ticket or ticket.status.value == 'new' %}selected{% endif %}>New</option>
                    <option value="open" {% if ticket and ticket.status.value == 'open' %}selected{% endif %}>Open</option>
                    <option value="pending" {% if ticket and ticket.status.value == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="waiting_on_customer" {% if ticket and ticket.status.value == 'waiting_on_customer' %}selected{% endif %}>Waiting on Customer</option>
                    <option value="lastmile_rerun" {% if ticket and ticket.status.value == 'lastmile_rerun' %}selected{% endif %}>Lastmile Rerun</option>
                    <option value="site_under_construction" {% if ticket and ticket.status.value == 'site_under_construction' %}selected{% endif %}>Site Under Construction</option>
                    <option value="on_hold" {% if ticket and ticket.status.value == 'on_hold' %}selected{% endif %}>On Hold</option>
                    <option value="resolved" {% if ticket and ticket.status.value == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if ticket and ticket.status.value == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>

            <div>
                <label for="due_at" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Due Date</label>
                <input type="datetime-local" name="due_at" id="due_at"
                    value="{{ ticket.due_at.strftime('%Y-%m-%dT%H:%M') if ticket and ticket.due_at else '' }}"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="tags" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tags</label>
                <input type="text" name="tags" id="tags"
                    value="{{ ticket.tags | join(', ') if ticket and ticket.tags else '' }}"
                    placeholder="Comma-separated tags (e.g., billing, technical, urgent)"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Separate multiple tags with commas</p>
            </div>
        </div>
    </div>
    {% if not ticket and prefill.conversation_id %}
    <input type="hidden" name="conversation_id" value="{{ prefill.conversation_id }}">
    {% endif %}
    {% if not ticket and prefill.lead_id %}
    <input type="hidden" name="lead_id" value="{{ prefill.lead_id }}">
    {% endif %}
</div>
<script>
    (function () {
        const typeSelect = document.getElementById("ticket_type");
        const prioritySelect = document.getElementById("priority");
        if (!typeSelect || !prioritySelect) {
            return;
        }
        let priorityMap = {};
        try {
            priorityMap = JSON.parse(typeSelect.dataset.priorityMap || "{}");
        } catch (err) {
            priorityMap = {};
        }
        typeSelect.addEventListener("change", function () {
            const selected = this.value;
            const mapped = priorityMap[selected];
            if (mapped) {
                prioritySelect.value = mapped;
            }
        });
    })();

    (function () {
        const customerHidden = document.querySelector('input[name="customer_person_id"][data-typeahead-hidden]');
        const subscriberHidden = document.querySelector('input[name="subscriber_id"][data-typeahead-hidden]');

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value || "—";
            }
        };

        async function loadDetails() {
            const customerId = customerHidden ? customerHidden.value.trim() : "";
            const subscriberId = subscriberHidden ? subscriberHidden.value.trim() : "";
            if (!customerId && !subscriberId) {
                setText("ticket-customer-name", "");
                setText("ticket-customer-email", "");
                setText("ticket-customer-phone", "");
                setText("ticket-customer-org", "");
                setText("ticket-customer-address", "");
                setText("ticket-subscriber-number", "");
                setText("ticket-subscriber-account", "");
                setText("ticket-subscriber-status", "");
                setText("ticket-subscriber-plan", "");
                setText("ticket-subscriber-address", "");
                return;
            }

            const params = new URLSearchParams();
            if (customerId) params.set("customer_person_id", customerId);
            if (subscriberId) params.set("subscriber_id", subscriberId);

            try {
                const response = await fetch(`/admin/support/tickets/lookup?${params.toString()}`, { credentials: "same-origin" });
                if (!response.ok) {
                    return;
                }
                const data = await response.json();
                const customer = data.customer || {};
                const subscriber = data.subscriber || {};

                setText("ticket-customer-name", customer.name);
                setText("ticket-customer-email", customer.email);
                setText("ticket-customer-phone", customer.phone);
                setText("ticket-customer-org", customer.organization);
                setText("ticket-customer-address", customer.address);

                setText("ticket-subscriber-number", subscriber.subscriber_number);
                setText("ticket-subscriber-account", subscriber.account_number);
                setText("ticket-subscriber-status", subscriber.status);
                const plan = [subscriber.service_plan, subscriber.service_speed].filter(Boolean).join(" · ");
                setText("ticket-subscriber-plan", plan);
                setText("ticket-subscriber-address", subscriber.service_address);
            } catch (err) {
                // Ignore
            }
        }

        if (customerHidden) {
            customerHidden.addEventListener("input", loadDetails);
            customerHidden.addEventListener("change", loadDetails);
        }
        if (subscriberHidden) {
            subscriberHidden.addEventListener("input", loadDetails);
            subscriberHidden.addEventListener("change", loadDetails);
        }

        loadDetails();
    })();

    (function () {
        const input = document.getElementById("attachments");
        const output = document.getElementById("ticket-attachment-selected");
        if (!input || !output) return;
        const render = () => {
            const files = Array.from(input.files || []);
            if (!files.length) {
                output.textContent = "";
                return;
            }
            output.textContent = `Selected: ${files.map(f => f.name).join(", ")}`;
        };
        input.addEventListener("change", render);
        render();
    })();
</script>

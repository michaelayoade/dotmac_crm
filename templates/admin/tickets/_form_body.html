{% set prefill = prefill or {} %}
<div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
    <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
        <h2 class="font-semibold text-slate-900 dark:text-white">Ticket Information</h2>
    </div>
    <div class="p-6 space-y-6">
        {% if error %}
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/30 dark:text-red-400">
            {{ error }}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div class="sm:col-span-2">
                <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Title <span class="text-red-500">*</span></label>
                <input type="text" name="title" id="title" required maxlength="200"
                    value="{{ ticket.title if ticket else (prefill.title or '') }}"
                    placeholder="Brief description of the issue"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="description" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Description</label>
                <textarea name="description" id="description" rows="4"
                    placeholder="Detailed description of the issue..."
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">{{ ticket.description if ticket else '' }}</textarea>
            </div>

            <div>
                <label for="customer" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Customer</label>
                {% if ticket and ticket.metadata_ is mapping %}
                    {% set customer_value = ticket.metadata_.get("customer") or "" %}
                {% else %}
                    {% set customer_value = prefill.customer or "" %}
                {% endif %}
                <input type="text" name="customer" id="customer"
                    value="{{ customer_value }}"
                    placeholder="Customer name"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="attachments" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Attachments</label>
                <input type="file" name="attachments" id="attachments" multiple
                    class="mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">PNG, JPG, GIF, WEBP, or PDF up to 5MB each.</p>
            </div>

            <div>
                <label for="subscriber_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subscriber</label>
                {% if ticket and ticket.subscriber %}
                    {% if ticket.subscriber.person %}
                        {% set subscriber_label = ticket.subscriber.person.first_name ~ ' ' ~ ticket.subscriber.person.last_name %}
                    {% elif ticket.subscriber.organization %}
                        {% set subscriber_label = ticket.subscriber.organization.name %}
                    {% else %}
                        {% set subscriber_label = 'Subscriber' %}
                    {% endif %}
                    {% if ticket.subscriber.subscriber_number %}
                        {% set subscriber_label = subscriber_label ~ ' (' ~ ticket.subscriber.subscriber_number ~ ')' %}
                    {% endif %}
                {% else %}
                    {% set subscriber_label = prefill.subscriber_label or '' %}
                {% endif %}
                <div class="relative" data-typeahead-url="/api/v1/search/subscribers" data-typeahead-min="2" data-typeahead-limit="8">
                    <input type="text" name="subscriber_search" data-typeahead-input
                           value="{{ subscriber_label }}"
                           placeholder="Search subscribers..."
                           class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <input type="hidden" name="subscriber_id" data-typeahead-hidden value="{{ ticket.subscriber_id if ticket else (prefill.subscriber_id or '') }}">
                    <div data-typeahead-results></div>
                </div>
            </div>

            <div>
                <label for="assigned_to_person_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Technician</label>
                <select name="assigned_to_person_id" id="assigned_to_person_id"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">-- Unassigned --</option>
                    {% for tech in technicians %}
                    {% set tech_person = tech.person %}
                    {% if tech_person %}
                        {% set tech_label = tech_person.display_name or (tech_person.first_name ~ ' ' ~ tech_person.last_name) %}
                    {% else %}
                        {% set tech_label = 'Technician ' ~ tech.id|string|truncate(8, True, '') %}
                    {% endif %}
                    <option value="{{ tech.person_id }}" {% if ticket and ticket.assigned_to_person_id == tech.person_id %}selected{% endif %}>
                        {{ tech_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="priority" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Priority</label>
                <select name="priority" id="priority"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="low" {% if ticket and ticket.priority.value == 'low' %}selected{% endif %}>Low</option>
                    <option value="normal" {% if not ticket or ticket.priority.value == 'normal' %}selected{% endif %}>Normal</option>
                    <option value="high" {% if ticket and ticket.priority.value == 'high' %}selected{% endif %}>High</option>
                    <option value="urgent" {% if ticket and ticket.priority.value == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
            </div>

            <div>
                <label for="channel" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Channel</label>
                <select name="channel" id="channel"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="web" {% if (ticket and ticket.channel.value == 'web') or (not ticket and (prefill.channel or 'web') == 'web') %}selected{% endif %}>Web</option>
                    <option value="email" {% if (ticket and ticket.channel.value == 'email') or (not ticket and prefill.channel == 'email') %}selected{% endif %}>Email</option>
                    <option value="phone" {% if (ticket and ticket.channel.value == 'phone') or (not ticket and prefill.channel == 'phone') %}selected{% endif %}>Phone</option>
                    <option value="chat" {% if (ticket and ticket.channel.value == 'chat') or (not ticket and prefill.channel == 'chat') %}selected{% endif %}>Chat</option>
                    <option value="api" {% if (ticket and ticket.channel.value == 'api') or (not ticket and prefill.channel == 'api') %}selected{% endif %}>API</option>
                </select>
            </div>

            <div>
                <label for="status" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                <select name="status" id="status"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="new" {% if not ticket or ticket.status.value == 'new' %}selected{% endif %}>New</option>
                    <option value="open" {% if ticket and ticket.status.value == 'open' %}selected{% endif %}>Open</option>
                    <option value="pending" {% if ticket and ticket.status.value == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="on_hold" {% if ticket and ticket.status.value == 'on_hold' %}selected{% endif %}>On Hold</option>
                    <option value="resolved" {% if ticket and ticket.status.value == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if ticket and ticket.status.value == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>

            <div>
                <label for="due_at" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Due Date</label>
                <input type="datetime-local" name="due_at" id="due_at"
                    value="{{ ticket.due_at.strftime('%Y-%m-%dT%H:%M') if ticket and ticket.due_at else '' }}"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>

            <div class="sm:col-span-2">
                <label for="tags" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tags</label>
                <input type="text" name="tags" id="tags"
                    value="{{ ticket.tags | join(', ') if ticket and ticket.tags else '' }}"
                    placeholder="Comma-separated tags (e.g., billing, technical, urgent)"
                    class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Separate multiple tags with commas</p>
            </div>
        </div>
    </div>
    {% if not ticket and prefill.conversation_id %}
    <input type="hidden" name="conversation_id" value="{{ prefill.conversation_id }}">
    {% endif %}
</div>

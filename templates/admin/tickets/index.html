{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, action_button, status_filter_card, info_banner, filter_bar, search_input, filter_select, icon_plus, animation_styles %}

{% block title %}Support Tickets - Admin{% endblock %}

{% block content %}
{{ ambient_background("amber", "orange") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% set ticket_icon %}
    <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
    {% endset %}

    {% call page_header(
        title="Support Tickets",
        subtitle="Manage customer support requests and issues",
        icon=ticket_icon,
        color="amber",
        color2="orange"
    ) %}
        {{ action_button("New Ticket", "/admin/support/tickets/create", icon_plus(), "primary", "amber", "orange") }}
    {% endcall %}

    {# Subscriber Filter Banner #}
    {% if subscriber_display %}
    {% set banner_actions %}
    {% if subscriber_url %}
    <a href="{{ subscriber_url }}" class="inline-flex items-center gap-1 font-medium text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200 transition-colors">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
        View subscriber
    </a>
    {% endif %}
    <a href="/admin/support/tickets" class="inline-flex items-center gap-1 font-medium text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200 transition-colors">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        Clear filter
    </a>
    {% endset %}
    {{ info_banner(
        message='Showing tickets for <span class="font-semibold">' ~ subscriber_display ~ '</span>',
        icon='<svg class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>',
        color="blue",
        actions=banner_actions
    ) }}
    {% endif %}

    {# Status Filter Cards #}
    {% set base_url = '/admin/support/tickets' %}
    {% set sub_param = '&subscriber=' ~ subscriber if subscriber else '' %}
    {% set type_param = '&ticket_type=' ~ ticket_type|urlencode if ticket_type else '' %}
    {% set assigned_param = '&assigned=' ~ assigned if assigned else '' %}
    {% set pm_param = '&pm=' ~ pm if pm else '' %}
    {% set spc_param = '&spc=' ~ spc if spc else '' %}
    <div class="grid gap-3 sm:grid-cols-3 lg:grid-cols-6 animate-fade-in-up" style="animation-delay: 100ms;">
        {{ status_filter_card("New", stats.new, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>', base_url ~ '?status=new' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "blue", "indigo", status == 'new') }}
        {{ status_filter_card("Open", stats.open, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>', base_url ~ '?status=open' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "emerald", "green", status == 'open') }}
        {{ status_filter_card("Pending", stats.pending, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=pending' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "amber", "yellow", status == 'pending') }}
        {{ status_filter_card("On Hold", stats.on_hold, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=on_hold' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "orange", "red", status == 'on_hold') }}
        {{ status_filter_card("Resolved", stats.resolved, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=resolved' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "teal", "cyan", status == 'resolved') }}
        {{ status_filter_card("Closed", stats.closed, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>', base_url ~ '?status=closed' ~ type_param ~ sub_param ~ assigned_param ~ pm_param ~ spc_param, "slate", "slate", status == 'closed') }}
    </div>

    {# Filters #}
    {% call filter_bar() %}
    <div class="flex flex-col gap-4">
        <form id="tickets-filter-form" hx-get="/admin/support/tickets" hx-target="#tickets-table" hx-trigger="submit, change from:select" class="space-y-4">
            <div class="w-full">
                <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Search Tickets</label>
                {{ search_input("search", search or '', "Search by ticket ID, title, or description...", "amber", {"hx-get": "/admin/support/tickets", "hx-target": "#tickets-table", "hx-trigger": "keyup changed delay:300ms", "hx-include": "closest form"}) }}
            </div>
            {% if subscriber %}
            <input type="hidden" name="subscriber" value="{{ subscriber }}" />
            {% endif %}
            <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-6 xl:items-end">
                <div class="w-full">
                    {{ filter_select("status", [
                        {"value": "", "label": "All Status"},
                        {"value": "new", "label": "New"},
                        {"value": "open", "label": "Open"},
                        {"value": "pending", "label": "Pending"},
                        {"value": "waiting_on_customer", "label": "Waiting on Customer"},
                        {"value": "lastmile_rerun", "label": "Lastmile Rerun"},
                        {"value": "site_under_construction", "label": "Site Under Construction"},
                        {"value": "on_hold", "label": "On Hold"},
                        {"value": "resolved", "label": "Resolved"},
                        {"value": "closed", "label": "Closed"},
                        {"value": "canceled", "label": "Canceled"}
                    ], status or '', "Status", "amber") }}
                </div>
                <div class="w-full">
                    {% set type_filter_options = [{"value": "", "label": "All Ticket Types"}] %}
                    {% for item in ticket_type_options or [] %}
                        {% set _ = type_filter_options.append({"value": item, "label": item}) %}
                    {% endfor %}
                    {{ filter_select("ticket_type", type_filter_options, ticket_type or '', "Ticket Type", "amber") }}
                </div>
                <div class="w-full">
                    {{ filter_select("assigned", [
                        {"value": "", "label": "All Assignees"},
                        {"value": "me", "label": "Assigned to Me"}
                    ], assigned or '', "Assigned", "amber") }}
                </div>
                <div class="w-full">
                    {% set pm_filter_options = [{"value": "", "label": "All Project Managers"}, {"value": "me", "label": "Me"}] %}
                    {% for option in pm_options or [] %}
                        {% set _ = pm_filter_options.append(option) %}
                    {% endfor %}
                    {{ filter_select("pm", pm_filter_options, pm or '', "PM", "amber") }}
                </div>
                <div class="w-full">
                    {% set spc_filter_options = [{"value": "", "label": "All Site Coordinators"}, {"value": "me", "label": "Me"}] %}
                    {% for option in spc_options or [] %}
                        {% set _ = spc_filter_options.append(option) %}
                    {% endfor %}
                    {{ filter_select("spc", spc_filter_options, spc or '', "SPC", "amber") }}
                </div>
                <div class="flex items-end">
                    {% if status or ticket_type or assigned or pm or spc %}
                    {{ action_button("Clear Filters", "/admin/support/tickets" ~ ("?subscriber=" ~ subscriber if subscriber else ""), '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>', "secondary", "slate", None, "md", "link", {"data-clear-filters": "tickets"}) }}
                    {% endif %}
                </div>
            </div>
        </form>

        <div class="flex justify-end">
            <div id="tickets-column-picker" class="relative">
                <button type="button" id="tickets-column-picker-toggle" class="inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M6 12h12m-9 5h6"/>
                    </svg>
                    Table Fields
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="tickets-column-picker-panel" class="absolute right-0 z-50 mt-2 hidden w-64 rounded-xl border border-slate-200 bg-white p-3 shadow-xl dark:border-slate-700 dark:bg-slate-900">
                    <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Show Columns</p>
                    <div id="tickets-column-options" class="max-h-72 space-y-2 overflow-y-auto pr-1">
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="ticket" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked disabled>
                            <span>Ticket ID</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="type" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked>
                            <span>Ticket Type</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="priority" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked>
                            <span>Priority</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="status" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked>
                            <span>Status</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="customer" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked>
                            <span>Customer Name</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="customer_id" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Customer ID</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="subscriber" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Subscriber</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="region" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Region</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="assigned" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Assigned</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="project_manager" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Project Manager</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="site_coordinator" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Site Coordinator</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="channel" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Channel</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="due_at" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500">
                            <span>Due Date</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200">
                            <input type="checkbox" value="created" data-ticket-column-option class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-800 dark:checked:bg-amber-500" checked disabled>
                            <span>Opening Date</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endcall %}

    {# Tickets Table #}
    <div id="tickets-table" class="animate-fade-in-up" style="animation-delay: 200ms;">
        {% include "admin/tickets/_table.html" %}
    </div>
</div>

{{ animation_styles() }}
<script src="/static/js/ui-filter-state.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const userId = "{{ (current_user.get('person_id') if current_user and current_user.get('person_id') else 'anon') }}";
    const columnDefinitions = [
        { key: "ticket", defaultVisible: true },
        { key: "type", defaultVisible: true },
        { key: "priority", defaultVisible: true },
        { key: "status", defaultVisible: true },
        { key: "customer", defaultVisible: true },
        { key: "customer_id", defaultVisible: false },
        { key: "subscriber", defaultVisible: false },
        { key: "region", defaultVisible: false },
        { key: "assigned", defaultVisible: false },
        { key: "project_manager", defaultVisible: false },
        { key: "site_coordinator", defaultVisible: false },
        { key: "channel", defaultVisible: false },
        { key: "due_at", defaultVisible: false },
        { key: "created", defaultVisible: true }
    ];
    if (!window.DotmacUiFilterState || !window.DotmacUiFilterState.init) return;
    window.DotmacUiFilterState.init({
        formId: "tickets-filter-form",
        fields: ["status", "ticket_type", "assigned", "pm", "spc"],
        filterStorageKey: `admin:tickets:filters:${userId}`,
        restoreOnEmptyQuery: false,
        clearButtonSelector: '[data-clear-filters="tickets"]',
        columns: {
            optionSelector: "[data-ticket-column-option]",
            storageKey: `admin:tickets:columns:${userId}`,
            cellAttr: "data-ticket-column",
            validKeys: columnDefinitions.map((column) => column.key),
            defaultVisible: columnDefinitions
                .filter((column) => column.defaultVisible)
                .map((column) => column.key),
            requiredKeys: ["ticket", "created"],
            containerId: "tickets-column-picker",
            toggleButtonId: "tickets-column-picker-toggle",
            panelId: "tickets-column-picker-panel",
            afterSwapTargetId: "tickets-table",
        },
    });
});
</script>
{% endblock %}

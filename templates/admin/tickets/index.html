{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, action_button, status_filter_card, info_banner, filter_bar, search_input, filter_select, icon_plus, animation_styles %}

{% block title %}Support Tickets - Admin{% endblock %}

{% block content %}
{{ ambient_background("amber", "orange") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% set ticket_icon %}
    <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
    {% endset %}

    {% call page_header(
        title="Support Tickets",
        subtitle="Manage customer support requests and issues",
        icon=ticket_icon,
        color="amber",
        color2="orange"
    ) %}
        {{ action_button("New Ticket", "/admin/support/tickets/create", icon_plus(), "primary", "amber", "orange") }}
    {% endcall %}

    {# Subscriber Filter Banner #}
    {% if subscriber_display %}
    {% set banner_actions %}
    {% if subscriber_url %}
    <a href="{{ subscriber_url }}" class="inline-flex items-center gap-1 font-medium text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200 transition-colors">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
        View subscriber
    </a>
    {% endif %}
    <a href="/admin/support/tickets" class="inline-flex items-center gap-1 font-medium text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200 transition-colors">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        Clear filter
    </a>
    {% endset %}
    {{ info_banner(
        message='Showing tickets for <span class="font-semibold">' ~ subscriber_display ~ '</span>',
        icon='<svg class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>',
        color="blue",
        actions=banner_actions
    ) }}
    {% endif %}

    {# Status Filter Cards #}
    {% set base_url = '/admin/support/tickets' %}
    {% set sub_param = '&subscriber=' ~ subscriber if subscriber else '' %}
    <div class="grid gap-3 sm:grid-cols-3 lg:grid-cols-6 animate-fade-in-up" style="animation-delay: 100ms;">
        {{ status_filter_card("New", stats.new, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>', base_url ~ '?status=new' ~ sub_param, "blue", "indigo", status == 'new') }}
        {{ status_filter_card("Open", stats.open, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>', base_url ~ '?status=open' ~ sub_param, "emerald", "green", status == 'open') }}
        {{ status_filter_card("Pending", stats.pending, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=pending' ~ sub_param, "amber", "yellow", status == 'pending') }}
        {{ status_filter_card("On Hold", stats.on_hold, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=on_hold' ~ sub_param, "orange", "red", status == 'on_hold') }}
        {{ status_filter_card("Resolved", stats.resolved, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', base_url ~ '?status=resolved' ~ sub_param, "teal", "cyan", status == 'resolved') }}
        {{ status_filter_card("Closed", stats.closed, '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>', base_url ~ '?status=closed' ~ sub_param, "slate", "slate", status == 'closed') }}
    </div>

    {# Filters #}
    {% call filter_bar() %}
    <form hx-get="/admin/support/tickets" hx-target="#tickets-table" hx-trigger="submit, change from:select" class="flex flex-col gap-4 lg:flex-row lg:items-end">
        <div class="flex-1">
            <label class="mb-1.5 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Search Tickets</label>
            {{ search_input("search", search or '', "Search by ticket ID, title, or description...", "amber", {"hx-get": "/admin/support/tickets", "hx-target": "#tickets-table", "hx-trigger": "keyup changed delay:300ms", "hx-include": "closest form"}) }}
        </div>
        {% if subscriber %}
        <input type="hidden" name="subscriber" value="{{ subscriber }}" />
        {% endif %}
        <div class="w-full lg:w-44">
            {{ filter_select("priority", [
                {"value": "", "label": "All Priorities"},
                {"value": "urgent", "label": "Urgent"},
                {"value": "high", "label": "High"},
                {"value": "normal", "label": "Normal"},
                {"value": "low", "label": "Low"}
            ], priority or '', "Priority", "amber") }}
        </div>
        <div class="w-full lg:w-44">
            {{ filter_select("channel", [
                {"value": "", "label": "All Channels"},
                {"value": "web", "label": "Web Portal"},
                {"value": "email", "label": "Email"},
                {"value": "phone", "label": "Phone"},
                {"value": "chat", "label": "Live Chat"},
                {"value": "api", "label": "API"}
            ], channel or '', "Channel", "amber") }}
        </div>
        {% if status or priority or channel %}
        {{ action_button("Clear Filters", "/admin/support/tickets" ~ ("?subscriber=" ~ subscriber if subscriber else ""), '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>', "secondary", "slate") }}
        {% endif %}
    </form>
    {% endcall %}

    {# Tickets Table #}
    <div id="tickets-table" class="animate-fade-in-up" style="animation-delay: 200ms;">
        {% include "admin/tickets/_table.html" %}
    </div>
</div>

{{ animation_styles() }}
{% endblock %}

{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import page_header, status_badge, table_shell, empty_state, action_button %}

{% block title %}Permissions - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    {% call page_header("Permissions", total ~ " granular access permissions", color="purple", color2="pink", icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>', breadcrumbs=[{"href": "/admin/system", "label": "System"}, {"href": "/admin/system/roles", "label": "Roles"}, {"href": "", "label": "Permissions"}]) %}
        {{ action_button("Back to Roles", "/admin/system/roles", variant="secondary", color="violet") }}
        {{ action_button("New Permission", "/admin/system/permissions/new", color="purple", color2="pink", icon='<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>') }}
    {% endcall %}

    {# ── Search & Domain Filter ── #}
    <div class="animate-fade-in-up flex flex-col gap-3 sm:flex-row sm:items-center" style="animation-delay: 75ms">
        <div class="flex-1">
            <div class="relative">
                <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="permission_search" placeholder="Search permissions (e.g., tickets, projects, read)"
                       class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 py-2.5 pl-10 pr-4 text-sm transition-all focus:border-purple-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-purple-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
            </div>
        </div>
        <div class="flex items-center gap-2">
            <select id="domain_filter" class="rounded-xl border border-slate-200 bg-slate-50/50 px-3 py-2.5 text-sm transition-all focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white">
                <option value="">All Domains</option>
                {% set domains_seen = [] %}
                {% for permission in permissions | sort(attribute='key') %}
                    {% set domain = permission.key.split(':')[0] %}
                    {% if domain not in domains_seen %}
                        {% set _ = domains_seen.append(domain) %}
                        <option value="{{ domain }}">{{ domain | title }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>

    {# ── Permissions Table ── #}
    {% set pad = 'px-6 py-3' %}
    <div class="animate-fade-in-up" style="animation-delay: 150ms">
    {% call table_shell(table_id="permissions-table", title="Permissions", color="purple", count=permissions | length) %}
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700" id="permissions_table">
            <thead>
                <tr class="border-b border-slate-100 dark:border-slate-700/50">
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Domain</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Permission Key</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Description</th>
                    <th scope="col" class="{{ pad }} text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                    <th scope="col" class="{{ pad }} text-right"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="permissions_tbody">
                {% if permissions %}
                {% for permission in permissions | sort(attribute='key') %}
                {% set parts = permission.key.split(':') %}
                {% set domain = parts[0] if parts | length >= 1 else 'other' %}
                <tr class="permission-row hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"
                    data-key="{{ permission.key }}"
                    data-domain="{{ domain }}"
                    data-description="{{ permission.description or '' }}">
                    <td class="{{ pad }} whitespace-nowrap">
                        {% set domain_colors = {
                            'crm': 'bg-amber-500/10 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400',
                            'tickets': 'bg-blue-500/10 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400',
                            'projects': 'bg-teal-500/10 text-teal-700 dark:bg-teal-500/20 dark:text-teal-400',
                            'network': 'bg-cyan-500/10 text-cyan-700 dark:bg-cyan-500/20 dark:text-cyan-400',
                            'rbac': 'bg-violet-500/10 text-violet-700 dark:bg-violet-500/20 dark:text-violet-400',
                            'system': 'bg-indigo-500/10 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-400',
                            'inventory': 'bg-emerald-500/10 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400',
                            'dispatch': 'bg-orange-500/10 text-orange-700 dark:bg-orange-500/20 dark:text-orange-400',
                            'auth': 'bg-rose-500/10 text-rose-700 dark:bg-rose-500/20 dark:text-rose-400'
                        } %}
                        <span class="inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-semibold {{ domain_colors.get(domain, 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300') }}">{{ domain }}</span>
                    </td>
                    <td class="{{ pad }} whitespace-nowrap">
                        <code class="rounded-lg bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-800 dark:bg-slate-700 dark:text-slate-200">{{ permission.key }}</code>
                    </td>
                    <td class="{{ pad }} text-sm text-slate-500 dark:text-slate-400">{{ permission.description | default('—') }}</td>
                    <td class="{{ pad }} whitespace-nowrap">
                        {% if permission.is_active %}
                        {{ status_badge("Active", "active", size="sm") }}
                        {% else %}
                        {{ status_badge("Inactive", "inactive", size="sm") }}
                        {% endif %}
                    </td>
                    <td class="{{ pad }} whitespace-nowrap text-right">
                        <a href="/admin/system/permissions/{{ permission.id }}/edit" class="text-sm font-medium text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300 transition-colors">Edit</a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                {{ empty_state("No permissions found", "Create a permission to start defining access.", colspan=5) }}
                {% endif %}
            </tbody>
        </table>

        <div class="flex items-center justify-between border-t border-slate-200/60 px-6 py-3 dark:border-slate-700/60">
            <p class="text-sm text-slate-500 dark:text-slate-400">
                <span id="visible_count">{{ permissions | length }}</span> of {{ total }} permissions
            </p>
        </div>
    {% endcall %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
    const searchInput = document.getElementById("permission_search");
    const domainFilter = document.getElementById("domain_filter");
    const tbody = document.getElementById("permissions_tbody");
    const visibleCountEl = document.getElementById("visible_count");
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll(".permission-row"));

    const filterRows = () => {
        const query = (searchInput?.value || "").trim().toLowerCase();
        const domain = domainFilter?.value || "";
        let visibleCount = 0;

        rows.forEach(row => {
            const key = (row.dataset.key || "").toLowerCase();
            const rowDomain = row.dataset.domain || "";
            const description = (row.dataset.description || "").toLowerCase();

            const matchesSearch = !query || key.includes(query) || description.includes(query);
            const matchesDomain = !domain || rowDomain === domain;
            const visible = matchesSearch && matchesDomain;

            row.classList.toggle("hidden", !visible);
            if (visible) visibleCount++;
        });

        if (visibleCountEl) visibleCountEl.textContent = visibleCount;
    };

    searchInput?.addEventListener("input", filterRows);
    domainFilter?.addEventListener("change", filterRows);
})();
</script>
{% endblock %}

{% extends "layouts/admin.html" %}

{% from "components/ui/macros.html" import page_header, submit_button, action_button %}
{% block title %}Edit User - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    {% call page_header(
        title="Edit User",
        subtitle="Update account details, roles, and permissions",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>',
        color="indigo",
        color2="violet",
        breadcrumbs=[
            {"href": "/admin/system", "label": "System"},
            {"href": "/admin/system/users", "label": "Users"},
            {"href": "/admin/system/users/" ~ user.id, "label": user.display_name or (user.first_name ~ " " ~ user.last_name)},
            {"href": "", "label": "Edit"}
        ]
    ) %}
        {{ action_button("Back to User", "/admin/system/users/" ~ user.id, color="indigo") }}
    {% endcall %}

    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-200">
        {{ error }}
    </div>
    {% endif %}

    <div class="animate-fade-in-up overflow-hidden rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 75ms">
        <form method="post" action="/admin/system/users/{{ user.id }}/edit" class="space-y-6 p-6">
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">First Name</label>
                    <input type="text" name="first_name" required value="{{ user.first_name }}"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Last Name</label>
                    <input type="text" name="last_name" required value="{{ user.last_name }}"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Display Name</label>
                    <input type="text" name="display_name" value="{{ user.display_name or '' }}"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Email</label>
                    <input type="email" name="email" required value="{{ user.email }}"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Phone</label>
                    <input type="text" name="phone" value="{{ user.phone or '' }}"
                           class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Roles</label>
                    <div class="rounded-xl border border-slate-200/60 bg-slate-50/50 p-3 max-h-48 overflow-y-auto dark:border-slate-700/60 dark:bg-slate-700/50">
                        <div class="space-y-2">
                            {% for role in roles %}
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role_ids" value="{{ role.id }}"
                                       {% if role.id|string in current_role_ids %}checked{% endif %}
                                       class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 dark:border-slate-600 dark:bg-slate-700">
                                <span class="text-sm text-slate-700 dark:text-slate-300">{{ role.name }}</span>
                                {% if role.name == 'admin' %}
                                <span class="text-xs text-purple-600 dark:text-purple-400">(full access)</span>
                                {% endif %}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Select one or more roles</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" name="is_active" id="is_active"
                       {% if user.is_active %}checked{% endif %}
                       class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 dark:border-slate-600 dark:bg-slate-700">
                <label for="is_active" class="text-sm text-slate-700 dark:text-slate-300">Active</label>
            </div>

            {# -- Direct Permissions Section -- #}
            <div class="rounded-xl border border-slate-200/60 p-4 dark:border-slate-700/60" x-data="{ expanded: false, search: '' }">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Direct Permissions</h2>
                        <p class="text-xs text-slate-400 dark:text-slate-500">Grant specific permissions directly to this user (bypasses role-based access)</p>
                    </div>
                    <button type="button" @click="expanded = !expanded"
                            class="text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400">
                        <span x-show="!expanded">Show</span>
                        <span x-show="expanded">Hide</span>
                    </button>
                </div>
                <div x-show="expanded" x-transition class="mt-4">
                    <input type="text" x-model="search" placeholder="Search permissions..."
                           class="mb-3 block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                    <div class="max-h-64 overflow-y-auto space-y-1">
                        {% for permission in all_permissions %}
                        <label class="flex items-center gap-2 cursor-pointer py-1"
                               x-show="search === '' || '{{ permission.key }}'.toLowerCase().includes(search.toLowerCase())">
                            <input type="checkbox" name="direct_permission_ids" value="{{ permission.id }}"
                                   {% if permission.id|string in direct_permission_ids %}checked{% endif %}
                                   class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 dark:border-slate-600 dark:bg-slate-700">
                            <span class="text-sm font-mono text-slate-700 dark:text-slate-300">{{ permission.key }}</span>
                            {% if permission.description %}
                            <span class="text-xs text-slate-400">- {{ permission.description }}</span>
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% if can_update_password %}
            <div class="rounded-xl border border-slate-200/60 p-4 dark:border-slate-700/60">
                <h2 class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Password</h2>
                <div class="mt-4 grid gap-4 sm:grid-cols-2">
                    <div>
                        <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">New Password</label>
                        <input type="password" name="new_password"
                               class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Confirm Password</label>
                        <input type="password" name="confirm_password"
                               class="block w-full rounded-xl border border-slate-200 bg-slate-50/50 px-4 py-2.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white dark:focus:bg-slate-700">
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <input type="checkbox" name="require_password_change" id="require_password_change" checked
                           class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 dark:border-slate-600 dark:bg-slate-700">
                    <label for="require_password_change" class="text-sm text-slate-700 dark:text-slate-300">Require password change on next login</label>
                </div>
            </div>
            {% endif %}
            <div class="flex justify-end gap-3">
                <a href="/admin/system/users/{{ user.id }}"
                   class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition-all hover:border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:border-slate-500 dark:hover:bg-slate-700">
                    Cancel
                </a>
                {{ submit_button("Save Changes", color="indigo") }}
            </div>
        </form>
    </div>
</div>
{% endblock %}

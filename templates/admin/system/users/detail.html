{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import page_header, status_badge, submit_button, warning_button, action_button, danger_button %}

{% set user_name = user.display_name or (user.first_name ~ ' ' ~ user.last_name) %}

{% block title %}{{ user_name }} - Users - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    {# -- Page Header -- #}
    {% call page_header(
        user_name,
        user.email,
        color="indigo",
        color2="violet",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
        breadcrumbs=[
            {"href": "/admin/system", "label": "System"},
            {"href": "/admin/system/users", "label": "Users"},
            {"href": "", "label": user_name}
        ]
    ) %}
        {{ action_button("Edit", "/admin/system/users/" ~ user.id ~ "/edit", color="indigo") }}
    {% endcall %}

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        {# -- Main Content (2/3) -- #}
        <div class="lg:col-span-2 space-y-6">

            {# -- Profile Details Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 75ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Profile Details</h2>
                </div>
                <div class="p-6">
                    <div class="mb-6 flex items-center gap-4">
                        <div class="flex h-16 w-16 items-center justify-center rounded-full bg-indigo-100 text-2xl font-bold text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400">
                            {{ ((user.first_name or 'U')[0] ~ (user.last_name or 'U')[0]) | upper }}
                        </div>
                        <div>
                            <p class="text-lg font-semibold text-slate-900 dark:text-white">{{ user_name }}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">{{ user.email }}</p>
                        </div>
                    </div>
                    <dl class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">First Name</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.first_name or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Last Name</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.last_name or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Display Name</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.display_name or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Email</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.email or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Phone</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.phone or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</dt>
                            <dd class="mt-1">
                                {% if user.is_active %}
                                {{ status_badge("Active", "active", size="sm") }}
                                {% else %}
                                {{ status_badge("Inactive", "inactive", size="sm") }}
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>

            {# -- Roles & Permissions Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 150ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Roles & Permissions</h2>
                </div>
                <div class="p-6">
                    {% if roles %}
                    <div class="flex flex-wrap gap-2">
                        {% for role in roles %}
                        <span class="inline-flex items-center gap-1.5 rounded-lg bg-indigo-100 px-3 py-1 text-sm font-medium text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                            {{ role.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="flex items-center gap-3 rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-4 dark:border-slate-600 dark:bg-slate-700/30">
                        <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <p class="text-sm text-slate-500 dark:text-slate-400">No roles assigned.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# -- Login Credentials Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 225ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Login Credentials</h2>
                </div>
                <div class="p-6">
                    {% if credential %}
                    <dl class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Username</dt>
                            <dd class="mt-1 text-sm font-medium text-slate-900 dark:text-white">{{ credential.username }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Credential Status</dt>
                            <dd class="mt-1">
                                {% if credential.is_active %}
                                {{ status_badge("Active", "active", size="sm") }}
                                {% else %}
                                {{ status_badge("Disabled", "error", size="sm") }}
                                {% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Password Change Required</dt>
                            <dd class="mt-1">
                                {% if credential.must_change_password %}
                                {{ status_badge("Yes", "warning", size="sm") }}
                                {% else %}
                                {{ status_badge("No", "default", size="sm") }}
                                {% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Last Password Change</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">
                                {{ credential.password_updated_at.strftime('%b %d, %Y %H:%M') if credential.password_updated_at else 'Never' }}
                            </dd>
                        </div>
                    </dl>
                    {% else %}
                    <div class="flex items-center gap-3 rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-4 dark:border-slate-600 dark:bg-slate-700/30">
                        <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <p class="text-sm text-slate-500 dark:text-slate-400">No login credentials configured.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# -- Multi-Factor Authentication Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 300ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Multi-Factor Authentication</h2>
                </div>
                <div class="p-6">
                    {% if mfa_methods %}
                    <div class="space-y-3">
                        {% for mfa in mfa_methods %}
                        <div class="flex items-center justify-between rounded-xl border border-slate-200/60 p-4 transition-colors hover:bg-slate-50/50 dark:border-slate-700/60 dark:hover:bg-slate-700/30">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                                    <svg class="h-5 w-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-900 dark:text-white">{{ mfa.method_type.value | title }}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Added {{ mfa.created_at.strftime('%b %d, %Y') if mfa.created_at else 'Unknown' }}</p>
                                </div>
                            </div>
                            {% if mfa.enabled %}
                            {{ status_badge("Enabled", "active", size="sm") }}
                            {% else %}
                            {{ status_badge("Disabled", "inactive", size="sm") }}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="flex items-center gap-3 rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-4 dark:border-slate-600 dark:bg-slate-700/30">
                        <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        <p class="text-sm text-slate-500 dark:text-slate-400">No MFA methods configured.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# -- Sidebar (1/3) -- #}
        <div class="space-y-6">

            {# -- Quick Info Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 100ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Quick Info</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">User ID</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white font-mono">{{ user.id | string | truncate(20, True, '...') }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</p>
                        <div class="mt-1">
                            {% if user.is_active %}
                            {{ status_badge("Active", "active", size="sm") }}
                            {% else %}
                            {{ status_badge("Inactive", "inactive", size="sm") }}
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Roles</p>
                        <div class="mt-1 flex flex-wrap gap-1">
                            {% if roles %}
                                {% for role in roles %}
                                <span class="inline-flex items-center rounded-lg bg-indigo-100 px-2 py-0.5 text-xs font-medium text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400">{{ role.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-slate-400 dark:text-slate-500">None</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="border-t border-slate-200/60 pt-4 dark:border-slate-700/60">
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Created</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.created_at.strftime('%B %d, %Y') if user.created_at else '-' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Last Updated</p>
                        <p class="mt-1 text-sm text-slate-900 dark:text-white">{{ user.updated_at.strftime('%B %d, %Y %H:%M') if user.updated_at else '-' }}</p>
                    </div>
                </div>
            </div>

            {# -- Actions Card -- #}
            <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 175ms">
                <div class="flex items-center gap-3 border-b border-slate-200/60 px-6 py-4 dark:border-slate-700/60">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-indigo-500/10 to-violet-500/10 dark:from-indigo-500/20 dark:to-violet-500/20">
                        <svg class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <h2 class="font-semibold text-slate-900 dark:text-white">Actions</h2>
                </div>
                <div class="p-6 space-y-3">
                    <div class="w-full">
                        {{ warning_button("Reset Password", "Confirm Send", "Send password reset email to this user?", "/admin/system/users/" ~ user.id ~ "/reset-password", size="sm") }}
                    </div>

                    {% if credential and credential.must_change_password %}
                    <button type="button"
                            hx-post="/admin/system/users/{{ user.id }}/resend-invite"
                            hx-target="#resend-invite-result"
                            hx-swap="innerHTML"
                            class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-indigo-300 bg-indigo-50 px-3 py-1.5 text-xs font-medium text-indigo-700 transition-all hover:bg-indigo-100 hover:border-indigo-400 dark:border-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:bg-indigo-900/50">
                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        Resend Invitation
                    </button>
                    <div id="resend-invite-result" class="mt-2"></div>
                    {% endif %}

                    {% if mfa_methods %}
                    <div class="w-full">
                        {{ warning_button("Disable MFA", "Confirm Disable", "Disable all MFA methods for this user?", "/admin/system/users/" ~ user.id ~ "/disable-mfa", size="sm") }}
                    </div>
                    {% endif %}

                    <div class="border-t border-slate-200/60 pt-3 dark:border-slate-700/60">
                        {% if user.is_active %}
                        <div class="w-full">
                            {{ warning_button("Deactivate User", "Confirm Deactivate", "Deactivate this user? They will no longer be able to log in.", "/admin/system/users/" ~ user.id ~ "/deactivate", size="sm") }}
                        </div>
                        {% else %}
                        <div class="space-y-3">
                            <form method="POST" action="/admin/system/users/{{ user.id }}/activate" class="w-full">
                                {{ submit_button("Activate User", color="green", full_width=true) }}
                            </form>
                            <div class="w-full">
                                {{ danger_button("Delete User", "Confirm Delete", "Permanently delete this deactivated user? This action cannot be undone.", "/admin/system/users/" ~ user.id ~ "/delete", size="sm") }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
